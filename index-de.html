<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5Buchstaben - Wort-Ratespiel</title>
    <meta name="description" content="Fordere Freunde heraus, dein geheimes 5-Buchstaben-Wort zu erraten! Ein lustiges Wort-Ratespiel.">
    <meta property="og:title" content="5Buchstaben - Wort-Ratespiel">
    <meta property="og:description" content="Fordere Freunde heraus, dein geheimes 5-Buchstaben-Wort zu erraten!">
    <meta property="og:url" content="https://www.5letters.fun">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="5Buchstaben - Wort-Ratespiel">
    <meta name="twitter:description" content="Fordere Freunde heraus, dein geheimes 5-Buchstaben-Wort zu erraten!">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%238B5CF6'/%3E%3Ctext x='16' y='23' text-anchor='middle' font-family='Arial,sans-serif' font-weight='bold' font-size='16' fill='white'%3E5L%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%238B5CF6'/%3E%3Ctext x='16' y='23' text-anchor='middle' font-family='Arial,sans-serif' font-weight='bold' font-size='16' fill='white'%3E5L%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='30' fill='%238B5CF6'/%3E%3Ctext x='90' y='120' text-anchor='middle' font-family='Arial,sans-serif' font-weight='bold' font-size='90' fill='white'%3E5L%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-database-compat.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        .logo-font { font-family: 'Playfair Display', serif; }
        .banner-enter { animation: slideDown 0.3s ease-out; }
        .banner-exit { animation: slideUp 0.3s ease-in forwards; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(-100px) rotate(720deg); opacity: 0; } }
        .shake { animation: shake 0.4s ease-in-out; }
        .pop { animation: pop 0.2s ease-out; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .guess-row { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-800 min-h-screen">
    <div id="app"></div>
    <div id="banner"></div>
    <div id="confetti"></div>
    <script>
        // Sound effects using Web Audio API
        var audioCtx = null;
        function getAudioContext() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            return audioCtx;
        }
        
        function playSound(type) {
            if (!state.soundEnabled) return;
            try {
                var ctx = getAudioContext();
                var oscillator = ctx.createOscillator();
                var gainNode = ctx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                if (type === 'click') {
                    oscillator.frequency.value = 600;
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.1);
                } else if (type === 'success') {
                    oscillator.frequency.value = 523;
                    gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
                    oscillator.start(ctx.currentTime);
                    oscillator.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(784, ctx.currentTime + 0.2);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                    oscillator.stop(ctx.currentTime + 0.4);
                } else if (type === 'error') {
                    oscillator.frequency.value = 200;
                    oscillator.type = 'square';
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.2);
                } else if (type === 'win') {
                    var notes = [523, 659, 784, 1047];
                    notes.forEach(function(freq, i) {
                        var osc = ctx.createOscillator();
                        var gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.15, ctx.currentTime + i * 0.15);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.15 + 0.3);
                        osc.start(ctx.currentTime + i * 0.15);
                        osc.stop(ctx.currentTime + i * 0.15 + 0.3);
                    });
                } else if (type === 'lose') {
                    oscillator.frequency.value = 300;
                    oscillator.type = 'sawtooth';
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.5);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.5);
                } else if (type === 'match') {
                    oscillator.frequency.value = 440;
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    oscillator.frequency.setValueAtTime(550, ctx.currentTime + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.2);
                }
            } catch (e) { /* Audio not supported */ }
        }
        
        function haptic(type) {
            if (navigator.vibrate) {
                if (type === 'light') navigator.vibrate(10);
                else if (type === 'medium') navigator.vibrate(25);
                else if (type === 'heavy') navigator.vibrate(50);
                else if (type === 'error') navigator.vibrate([50, 50, 50]);
                else if (type === 'success') navigator.vibrate([30, 50, 30]);
            }
        }
        
        function showConfetti() {
            var container = document.getElementById('confetti');
            var colors = ['#8B5CF6', '#22C55E', '#F59E0B', '#EF4444', '#3B82F6'];
            for (var i = 0; i < 50; i++) {
                var confetti = document.createElement('div');
                confetti.style.cssText = 'position:fixed;width:10px;height:10px;background:' + colors[i % colors.length] + 
                    ';left:' + Math.random() * 100 + '%;top:50%;border-radius:2px;pointer-events:none;z-index:100;' +
                    'animation:confetti 1s ease-out forwards;animation-delay:' + (Math.random() * 0.5) + 's;';
                container.appendChild(confetti);
            }
            setTimeout(function() { container.innerHTML = ''; }, 2000);
        }

        var fbConfig = {
            apiKey: "AIzaSyA9SGAh5bXJyNNs7LD9Jd8kFkRW4JRv6gI",
            authDomain: "wordeu-742d5.firebaseapp.com",
            databaseURL: "https://wordeu-742d5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "wordeu-742d5",
            storageBucket: "wordeu-742d5.firebasestorage.app",
            messagingSenderId: "391013275080",
            appId: "1:391013275080:web:51d96cabffbc1527521cfd"
        };
        firebase.initializeApp(fbConfig);
        var database = firebase.database();

        var savedId = localStorage.getItem('visitorId');
        var newId = Math.random().toString(36).substr(2, 9);
        var visitorId = savedId ? savedId : newId;
        localStorage.setItem('visitorId', visitorId);

        var sessionPlayerId = sessionStorage.getItem('playerId');
        if (!sessionPlayerId) {
            sessionPlayerId = Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('playerId', sessionPlayerId);
        }

        function loadStats() {
            var stats = localStorage.getItem('wordoStatistik_' + visitorId);
            if (stats) return JSON.parse(stats);
            return { gamesPlayed: 0, gamesWon: 0, gamesLost: 0, currentStreak: 0, bestStreak: 0, totalGuesses: 0, quickestWin: null };
        }

        function saveStats(stats) {
            localStorage.setItem('wordoStatistik_' + visitorId, JSON.stringify(stats));
        }

        function loadPlayerName() {
            return localStorage.getItem('wordoPlayerName_' + visitorId) || '';
        }

        function savePlayerName(name) {
            localStorage.setItem('wordoPlayerName_' + visitorId, name);
        }

        function loadActiveGame() {
            var saved = localStorage.getItem('wordoActiveGame_' + visitorId);
            if (saved) return JSON.parse(saved);
            return null;
        }

        function saveActiveGame(gameId, playerId) {
            localStorage.setItem('wordoActiveGame_' + visitorId, JSON.stringify({ gameId: gameId, playerId: playerId }));
        }

        function clearActiveGame() {
            localStorage.removeItem('wordoActiveGame_' + visitorId);
        }

        function loadSoundEnabled() {
            var saved = localStorage.getItem('wordoSoundEnabled_' + visitorId);
            return saved === null ? true : saved === 'true';
        }

        function saveSoundEnabled(enabled) {
            localStorage.setItem('wordoSoundEnabled_' + visitorId, enabled.toString());
        }

        function loadGameHistory() {
            var saved = localStorage.getItem('wordoGameHistory_' + visitorId);
            if (saved) return JSON.parse(saved);
            return [];
        }

        function saveGameToHistory(gameData) {
            var history = loadGameHistory();
            history.unshift(gameData); // Add to beginning
            if (history.length > 10) history = history.slice(0, 10); // Keep last 10
            localStorage.setItem('wordoGameHistory_' + visitorId, JSON.stringify(history));
        }

        function isFirstTimeUser() { return !localStorage.getItem('wordoInstructionsSeen'); }
        function markInstructionsSeen() { localStorage.setItem('wordoInstructionsSeen', 'true'); }

        // Hints system - show tips for first few games
        function getGamesPlayed() {
            var stats = loadStats();
            return stats.gamesPlayed || 0;
        }
        function shouldShowHints() {
            return getGamesPlayed() < 3;
        }
        function getHintsDismissed() {
            var saved = localStorage.getItem('wordoHintsDismissed_' + visitorId);
            if (saved) return JSON.parse(saved);
            return {};
        }
        function dismissHint(hintId) {
            var dismissed = getHintsDismissed();
            dismissed[hintId] = true;
            localStorage.setItem('wordoHintsDismissed_' + visitorId, JSON.stringify(dismissed));
        }
        function isHintDismissed(hintId) {
            return getHintsDismissed()[hintId] === true;
        }

        // Analytics logging
        function logEvent(eventName, data) {
            try {
                database.ref('analytics/' + eventName).push({
                    timestamp: Date.now(),
                    visitorId: visitorId,
                    data: data || null
                });
            } catch (e) {
                console.log('Analytics error:', e);
            }
        }

        // Generate contextual hints HTML for new players
        function generateHintsHtml(context) {
            if (!shouldShowHints()) return '';
            var hints = [];
            
            // Context: 'start' - show at very start pointing to guess box
            if (context === 'start' && !isHintDismissed('start')) {
                hints.push({
                    id: 'start',
                    text: 'ðŸ‘‡ <strong>Hier starten!</strong> Gib ein 5-Buchstaben-Wort mit einzigartigen Buchstaben ein und tippe auf "Los" fÃ¼r deinen ersten Versuch.',
                    color: 'green'
                });
            }
            
            // Context: 'first_guess' - show after first guess is made
            if (context === 'first_guess' && !isHintDismissed('first_guess')) {
                hints.push({
                    id: 'first_guess',
                    text: 'ðŸ’¡ <strong>Die Zahl zeigt, wie viele DEINER Buchstaben im geheimen Wort vorkommen</strong> â€” aber nicht welche! Nutze Logik zum Eingrenzen.',
                    color: 'blue'
                });
            }
            
            // Context: 'alphabet' - show near alphabet section
            if (context === 'alphabet' && !isHintDismissed('alphabet')) {
                hints.push({
                    id: 'alphabet',
                    text: 'ðŸ’¡ <strong>Rot und grÃ¼n sind DEINE Notizen</strong> â€” klicke Buchstaben zum AusschlieÃŸen (rot), oder lang drÃ¼cken zum EinschlieÃŸen (grÃ¼n). Das Spiel zeigt nicht, welche Buchstaben Ã¼bereinstimmen!',
                    color: 'amber'
                });
            }
            
            // Context: 'goal' - show at start of game
            if (context === 'goal' && !isHintDismissed('goal')) {
                hints.push({
                    id: 'goal',
                    text: 'ðŸŽ¯ <strong>Ziel:</strong> Errate das geheime Wort in so wenigen Versuchen wie mÃ¶glich! Jeder Versuch zeigt dir, wie viele Buchstaben Ã¼bereinstimmen.',
                    color: 'purple'
                });
            }
            
            if (hints.length === 0) return '';
            
            var html = '';
            hints.forEach(function(hint) {
                var bgColor = hint.color === 'blue' ? 'bg-blue-50 border-blue-200 text-blue-800' :
                              hint.color === 'amber' ? 'bg-amber-50 border-amber-200 text-amber-800' :
                              hint.color === 'green' ? 'bg-green-50 border-green-200 text-green-800' :
                              'bg-purple-50 border-purple-200 text-purple-800';
                html += '<div class="' + bgColor + ' border rounded-lg p-3 mb-2 text-sm relative">' +
                    '<button onclick="dismissHint(\'' + hint.id + '\'); render()" class="absolute top-1 right-2 text-gray-400 hover:text-gray-600 text-lg leading-none">&times;</button>' +
                    '<div class="pr-6">' + hint.text + '</div></div>';
            });
            return html;
        }

        var state = {
            playerId: sessionPlayerId,
            visitorId: visitorId,
            playerName: loadPlayerName(),
            gameId: '',
            gameState: null,
            myWord: '',
            currentGuess: '',
            message: '',
            confirmedLetters: [],
            showJoinModal: false,
            showShareModal: false,
            showInstructions: isFirstTimeUser(),
            showStatistik: false,
            showHistory: false,
            showTeilenResult: false,
            showBeendenConfirm: false,
            circleExpanded: true,
            lastOpponentGuessCount: 0,
            stats: loadStats(),
            bannerTimeout: null,
            soundEnabled: loadSoundEnabled(),
            lastGameResult: null,
            // Single player mode
            singlePlayer: null  // { secretWord, Versuche[], letterStates{}, confirmedLetters[], gameOver, won }
        };
        
        var ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZÃ„Ã–Ãœ'.split('');

        // German word list for single player mode (common 5-letter words with unique letters)
        var WORD_LIST = [
            'ABEND','ADLER','AHORN','AKTIV','ALARM','ALBUM','ALPEN','AMPEL','ANGST','APFEL',
            'ARBEIT','ARTIG','AUTOS','BADEN','BÃ„KER','BALKON','BANDE','BANKS','BAUER','BAUMS',
            'BERGS','BESTE','BETON','BEUGT','BIEGT','BIEST','BILDET','BIRKE','BLASE','BLÃ„TTER',
            'BLECH','BLICK','BLIND','BLITZ','BLOND','BLÃœHT','BLUME','BODEN','BOHNE','BOJEN',
            'BOXEN','BRAND','BRAUT','BRIEF','BRISE','BRUST','BUCHT','BÃœHNE','BURG','BYTES',
            'CHAOS','CLAIM','CLOWN','COBRA','DAMPF','DANKE','DAUER','DECKT','DEICH','DENKT',
            'DICHT','DIEB','DIENST','DRAHT','DRANG','DRUCK','DUNKEL','DURCH','DURST','ECHTS',
            'EIFER','EIGEN','EILIG','EINST','EISEN','ELBOW','ENGEL','ENKEL','ERDIG','ERNST',
            'ETWAS','EULER','FACHS','FAHRT','FALKE','FALSCH','FARBE','FAUST','FEDER','FEIND',
            'FELDS','FELGE','FERNI','FEST','FEUCHT','FIGUR','FILMS','FINDET','FIRMA','FISCH',
            'FLACH','FLAMME','FLEISCH','FLIEGT','FLOHS','FLUCH','FLUID','FLUKE','FLUR','FOKUS',
            'FORMT','FOYER','FRAGT','FRANK','FRECH','FREMD','FREUD','FROST','FRUCHT','FUCHS',
            'FUNKT','GABEL','GALOP','GANZE','GÃ„STE','GAUNER','GEBÃ„CK','GEGEN','GEIST','GELB',
            'GENIE','GERÃ„T','GERUCH','GIBST','GILDE','GLANZ','GLAUB','GLEICH','GLÃœCK','GLÃœHT',
            'GNADE','GOTIK','GRABT','GREIS','GRENZ','GRIPPE','GROB','GROLL','GRUND','GRUFT',
            'GRÃœNE','GUNST','GURKE','HABER','HACKT','HAFEN','HAKEN','HALBS','HÃ„LT','HALTE',
            'HANDY','HANGT','HARFE','HASEN','HAUPT','HEBEL','HEBT','HECKE','HEILT','HEIMS',
            'HELDIN','HEMD','HERBST','HEUTE','HILFE','HIRN','HOBEL','HÃ–FLICH','HOHER','HOLZ',
            'HONIG','HORST','HOTEL','HUBER','HÃœGEL','HUMUS','HUNDE','HURTIG','JACKE','JÃ„GER',
            'JUBEL','JUGEN','JUMBO','JUNGE','JUPITER','KÃ„FER','KALBS','KÃ„LTE','KAMPF','KANAL',
            'KANTE','KARTE','KAUFT','KEGEL','KEHRT','KEIMS','KELLER','KERZE','KIEFER','KINDS',
            'KLANG','KLAPPE','KLASSE','KLAUT','KLEBT','KLEIN','KLIMA','KLOBEN','KLUGE','KNABE',
            'KNALL','KNAPP','KNECHT','KNEIFT','KNIET','KNOPF','KNOTEN','KOCHEN','KOHLE','KOMBI',
            'KÃ–NIG','KOPFS','KORB','KRAFT','KRAHN','KRAUT','KREBS','KREIS','KREUZ','KRIEG',
            'KRONE','KUCHEN','KUGEL','KUNDE','KUNST','KUPFER','KURVE','KÃœSTE','LACHE','LACHS',
            'LADEN','LAGER','LAMPE','LANDE','LANGE','LÃ„RMT','LASER','LAUBE','LAUFT','LAUNE',
            'LAUST','LEBT','LEDER','LEHRT','LEIBS','LEICHT','LEIDET','LEIHT','LEINE','LEISE',
            'LENKT','LETZT','LEUCHTE','LEUTE','LICHT','LIEBT','LIEDER','LIEFT','LIEGT','LIEST',
            'LINDE','LINKS','LIPPE','LITER','LOBEN','LOCHS','LOCKT','LOGIK','LOHNT','LÃ–SCH',
            'LÃ–SEN','LÃ–WIN','LUDER','LUFT','LÃœGEN','LUNCH','LUNGE','MACHT','MAGST','MAKEL',
            'MALER','MANCH','MARKE','MARKT','MASKE','MAUER','MEINT','MEIST','MELDS','MENGE',
            'MERKT','MESSER','MIETE','MILCH','MINZE','MISCHT','MOBIL','MODEL','MÃ–GEN','MONAT',
            'MÃ–NCH','MORGEN','MÃ–WE','MUCKE','MÃœDEN','MUHEN','MULDE','MUND','MÃœNZE','MUSIK',
            'NACHT','NADEL','NAGEL','NÃ„HER','NARBE','NATUR','NEBEL','NEHMT','NEIGT','NERVE',
            'NETZT','NICHT','NIMMT','NOBEL','NÃ–TIG','NOTIZ','NUDEL','NUTZE','OBEN','OBJEKT',
            'Ã–FFNE','OHREN','OKTAV','OLIVE','OPFER','ORDEN','ORGEL','ORTEN','OSTEN','OZEAN',
            'PAKET','PALME','PANDA','PANIK','PANZER','PASTE','PAUSE','PEDAL','PEGEL','PEILT',
            'PERLE','PFAND','PFEIL','PFERD','PFLEGT','PIANO','PILOT','PINSEL','PIZZA','PLAGE',
            'PLANET','PLANK','PLATZ','PLAUDERN','POLEN','POLKA','POREN','POTENZ','PRAHL','PREIS',
            'PRINZ','PROBE','PROFI','PSALM','PUDER','PULVER','PUMPE','PUNKT','QUALM','QUARK',
            'QUER','QUOTE','RABEN','RACHE','RADAR','RADELN','RAGEN','RAHMT','RAMPE','RANCH',
            'RANGE','RANKE','RASCH','RASEN','RASTE','RATEN','RAUBE','RAUCH','RAUM','RAUSCH',
            'REAGIERT','RECHT','REGAL','REGEN','REICH','REIFT','REIHE','REIHT','REIMS','REIST',
            'REITEN','REIZT','RENKT','RENTE','REUE','REVUE','RIECHT','RIEGE','RINGS','RISSE',
            'RITEN','RITZE','ROBEN','ROBOT','ROCHT','RODELN','ROHES','ROLLE','ROMAN','RÃ–SCHEN',
            'ROSTE','RÃ–TET','ROUTE','RUBEL','RÃœCKEN','RUDER','RUFEN','RUHIG','RUHM','RUMPF',
            'RUNDE','RUNZE','RUPFEN','SACHE','SACK','SÃ„GEN','SAGEN','SAHNE','SAITE','SALBE',
            'SALON','SALUT','SALVE','SAMEN','SANFT','SÃ„NGER','SATTEL','SAUCE','SAUGT','SAUM',
            'SÃ„URE','SCHADE','SCHAL','SCHARF','SCHAUM','SCHEIN','SCHENK','SCHICK','SCHILD',
            'SCHLAF','SCHLAG','SCHLAU','SCHLEIM','SCHLITZ','SCHLOSS','SCHLUCK','SCHLUG','SCHMIED',
            'SCHNEE','SCHNITT','SCHOCK','SCHON','SCHÃ–PF','SCHRECK','SCHREI','SCHRIFT','SCHULD',
            'SCHUSS','SCHUTZ','SCHWAB','SCHWAM','SCHWANG','SCHWARZ','SCHWEIF','SCHWEIN','SCHWER',
            'SCHWIMM','SCHWING','SCHWITZ','SCHWOR','SCHWUL','SECHS','SEGEL','SEGEN','SEHNT',
            'SEIDE','SEIFE','SEILT','SEITE','SEKTE','SELBT','SENKT','SETZT','SEUCHE','SICHER',
            'SIEBT','SIEGT','SIEHE','SIGNAL','SILBER','SINGE','SINKT','SITTE','SITZT','SKALA',
            'SKAPT','SKELETT','SKIZZE','SKULPTUR','SLANG','SOCKE','SOFORT','SOHLE','SOLCH','SONDE',
            'SORGE','SORGT','SOWEIT','SPALTE','SPANGE','SPANNT','SPART','SPÃ„T','SPECK','SPERRT',
            'SPIELT','SPINNE','SPION','SPITZE','SPLITT','SPORE','SPORT','SPRACH','SPRANG','SPRICHT',
            'SPRINGT','SPRIT','SPRUCH','SPRÃœHT','SPULE','SPULT','SPÃœRE','SPUR','STABIL','STACH',
            'STADT','STAHL','STAKE','STAMM','STAND','STANK','STAPEL','STARK','STARR','START',
            'STATT','STAUB','STEAK','STECKT','STEHT','STEIG','STEIN','STELL','STEMMT','STERN',
            'STETS','STICH','STIEFEL','STIER','STIFT','STILL','STIMME','STIRN','STOCK','STOFF',
            'STOLZ','STOPPT','STORCH','STÃ–RT','STOSS','STRAFE','STRAHL','STRAND','STRANG','STRAUSS',
            'STREBE','STRECK','STREIF','STREIT','STRENG','STRICH','STRICK','STROM','STRUCK','STUBE',
            'STUCK','STUFE','STUHL','STUMM','STUMPF','STUNDE','STURM','STÃœRZ','STÃœTZE','SUCHE',
            'SUCHT','SUMPF','SUPER','TAFEL','TAGEN','TALER','TALKE','TANNE','TANTE','TANZE',
            'TASCHE','TASTE','TAUCHT','TAUFE','TAUGT','TAUSCH','TAXEN','TEICH','TEIGT','TEILS',
            'TEMPO','TENOR','TEPPICH','TERMIN','TESTET','TEUER','TEUFEL','THEMA','THRON','TIERE',
            'TIGER','TINTE','TISCH','TITEL','TOAST','TOBTE','TOCHTER','TODTE','TOLLT','TONNE',
            'TOPF','TOSEN','TOTAL','TÃ–TEN','TOURT','TRACHT','TRAGEN','TRAGT','TRANK','TRAUB',
            'TRAUM','TRAUT','TREFFT','TREIBT','TREND','TREPP','TRETE','TREUE','TRICK','TRIEB',
            'TRIFT','TRIKOT','TRIMM','TRITT','TROCK','TROPF','TROST','TROTZ','TRÃœBE','TRUCK',
            'TRUHE','TRUMP','TRUNK','TRUPP','TSCHE','TÃœCKE','TUGEND','TULPE','TUMOR','TUNER',
            'TURBO','TURM','TYPUS','ÃœBEL','ÃœBEN','UFER','UHREN','UMBAU','UMHER','UMLAUF',
            'UMWEG','UNART','UNION','UNRAT','UNTEN','UNTER','URBAN','URLAUB','VALID','VAMPIR',
            'VATER','VENUS','VERB','VERNE','VERSO','VIERT','VILLA','VINYL','VIRUS','VITAL',
            'VOGEL','VOKAL','VOLKS','VOLTA','VORAN','VORHER','VORNE','VORTEIL','WABEN','WACHE',
            'WACHT','WADEN','WAFER','WAGEN','WAHLT','WÃ„HLT','WAHRE','WALD','WALKE','WÃ„LZT',
            'WÃ„NDE','WANDEL','WANGE','WANKT','WÃ„RME','WARNT','WARTE','WARUM','WASCH','WATEN',
            'WATTE','WEBER','WECKT','WEDEL','WEGES','WEHRT','WEICH','WEIDE','WEILT','WEINST',
            'WEISE','WEIST','WEITE','WEIZT','WELCH','WELKT','WELLT','WENIG','WERBE','WERFT',
            'WERKE','WERTET','WESEN','WESPE','WESTE','WETTE','WICKEL','WIDER','WIDME','WIEGT',
            'WIESE','WIEVIEL','WILD','WILLE','WIMPER','WINDE','WINKE','WINKT','WIPFEL','WIRBEL',
            'WIRBT','WIRFT','WIRKE','WIRST','WISCHE','WISST','WITWE','WITZE','WOCHE','WODKA',
            'WOHER','WOHIN','WOHLE','WOHNT','WOLBT','WOLFS','WOLKE','WOLLE','WOMIT','WORAN',
            'WORTE','WORUM','WOVON','WOZU','WRACKS','WRANG','WUCHS','WÃœHLT','WULST','WUNDE',
            'WUNSCH','WÃœRDE','WÃœRFE','WURMS','WURST','WÃœRZE','WÃœSTE','YACHT','ZACKE','ZÃ„HLT',
            'ZÃ„HMT','ZAHNE','ZANGE','ZANKT','ZAPFT','ZARTE','ZAUBER','ZAUNE','ZEBRA','ZECKE',
            'ZEHEN','ZEHNT','ZEIGT','ZEILE','ZELGE','ZELLE','ZELTE','ZENITH','ZENSOR','ZENTRAL',
            'ZERRT','ZETTEL','ZEUGE','ZIEGE','ZIEHT','ZIELS','ZIERT','ZIGARRE','ZIMMER','ZINKE',
            'ZINSE','ZIRKA','ZIRKEL','ZISCHT','ZITAT','ZITRONE','ZITTRE','ZIVIL','ZÃ–GERND','ZOGEN',
            'ZÃ–LIBAT','ZOMBIE','ZONEN','ZOPF','ZORNIG','ZUCHT','ZUCKT','ZUDEM','ZUFALL','ZÃœGEL',
            'ZUGEN','ZUGREIFT','ZUHAUSE','ZUHÃ–REN','ZUKUNFT','ZULAUF','ZULIEBE','ZUMAL','ZÃœNDE',
            'ZUNGE','ZURECHT','ZURÃœCK','ZUSAGE','ZUSTAND','ZUTEIL','ZUVOR','ZUWACHS','ZWANG','ZWAR',
            'ZWECK','ZWEIFEL','ZWEIG','ZWEIT','ZWERGE','ZWICKT','ZWIEBEL','ZWINGE','ZWINGT','ZWIRN',
            'ZWIST','ZWÃ–LF'
        ].filter(function(w) { return w.length === 5 && hasUniqueLetters(w); });

        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            saveSoundEnabled(state.soundEnabled);
            if (state.soundEnabled) playSound('click');
            render();
        }

        function hasUniqueLetters(word) {
            var letters = {};
            for (var i = 0; i < word.length; i++) {
                var char = word[i];
                // Check it's a German letter A-Z plus Ã„, Ã–, Ãœ
                if (!/^[A-ZÃ„Ã–Ãœ]$/.test(char)) return false;
                if (letters[char]) return false;
                letters[char] = true;
            }
            return true;
        }

        function sanitizeWord(word) {
            // Remove spaces and non-letter characters, uppercase, handle German umlauts
            return word.toUpperCase().replace(/[^A-ZÃ„Ã–Ãœ]/g, '');
        }

        function checkWord(word) {
            // Use German Wiktionary API for validation
            return fetch('https://de.wiktionary.org/w/api.php?action=query&titles=' + encodeURIComponent(word.toLowerCase()) + '&format=json&origin=*')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    // Check if page exists (not a missing page)
                    var pages = data.query.pages;
                    var pageId = Object.keys(pages)[0];
                    return pageId !== '-1';
                })
                .catch(function() { return true; }); // Allow word if API fails
        }

        function shareGame(url) {
            var text = 'Spiel mit mir 5Buchstaben! ' + url;
            if (navigator.share) {
                navigator.share({ text: text })
                .then(function() { state.showShareModal = false; render(); })
                .catch(function(err) { 
                    // If share fails or cancelled, fall back to clipboard
                    copyToClipboard(url);
                });
            } else {
                copyToClipboard(url);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                state.message = 'Link copied to clipboard!';
                state.showShareModal = false;
                render();
            }).catch(function() {
                prompt('Copy this link to share:', text);
                state.showShareModal = false;
                render();
            });
        }

        function checkUrlForGame() {
            var urlParams = new URLSearchParams(window.location.search);
            var gameCode = urlParams.get('game');
            if (gameCode) {
                state.gameId = gameCode.toUpperCase();
                state.message = 'Enter your name to join game ' + state.gameId;
            }
        }
        checkUrlForGame();

        function tryRejoinActiveGame() {
            var activeGame = loadActiveGame();
            if (activeGame && !state.gameId) {
                // Check if the game still exists and is not finished
                database.ref('games/' + activeGame.gameId).once('value').then(function(snapshot) {
                    if (snapshot.exists()) {
                        var game = snapshot.val();
                        var myPlayer = game.players[activeGame.playerId];
                        // Only rejoin if game exists, we're in it, and it's not over
                        if (myPlayer && !game.gameOver) {
                            state.gameId = activeGame.gameId;
                            state.playerId = activeGame.playerId;
                            sessionStorage.setItem('playerId', activeGame.playerId);
                            state.lastOpponentGuessCount = 0;
                            listenToGame(activeGame.gameId);
                            window.history.pushState({}, '', '?game=' + activeGame.gameId);
                        } else {
                            clearActiveGame();
                        }
                    } else {
                        clearActiveGame();
                    }
                });
            }
        }
        tryRejoinActiveGame();

        function showOpponentGuessBanner(guess, matchCount, opponentName, myWord) {
            var bannerEl = document.getElementById('banner');
            var matchingLetters = [];
            for (var i = 0; i < guess.length; i++) {
                if (myWord.indexOf(guess[i]) !== -1) matchingLetters.push(guess[i]);
            }
            var matchingLettersHtml = matchingLetters.length > 0 
                ? matchingLetters.map(function(l) { return '<span class="inline-block w-8 h-8 bg-white text-orange-600 rounded text-center leading-8 font-bold mx-1">' + l + '</span>'; }).join('')
                : '<span class="text-orange-200">Keine</span>';
            
            bannerEl.innerHTML = '<div onclick="dismissBanner()" class="fixed top-0 left-0 right-0 bg-gradient-to-r from-orange-500 to-red-500 text-white p-4 shadow-lg z-50 banner-enter cursor-pointer">' +
                '<div class="max-w-2xl mx-auto text-center">' +
                '<p class="font-bold text-lg mb-2">' + opponentName + ' hat geraten: <span class="tracking-widest bg-white/20 px-2 py-1 rounded">' + guess + '</span></p>' +
                '<p class="text-sm mb-2">Buchstaben in deinem Wort: ' + matchingLettersHtml + ' (' + matchCount + ' Treffer)</p>' +
                '<p class="font-semibold text-yellow-200">âš¡ Du bist dran!</p>' +
                '<p class="text-xs mt-2 text-orange-200">Tippen zum SchlieÃŸen</p>' +
                '</div></div>';
            
            state.bannerTimeout = setTimeout(function() {
                dismissBanner();
            }, 5000);
        }

        function dismissBanner() {
            if (state.bannerTimeout) {
                clearTimeout(state.bannerTimeout);
                state.bannerTimeout = null;
            }
            var bannerEl = document.getElementById('banner');
            var banner = bannerEl.querySelector('div');
            if (banner) {
                banner.classList.remove('banner-enter');
                banner.classList.add('banner-exit');
                setTimeout(function() { bannerEl.innerHTML = ''; }, 300);
            }
        }

        function updateStats(won, guessCount) {
            state.stats.gamesPlayed++;
            if (won) {
                state.stats.gamesWon++;
                state.stats.currentStreak++;
                if (state.stats.currentStreak > state.stats.bestStreak) state.stats.bestStreak = state.stats.currentStreak;
                state.stats.totalGuesses += guessCount;
                if (!state.stats.quickestWin || guessCount < state.stats.quickestWin) state.stats.quickestWin = guessCount;
            } else {
                state.stats.gamesLost++;
                state.stats.currentStreak = 0;
            }
            saveStats(state.stats);
        }

        function createGame() {
            if (!state.playerName.trim()) { state.message = 'Bitte gib deinen Namen ein'; render(); return; }
            savePlayerName(state.playerName);
            var gameId = Math.random().toString(36).substr(2, 6).toUpperCase();
            var gameData = { players: {}, currentTurn: null, started: false, createdAt: Date.now(), gameOver: false };
            gameData.players[state.playerId] = {
                name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
            };
            database.ref('games/' + gameId).set(gameData).then(function() {
                state.gameId = gameId;
                state.showShareModal = true;
                state.message = '';
                state.lastOpponentGuessCount = 0;
                saveActiveGame(gameId, state.playerId);
                listenToGame(gameId);
                window.history.pushState({}, '', '?game=' + gameId);
                logEvent('game_created', { mode: 'multiplayer' });
                render();
            }).catch(function(error) { state.message = 'Error creating game: ' + error.message; render(); });
        }

        function joinGame() {
            if (!state.playerName.trim()) { state.message = 'Bitte gib deinen Namen ein'; render(); return; }
            savePlayerName(state.playerName);
            state.gameId = state.gameId.toUpperCase();
            var gameId = state.gameId;
            database.ref('games/' + gameId).once('value').then(function(snapshot) {
                if (!snapshot.exists()) { state.message = 'Spiel nicht gefunden'; render(); return; }
                var game = snapshot.val();
                if (game.players[state.playerId]) {
                    state.message = 'Spiel wieder beigetreten';
                    state.lastOpponentGuessCount = 0;
                    saveActiveGame(gameId, state.playerId);
                    listenToGame(gameId);
                    render();
                    return;
                }
                if (Object.keys(game.players).length >= 2) { state.message = 'Spiel ist voll'; render(); return; }
                database.ref('games/' + gameId + '/players/' + state.playerId).set({
                    name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                    guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
                }).then(function() {
                    state.message = 'Beigetreten! WÃ¤hle dein geheimes Wort.';
                    state.lastOpponentGuessCount = 0;
                    saveActiveGame(gameId, state.playerId);
                    listenToGame(gameId);
                    logEvent('game_joined', { mode: 'multiplayer' });
                    render();
                }).catch(function(error) { state.message = 'Error joining game: ' + error.message; render(); });
            }).catch(function(error) { state.message = 'Error finding game: ' + error.message; render(); });
        }

        function listenToGame(gameId) {
            database.ref('games/' + gameId).on('value', function(snapshot) {
                if (snapshot.exists()) {
                    state.gameState = snapshot.val();
                    var myPlayer = state.gameState.players[state.playerId];
                    if (myPlayer) state.confirmedLetters = myPlayer.confirmedLetters || [];
                    
                    var opponentId = Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; });
                    if (opponentId && state.gameState.players[opponentId]) {
                        var opponent = state.gameState.players[opponentId];
                        var opponentGuesses = opponent.Versuche || [];
                        if (opponentGuesses.length > state.lastOpponentGuessCount && state.lastOpponentGuessCount > 0) {
                            var latestGuess = opponentGuesses[opponentGuesses.length - 1];
                            if (myPlayer && myPlayer.word) showOpponentGuessBanner(latestGuess.word, latestGuess.matches, opponent.name, myPlayer.word);
                        }
                        state.lastOpponentGuessCount = opponentGuesses.length;
                    }
                    
                    if (myPlayer && !myPlayer.statsRecorded) {
                        var opponent = opponentId ? state.gameState.players[opponentId] : null;
                        if (myPlayer.won) {
                            updateStats(true, myPlayer.Versuche.length);
                            var gameRecord = {
                                date: Date.now(),
                                opponent: opponent ? opponent.name : 'Unknown',
                                won: true,
                                Versuche: myPlayer.Versuche.length,
                                myWord: myPlayer.word,
                                theirWord: opponent ? opponent.word : '',
                                guessData: myPlayer.Versuche.slice(-3)
                            };
                            saveGameToHistory(gameRecord);
                            state.lastGameResult = gameRecord;
                            logEvent('game_completed', { mode: 'multiplayer', won: true, Versuche: myPlayer.Versuche.length });
                            database.ref('games/' + gameId + '/players/' + state.playerId + '/statsRecorded').set(true);
                        } else if (opponentId && state.gameState.players[opponentId].won) {
                            updateStats(false, 0);
                            var gameRecord = {
                                date: Date.now(),
                                opponent: opponent ? opponent.name : 'Unknown',
                                won: false,
                                Versuche: myPlayer.Versuche ? myPlayer.Versuche.length : 0,
                                myWord: myPlayer.word,
                                theirWord: opponent ? opponent.word : '',
                                guessData: myPlayer.Versuche ? myPlayer.Versuche.slice(-3) : []
                            };
                            saveGameToHistory(gameRecord);
                            state.lastGameResult = gameRecord;
                            logEvent('game_completed', { mode: 'multiplayer', won: false, Versuche: myPlayer.Versuche ? myPlayer.Versuche.length : 0 });
                            playSound('lose'); haptic('heavy');
                            database.ref('games/' + gameId + '/players/' + state.playerId + '/statsRecorded').set(true);
                        }
                    }
                    render();
                }
            });
        }

        function setSecretWord() {
            var word = sanitizeWord(state.myWord);
            if (word.length !== 5) { state.message = 'Wort muss genau 5 Buchstaben haben'; playSound('error'); haptic('error'); render(); return; }
            if (!hasUniqueLetters(word)) { state.message = 'Alle Buchstaben mÃ¼ssen einzigartig sein'; playSound('error'); haptic('error'); render(); return; }
            state.message = '';
            checkWord(word).then(function(isValid) {
                if (!isValid) { state.message = 'Kein gÃ¼ltiges deutsches Wort'; playSound('error'); haptic('error'); render(); return; }
                playSound('success'); haptic('success');
                database.ref('games/' + state.gameId + '/players/' + state.playerId).update({ word: word, wordSet: true }).then(function() {
                    database.ref('games/' + state.gameId).once('value').then(function(snapshot) {
                        var game = snapshot.val();
                        var playerCount = Object.keys(game.players).length;
                        var allWordsSet = Object.values(game.players).every(function(p) { return p.wordSet; });
                        if (playerCount === 2 && allWordsSet && !game.started) {
                            var firstPlayer = Object.keys(game.players)[0];
                            database.ref('games/' + state.gameId).update({ started: true, currentTurn: firstPlayer });
                        }
                    });
                    state.myWord = '';
                    state.message = 'Wort gesetzt! Warte auf Spielstart...';
                    render();
                }).catch(function(error) { state.message = 'Error setting word: ' + error.message; render(); });
            });
        }

        function makeGuess() {
            var guess = sanitizeWord(state.currentGuess);
            if (guess.length !== 5) { state.message = 'Versuch muss genau 5 Buchstaben haben'; playSound('error'); haptic('error'); render(); return; }
            if (!hasUniqueLetters(guess)) { state.message = 'Alle Buchstaben mÃ¼ssen einzigartig sein'; playSound('error'); haptic('error'); render(); return; }
            state.message = '';
            checkWord(guess).then(function(isValid) {
                if (!isValid) { state.message = 'Kein gÃ¼ltiges deutsches Wort'; playSound('error'); haptic('error'); render(); return; }
                var opponentId = Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; });
                if (!opponentId || !state.gameState.players[opponentId].wordSet) { state.message = 'Warte auf Gegner...render(); return; }
                var opponentWord = state.gameState.players[opponentId].word;
                var matchCount = 0;
                for (var i = 0; i < guess.length; i++) { if (opponentWord.indexOf(guess[i]) !== -1) matchCount++; }
                var isWin = guess === opponentWord;
                var newGuess = { word: guess, matches: matchCount, timestamp: Date.now() };
                var myGuesses = state.gameState.players[state.playerId].Versuche || [];
                myGuesses.push(newGuess);
                var updates = {};
                updates['games/' + state.gameId + '/players/' + state.playerId + '/Versuche'] = myGuesses;
                if (isWin) {
                    updates['games/' + state.gameId + '/players/' + state.playerId + '/won'] = true;
                    updates['games/' + state.gameId + '/gameOver'] = true;
                    state.message = 'ðŸŽ‰ Du hast gewonnen!';
                    playSound('win'); haptic('success'); showConfetti();
                } else {
                    updates['games/' + state.gameId + '/currentTurn'] = opponentId;
                    if (matchCount > 0) { playSound('match'); haptic('medium'); }
                    else { playSound('click'); haptic('light'); }
                }
                database.ref().update(updates).catch(function(error) { state.message = 'Error: ' + error.message; render(); });
                state.currentGuess = '';
                render();
            });
        }

        function startRevanche() {
            // Get current game info for rematch
            var currentGameId = state.gameId;
            var opponentId = state.gameState ? Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; }) : null;
            var opponentName = opponentId && state.gameState.players[opponentId] ? state.gameState.players[opponentId].name : null;
            
            // Check if there's already a rematch game created by opponent
            if (state.gameState && state.gameState.rematchGameId) {
                // Join the existing rematch game
                var rematchId = state.gameState.rematchGameId;
                database.ref('games/' + state.gameId).off('value');
                clearActiveGame();
                state.gameState = null;
                state.myWord = '';
                state.currentGuess = '';
                state.message = '';
                state.confirmedLetters = [];
                state.lastOpponentGuessCount = 0;
                state.lastGameResult = null;
                state.gameId = rematchId;
                
                // Join the rematch game
                database.ref('games/' + rematchId).once('value').then(function(snapshot) {
                    if (snapshot.exists()) {
                        var game = snapshot.val();
                        if (!game.players[state.playerId]) {
                            // Add ourselves to the rematch game
                            database.ref('games/' + rematchId + '/players/' + state.playerId).set({
                                name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                                guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
                            }).then(function() {
                                saveActiveGame(rematchId, state.playerId);
                                listenToGame(rematchId);
                                window.history.pushState({}, '', '?game=' + rematchId);
                            });
                        } else {
                            // Already in game, just listen
                            saveActiveGame(rematchId, state.playerId);
                            listenToGame(rematchId);
                            window.history.pushState({}, '', '?game=' + rematchId);
                        }
                    }
                });
                return;
            }
            
            // Create new rematch game and store ID in old game
            var newGameId = Math.random().toString(36).substr(2, 6).toUpperCase();
            var gameData = { 
                players: {}, 
                currentTurn: null, 
                started: false, 
                createdAt: Date.now(), 
                gameOver: false,
                isRevanche: true,
                previousGameId: currentGameId
            };
            gameData.players[state.playerId] = {
                name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
            };
            
            // Create new game and update old game with rematch ID
            database.ref('games/' + newGameId).set(gameData).then(function() {
                // Store rematch game ID in old game so opponent can find it
                database.ref('games/' + currentGameId + '/rematchGameId').set(newGameId);
                
                database.ref('games/' + currentGameId).off('value');
                clearActiveGame();
                state.gameState = null;
                state.myWord = '';
                state.currentGuess = '';
                state.confirmedLetters = [];
                state.lastOpponentGuessCount = 0;
                state.lastGameResult = null;
                state.gameId = newGameId;
                state.message = opponentName ? 'Revanche created! Warte auf ' + opponentName + '...' : '';
                saveActiveGame(newGameId, state.playerId);
                listenToGame(newGameId);
                window.history.pushState({}, '', '?game=' + newGameId);
                render();
            });
        }

        function cancelGame() {
            if (state.gameState) {
                database.ref('games/' + state.gameId).off('value');
            }
            clearActiveGame();
            state.gameState = null;
            state.myWord = '';
            state.currentGuess = '';
            state.message = '';
            state.confirmedLetters = [];
            state.lastOpponentGuessCount = 0;
            state.gameId = '';
            state.singlePlayer = null;
            state.showBeendenConfirm = false;
            window.history.pushState({}, '', window.location.pathname);
            render();
        }

        function confirmBeenden() {
            state.showBeendenConfirm = true;
            render();
        }

        function startSinglePlayer() {
            // Pick a random word from the list
            var randomWord = WORD_LIST[Math.floor(Math.random() * WORD_LIST.length)];
            state.singlePlayer = {
                secretWord: randomWord,
                guesses: [],
                letterStates: {},
                confirmedLetters: [],
                gameOver: false,
                won: false
            };
            state.currentGuess = '';
            state.message = '';
            logEvent('game_started', { mode: 'solo' });
            render();
        }

        function makeSinglePlayerGuess() {
            var guess = sanitizeWord(state.currentGuess);
            if (guess.length !== 5) { state.message = 'Versuch muss genau 5 Buchstaben haben'; playSound('error'); haptic('error'); render(); return; }
            if (!hasUniqueLetters(guess)) { state.message = 'Alle Buchstaben mÃ¼ssen einzigartig sein'; playSound('error'); haptic('error'); render(); return; }
            state.message = '';
            checkWord(guess).then(function(isValid) {
                if (!isValid) { state.message = 'Kein gÃ¼ltiges deutsches Wort'; playSound('error'); haptic('error'); render(); return; }
                
                var secretWord = state.singlePlayer.secretWord;
                var matchCount = 0;
                for (var i = 0; i < guess.length; i++) { 
                    if (secretWord.indexOf(guess[i]) !== -1) matchCount++; 
                }
                var isWin = guess === secretWord;
                
                state.singlePlayer.Versuche.push({ word: guess, matches: matchCount, timestamp: Date.now() });
                state.currentGuess = '';
                
                if (isWin) {
                    state.singlePlayer.gameOver = true;
                    state.singlePlayer.won = true;
                    playSound('win'); haptic('success'); showConfetti();
                    // Save to history
                    var gameRecord = {
                        date: Date.now(),
                        opponent: 'Computer',
                        won: true,
                        Versuche: state.singlePlayer.Versuche.length,
                        myWord: '-',
                        theirWord: secretWord,
                        guessData: state.singlePlayer.Versuche.slice(-3) // Last 3 Versuche for sharing
                    };
                    saveGameToHistory(gameRecord);
                    updateStats(true, state.singlePlayer.Versuche.length);
                    state.lastGameResult = gameRecord;
                    logEvent('game_completed', { mode: 'solo', won: true, Versuche: state.singlePlayer.Versuche.length });
                } else {
                    if (matchCount > 0) { playSound('match'); haptic('medium'); }
                    else { playSound('click'); haptic('light'); }
                }
                render();
            });
        }

        function toggleSinglePlayerLetter(letter, longPress) {
            var sp = state.singlePlayer;
            var currentState = sp.letterStates[letter];
            
            if (longPress) {
                if (currentState !== 'included' && sp.confirmedLetters.length >= 5) { 
                    state.message = 'Maximal 5 Buchstaben'; haptic('error'); render(); return; 
                }
                var newState = currentState === 'included' ? null : 'included';
                sp.letterStates[letter] = newState;
                if (newState === 'included' && sp.confirmedLetters.indexOf(letter) === -1) {
                    sp.confirmedLetters.push(letter);
                } else if (newState === null) {
                    var idx = sp.confirmedLetters.indexOf(letter);
                    if (idx > -1) sp.confirmedLetters.splice(idx, 1);
                }
                haptic('medium');
            } else {
                if (currentState === 'included') {
                    sp.letterStates[letter] = null;
                    var idx = sp.confirmedLetters.indexOf(letter);
                    if (idx > -1) sp.confirmedLetters.splice(idx, 1);
                } else {
                    sp.letterStates[letter] = currentState === 'excluded' ? null : 'excluded';
                }
                haptic('light');
            }
            render();
        }

        function giveUpSinglePlayer() {
            state.singlePlayer.gameOver = true;
            state.singlePlayer.won = false;
            playSound('lose'); haptic('heavy');
            // Save to history
            var gameRecord = {
                date: Date.now(),
                opponent: 'Computer',
                won: false,
                Versuche: state.singlePlayer.Versuche.length,
                myWord: '-',
                theirWord: state.singlePlayer.secretWord,
                guessData: state.singlePlayer.Versuche.slice(-3)
            };
            saveGameToHistory(gameRecord);
            updateStats(false, 0);
            state.lastGameResult = gameRecord;
            logEvent('game_completed', { mode: 'solo', won: false, Versuche: state.singlePlayer.Versuche.length, gaveUp: true });
            render();
        }

        function shareResult() {
            if (!state.lastGameResult) return;
            var result = state.lastGameResult;
            
            // Build grid with letters for last 3 Versuche (red/green like in-game alphabet)
            // Reverse order so most recent is at top
            var guessGrid = '';
            if (result.guessData && result.guessData.length > 0) {
                var secretWord = result.theirWord;
                var Versuche = result.guessData.slice().reverse(); // Copy and reverse
                Versuche.forEach(function(guess, idx) {
                    var isWinningGuess = (idx === 0) && result.won; // First in reversed = most recent
                    var line = '';
                    for (var i = 0; i < guess.word.length; i++) {
                        var letter = guess.word[i];
                        if (isWinningGuess) {
                            // Winning guess - all green
                            line += 'ðŸŸ©';
                        } else if (secretWord.indexOf(letter) !== -1) {
                            // Letter is in the word - green
                            line += 'ðŸŸ©';
                        } else {
                            // Letter not in word - red
                            line += 'ðŸŸ¥';
                        }
                    }
                    guessGrid += guess.word + ' ' + line + ' ' + guess.matches + '\n';
                });
            }
            
            var opponentText = result.opponent === 'Computer' ? '' : ' gegen ' + result.opponent;
            var header = result.won 
                ? 'ðŸŽ‰ Ich habe bei 5Buchstaben in ' + result.guesses + ' Versuchen gewonnen' + opponentText + '!'
                : 'ðŸ˜… Ich habe bei 5Buchstaben nach ' + result.guesses + ' Versuchen verloren' + opponentText;
            
            var text = header + '\n\n' + guessGrid + '\nhttps://5letters.fun/de';
            
            if (navigator.share) {
                // On mobile, use share API with just text (URL in text already)
                navigator.share({ text: text })
                    .catch(function(e) { console.log('Teilen cancelled'); });
            } else {
                // On desktop, copy to clipboard
                navigator.clipboard.writeText(text).then(function() {
                    state.message = 'Ergebnis in Zwischenablage kopiert!';
                    render();
                }).catch(function() {
                    prompt('Kopiere dies zum Teilen:', text);
                });
            }
        }

        function toggleLetterState(letter, longPress) {
            var currentStates = state.gameState.players[state.playerId].letterStates || {};
            var currentConfirmed = state.gameState.players[state.playerId].confirmedLetters || [];
            var currentState = currentStates[letter];
            if (longPress) {
                if (currentState !== 'included' && currentConfirmed.length >= 5) { state.message = 'Maximal 5 Buchstaben'; haptic('error'); render(); return; }
                var newState = currentState === 'included' ? null : 'included';
                currentStates[letter] = newState;
                if (newState === 'included' && currentConfirmed.indexOf(letter) === -1) currentConfirmed.push(letter);
                else if (newState === null) { var idx = currentConfirmed.indexOf(letter); if (idx > -1) currentConfirmed.splice(idx, 1); }
                haptic('medium');
            } else {
                if (currentState === 'included') {
                    currentStates[letter] = null;
                    var idx = currentConfirmed.indexOf(letter);
                    if (idx > -1) currentConfirmed.splice(idx, 1);
                } else {
                    currentStates[letter] = currentState === 'excluded' ? null : 'excluded';
                }
                haptic('light');
            }
            database.ref('games/' + state.gameId + '/players/' + state.playerId).update({
                letterStates: currentStates, confirmedLetters: currentConfirmed
            }).catch(function(error) { state.message = 'Error: ' + error.message; render(); });
        }

        function render() {
            var app = document.getElementById('app');
            var modals = '';
            
            if (state.showInstructions) {
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">' +
                    '<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">So spielst du 5Buchstaben</h2>' +
                    '<div class="space-y-4 text-gray-700">' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">1</span><p>Jeder Spieler wÃ¤hlt ein geheimes 5-Buchstaben-Wort mit <strong>einzigartigen Buchstaben</strong></p></div>' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">2</span><p>Take turns guessing your opponent\'s word</p></div>' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">3</span><p>Nach jedem Versuch siehst du, wie viele Buchstaben Ã¼bereinstimmen (aber nicht welche!)</p></div>' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">4</span><p>First to guess the opponent\'s word wins!</p></div>' +
                    '<div class="border-t pt-4 mt-4"><p class="font-semibold mb-2">Tipps:</p>' +
                    '<ul class="list-disc list-inside space-y-1 text-sm">' +
                    '<li><strong>Klicke</strong> einen Buchstaben zum AusschlieÃŸen (rot)</li>' +
                    '<li><strong>Lang drÃ¼cken</strong> um ihn einzuschlieÃŸen (grÃ¼n)</li>' +
                    '</ul></div></div>' +
                    '<button onclick="state.showInstructions = false; markInstructionsSeen(); render()" class="w-full mt-6 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">Verstanden!</button>' +
                    '</div></div>';
            }

            if (state.showBeendenConfirm) {
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                    '<h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Spiel beenden?</h3>' +
                    '<p class="text-gray-600 mb-6 text-center">Bist du sicher? Dein Fortschritt geht verloren.</p>' +
                    '<div class="flex gap-3">' +
                    '<button onclick="state.showBeendenConfirm = false; render()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">Abbrechen</button>' +
                    '<button onclick="cancelGame()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition">Beenden</button>' +
                    '</div></div></div>';
            }
            
            if (state.showStatistik) {
                var stats = state.stats;
                var winRate = stats.gamesPlayed > 0 ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100) : 0;
                var avgGuesses = stats.gamesWon > 0 ? (stats.totalGuesses / stats.gamesWon).toFixed(1) : '-';
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                    '<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Deine Statistik</h2>' +
                    '<div class="grid grid-cols-2 gap-4 mb-4">' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-purple-600">' + stats.gamesPlayed + '</div><div class="text-xs text-gray-600">Spiele gespielt</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-green-600">' + winRate + '%</div><div class="text-xs text-gray-600">Gewinnrate</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-orange-600">' + stats.currentStreak + '</div><div class="text-xs text-gray-600">Aktuelle Serie</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-red-600">' + stats.bestStreak + '</div><div class="text-xs text-gray-600">Beste Serie</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-blue-600">' + avgGuesses + '</div><div class="text-xs text-gray-600">Ã˜ Versuche/Sieg</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-indigo-600">' + (stats.quickestWin || '-') + '</div><div class="text-xs text-gray-600">Schnellster Sieg</div></div>' +
                    '</div>' +
                    '<button onclick="state.showStatistik = false; state.showHistory = true; render()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition mb-2">Spielverlauf anzeigen</button>' +
                    '<button onclick="state.showStatistik = false; render()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">SchlieÃŸen</button>' +
                    '</div></div>';
            }

            if (state.showHistory) {
                var history = loadGameHistory();
                var historyHtml = '';
                if (history.length === 0) {
                    historyHtml = '<p class="text-gray-500 text-center py-4">No games played yet</p>';
                } else {
                    history.forEach(function(game) {
                        var date = new Date(game.date);
                        var dateStr = date.toLocaleDateString();
                        var resultClass = game.won ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300';
                        var resultText = game.won ? 'Gewonnen in ' + game.Versuche : 'Verloren';
                        historyHtml += '<div class="' + resultClass + ' border rounded-lg p-3 mb-2">' +
                            '<div class="flex justify-between items-center">' +
                            '<div><span class="font-semibold">vs ' + game.opponent + '</span>' +
                            '<span class="text-xs text-gray-500 ml-2">' + dateStr + '</span></div>' +
                            '<span class="text-sm font-bold">' + resultText + '</span></div>' +
                            '<div class="text-xs text-gray-600 mt-1">Dein Wort: ' + game.myWord + ' Â· Deren Wort: ' + game.theirWord + '</div>' +
                            '</div>';
                    });
                }
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full max-h-[80vh] overflow-y-auto">' +
                    '<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Spielverlauf</h2>' +
                    '<div class="mb-4">' + historyHtml + '</div>' +
                    '<button onclick="state.showHistory = false; render()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">SchlieÃŸen</button>' +
                    '</div></div>';
            }

            // Single Player Mode rendering
            if (state.singlePlayer) {
                var sp = state.singlePlayer;
                var letterStates = sp.letterStates || {};
                var confirmedLetters = sp.confirmedLetters || [];

                var circlePositions = [];
                for (var i = 0; i < 5; i++) {
                    var angle = (i * 72 - 90) * (Math.PI / 180);
                    var x = 77 + 56 * Math.cos(angle);
                    var y = 77 + 56 * Math.sin(angle);
                    circlePositions.push({ x: x, y: y, letter: confirmedLetters[i] || '' });
                }
                var circleSvg = '';
                for (var i = 0; i < circlePositions.length; i++) {
                    var pos = circlePositions[i];
                    circleSvg += '<g><circle cx="' + pos.x + '" cy="' + pos.y + '" r="14" fill="' + (pos.letter ? '#22c55e' : '#f3f4f6') + '" stroke="#d1d5db" stroke-width="2"/>' +
                        '<text x="' + pos.x + '" y="' + pos.y + '" text-anchor="middle" dy="5" font-size="14" font-weight="bold" fill="' + (pos.letter ? 'white' : '#9ca3af') + '">' + pos.letter + '</text></g>';
                }

                var alphabetHtml = '';
                for (var i = 0; i < ALPHABET.length; i++) {
                    var letter = ALPHABET[i];
                    var lState = letterStates[letter];
                    var btnClass = lState === 'excluded' ? 'bg-red-500 text-white line-through' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300';
                    alphabetHtml += '<button data-letter="' + letter + '" data-sp="true" class="sp-letter-btn w-9 h-9 rounded font-bold text-base transition ' + btnClass + '">' + letter + '</button>';
                }

                var VersucheHtml = '';
                if (sp.Versuche && sp.Versuche.length > 0) {
                    for (var i = sp.Versuche.length - 1; i >= 0; i--) {
                        var guess = sp.Versuche[i];
                        var coloredWord = '';
                        for (var j = 0; j < guess.word.length; j++) {
                            var letter = guess.word[j];
                            var lState = letterStates[letter];
                            var letterClass = lState === 'excluded' ? 'bg-red-500 text-white' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-800';
                            coloredWord += '<span class="inline-block w-7 h-7 rounded text-center leading-7 font-bold text-sm ' + letterClass + '">' + letter + '</span>';
                        }
                        var isNewest = (i === sp.Versuche.length - 1);
                        VersucheHtml += '<div class="bg-gray-100 rounded-lg p-2 flex justify-between items-center' + (isNewest ? ' guess-row' : '') + '"><div class="flex gap-0.5">' + coloredWord + '</div>' +
                            '<span class="bg-purple-500 text-white px-2 py-0.5 rounded-full text-sm font-bold">' + guess.matches + '</span></div>';
                    }
                } else {
                    VersucheHtml = '<div class="text-gray-400 text-center py-4 text-sm">Noch keine Versuche</div>';
                }

                var gameEndBanner = '';
                if (sp.gameOver) {
                    if (sp.won) {
                        gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 shadow-lg z-50">' +
                            '<div class="max-w-2xl mx-auto text-center">' +
                            '<h2 class="text-2xl font-bold mb-1">Gewonnen! ðŸŽ‰</h2>' +
                            '<p class="text-sm mb-3">Erraten in ' + sp.Versuche.length + ' Versuchen! Das Wort war ' + sp.secretWord + '</p>' +
                            '<div class="flex justify-center gap-2">' +
                            '<button onclick="shareResult()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">Teilen</button>' +
                            '<button onclick="startSinglePlayer()" class="bg-white text-green-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">Nochmal spielen</button>' +
                            '<button onclick="cancelGame()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">Startseite</button>' +
                            '</div></div></div>';
                    } else {
                        gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-red-500 to-rose-600 text-white p-4 shadow-lg z-50">' +
                            '<div class="max-w-2xl mx-auto text-center">' +
                            '<h2 class="text-2xl font-bold mb-1">Spiel vorbei</h2>' +
                            '<p class="text-sm mb-3">Das Wort war: <span class="font-bold">' + sp.secretWord + '</span></p>' +
                            '<div class="flex justify-center gap-2">' +
                            '<button onclick="startSinglePlayer()" class="bg-white text-red-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">Nochmal versuchen</button>' +
                            '<button onclick="cancelGame()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">Startseite</button>' +
                            '</div></div></div>';
                    }
                }

                var circleSection = state.circleExpanded 
                    ? '<div class="mb-3"><button onclick="state.circleExpanded = false; render()" class="flex items-center gap-2 text-sm text-gray-600 mb-2 font-semibold hover:text-gray-800">' +
                      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>' +
                      'BestÃ¤tigte Buchstaben (' + confirmedLetters.length + '/5)</button>' +
                      '<div class="bg-gray-50 rounded-lg p-2">' +
                      '<div class="flex justify-center"><svg width="126" height="126" viewBox="0 0 154 154"><circle cx="77" cy="77" r="60" fill="none" stroke="#e5e7eb" stroke-width="2"/>' + circleSvg + '</svg></div></div></div>'
                    : '<div class="mb-3"><button onclick="state.circleExpanded = true; render()" class="flex items-center gap-2 text-sm text-gray-600 font-semibold hover:text-gray-800">' +
                      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>' +
                      'BestÃ¤tigte Buchstaben (' + confirmedLetters.length + '/5)</button></div>';

                var guessInputHtml = '';
                var isFirstGuess = sp.Versuche.length === 0;
                if (!sp.gameOver) {
                    var inputClass = isFirstGuess 
                        ? 'flex-1 px-4 py-4 border-3 border-purple-400 rounded-lg text-xl uppercase text-center focus:outline-none focus:border-purple-600 shadow-lg bg-purple-50'
                        : 'flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-lg uppercase text-center focus:outline-none focus:border-purple-500';
                    var buttonClass = isFirstGuess
                        ? 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-lg transition text-lg shadow-lg'
                        : 'bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition';
                    guessInputHtml = '<div class="mb-3"><div class="flex gap-2">' +
                        '<input type="text" id="spGuess" placeholder="' + (isFirstGuess ? 'Gib deinen Versuch ein' : 'Versuch eingeben') + '" value="' + state.currentGuess + '" maxlength="5" class="' + inputClass + '">' +
                        '<button onclick="state.currentGuess = document.getElementById(\'spGuess\').value; makeSinglePlayerGuess()" class="' + buttonClass + '">Go</button></div></div>';
                }

                // Generate contextual hints for new players
                var goalHint = (sp.Versuche.length === 0) ? generateHintsHtml('goal') : '';
                var startHint = (sp.Versuche.length === 0) ? generateHintsHtml('start') : '';
                var alphabetHint = generateHintsHtml('alphabet');
                var firstGuessHint = (sp.Versuche.length === 1) ? generateHintsHtml('first_guess') : '';

                app.innerHTML = gameEndBanner + '<div class="max-w-2xl mx-auto p-2' + (gameEndBanner ? ' pt-24' : '') + '"><div class="bg-white rounded-2xl shadow-2xl p-4 mb-2">' +
                    '<div class="flex items-center justify-between mb-3">' +
                    '<h1 class="text-2xl font-bold text-gray-800 logo-font">5Buchstaben</h1>' +
                    '<div class="flex items-center gap-2">' +
                    '<button onclick="toggleSound()" class="p-1 hover:bg-gray-100 rounded-lg" title="' + (state.soundEnabled ? 'Stumm' : 'Ton an') + '">' +
                    (state.soundEnabled 
                        ? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>'
                        : '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>') +
                    '</button>' +
                    '<button onclick="state.showStatistik = true; render()" class="p-1 hover:bg-gray-100 rounded-lg" title="Statistik"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></button>' +
                    (!sp.gameOver ? '<button onclick="confirmBeenden()" class="p-1 hover:bg-gray-100 rounded-lg" title="Beenden"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>' : '') +
                    '<div class="text-right"><div class="bg-gray-100 rounded px-2 py-1 text-xs font-bold">Solo</div>' +
                    '<div class="text-xs text-gray-500">' + sp.Versuche.length + ' Versuche</div></div></div></div>' +
                    goalHint +
                    startHint +
                    guessInputHtml +
                    circleSection +
                    alphabetHint +
                    '<div class="mb-3"><div class="text-xs text-gray-600 mb-1 font-semibold">Alphabet (Klick: ausschlieÃŸen, Lang drÃ¼cken: einschlieÃŸen)</div>' +
                    '<div class="flex flex-wrap gap-1" id="spAlphabet">' + alphabetHtml + '</div></div>' +
                    firstGuessHint +
                    (state.message ? '<div class="mb-2 p-2 bg-purple-100 text-purple-800 rounded-lg text-center text-sm">' + state.message + '</div>' : '') +
                    (!sp.gameOver ? '<button onclick="giveUpSinglePlayer()" class="w-full mb-3 text-gray-500 hover:text-gray-700 text-sm">Aufgeben Give up & reveal word Wort zeigen</button>' : '') +
                    '<div class="border-t pt-3"><div class="text-xs text-gray-600 mb-2 font-semibold">Deine Versuche:</div>' +
                    '<div class="space-y-1 max-h-72 overflow-y-auto">' + VersucheHtml + '</div></div></div>' +
                    '<p class="text-gray-500 text-xs text-center mt-2">Copyright 2026 5letters.fun/de</p></div>' + modals;

                // Add event listeners for single player alphabet
                var spLetterBtns = document.querySelectorAll('.sp-letter-btn');
                spLetterBtns.forEach(function(btn) {
                    var pressTimer = null;
                    var longPressTriggered = false;
                    var letter = btn.dataset.letter;
                    btn.addEventListener('mousedown', function() {
                        longPressTriggered = false;
                        pressTimer = setTimeout(function() { longPressTriggered = true; toggleSinglePlayerLetter(letter, true); }, 500);
                    });
                    btn.addEventListener('mouseup', function() { if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleSinglePlayerLetter(letter, false); } });
                    btn.addEventListener('mouseleave', function() { if (pressTimer) clearTimeout(pressTimer); });
                    btn.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        longPressTriggered = false;
                        pressTimer = setTimeout(function() { longPressTriggered = true; toggleSinglePlayerLetter(letter, true); }, 500);
                    });
                    btn.addEventListener('touchend', function(e) { e.preventDefault(); if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleSinglePlayerLetter(letter, false); } });
                });

                var spGuessInput = document.getElementById('spGuess');
                if (spGuessInput) spGuessInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { state.currentGuess = spGuessInput.value; makeSinglePlayerGuess(); } });
                
                return;
            }

            if (!state.gameState) {
                var joinModal = '';
                if (state.showJoinModal) {
                    joinModal = '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                        '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                        '<h3 class="text-xl font-bold text-gray-800 mb-4">Spielcode eingeben</h3>' +
                        '<input type="text" id="gameCodeInput" placeholder="e.g. ABC123" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 text-lg uppercase text-center focus:outline-none focus:border-purple-500">' +
                        '<div class="flex gap-3">' +
                        '<button onclick="state.showJoinModal = false; render()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">Abbrechen</button>' +
                        '<button onclick="state.gameId = document.getElementById(\'gameCodeInput\').value; state.showJoinModal = false; joinGame()" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">Join</button>' +
                        '</div></div></div>';
                }
                var shareModal = '';
                if (state.showShareModal) {
                    var gameUrl = window.location.origin + window.location.pathname + '?game=' + state.gameId;
                    shareModal = '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                        '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                        '<h3 class="text-xl font-bold text-gray-800 mb-2">Spiel erstellt!</h3>' +
                        '<p class="text-gray-600 mb-4">Code: <span class="font-bold text-purple-600">' + state.gameId + '</span></p>' +
                        '<div class="flex flex-col gap-3">' +
                        '<button onclick="shareGame(\'' + gameUrl + '\')" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition">Einladungslink teilen</button>' +
                        '<button onclick="state.showShareModal = false; render()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">Weiter</button>' +
                        '</div></div></div>';
                }
                var hasGameCode = state.gameId && state.gameId.length > 0;
                var buttonsHtml = hasGameCode 
                    ? '<button onclick="state.playerName = document.getElementById(\'playerName\').value; joinGame()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition text-lg">Spiel beitreten ' + state.gameId + '</button>'
                    : '<button onclick="startSinglePlayer()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-4 rounded-lg transition text-lg shadow-lg">Jetzt spielen</button>' +
                      '<div class="flex gap-3 mt-4 pt-4 border-t border-gray-200">' +
                      '<button onclick="state.playerName = document.getElementById(\'playerName\').value; createGame()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg transition text-sm">2-Spieler starten</button>' +
                      '<button onclick="state.playerName = document.getElementById(\'playerName\').value; if(!state.playerName.trim()) { state.message = \'Bitte gib deinen Namen ein\'; render(); return; } state.showJoinModal = true; render()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg transition text-sm">2-Spieler beitreten</button></div>';
                
                app.innerHTML = '<div class="min-h-screen flex flex-col items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">' +
                    '<h1 class="text-4xl font-bold text-gray-800 text-center mb-2 logo-font">5Buchstaben</h1>' +
                    '<div class="flex justify-center items-center gap-4 mb-6">' +
                    '<button onclick="state.showInstructions = true; render()" class="text-purple-600 hover:text-purple-800 text-sm font-semibold">So geht's</button>' +
                    '<button onclick="state.showStatistik = true; render()" class="text-purple-600 hover:text-purple-800 text-sm font-semibold">Deine Statistik</button>' +
                    '<button onclick="toggleSound()" class="text-purple-600 hover:text-purple-800" title="' + (state.soundEnabled ? 'Stumm' : 'Ton an') + '">' +
                    (state.soundEnabled 
                        ? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>'
                        : '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>') +
                    '</button></div>' +
                    '<input type="text" id="playerName" placeholder="Dein Name (optional)" value="' + state.playerName + '" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 text-lg focus:outline-none focus:border-purple-500">' +
                    buttonsHtml +
                    (state.message ? '<div class="mt-4 p-3 bg-purple-100 text-purple-800 rounded-lg text-center">' + state.message + '</div>' : '') +
                    '</div><p class="text-gray-500 text-xs mt-4">Copyright 2026 5letters.fun/de</p></div>' + joinModal + shareModal + modals;
                return;
            }

            var myPlayer = state.gameState.players[state.playerId];
            if (!myPlayer.wordSet) {
                var opponent = Object.values(state.gameState.players).find(function(p) { return p !== myPlayer; });
                var playerCount = Object.keys(state.gameState.players).length;
                var gameUrl = window.location.origin + window.location.pathname + '?game=' + state.gameId;
                var statusHtml = '';
                if (playerCount === 1) {
                    statusHtml = '<div class="mt-4 p-4 bg-yellow-100 text-yellow-800 rounded-lg text-center">' +
                        '<p class="font-semibold mb-2">â³ Warte auf Gegner...</p>' +
                        '<p class="text-sm mb-3">Code: <span class="font-bold">' + state.gameId + '</span></p>' +
                        '<div class="flex gap-2 justify-center">' +
                        '<button onclick="shareGame(\'' + gameUrl + '\')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm">Einladung teilen</button>' +
                        '<button onclick="cancelGame()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition text-sm">Abbrechen</button>' +
                        '</div></div>';
                } else if (opponent && !opponent.wordSet) {
                    statusHtml = '<div class="mt-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg text-center">' +
                        '<p>Warte auf ' + opponent.name + ' setzt sein Wort...</p>' +
                        '<button onclick="cancelGame()" class="mt-2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-lg transition text-sm">Abbrechen</button>' +
                        '</div>';
                } else if (opponent && opponent.wordSet) {
                    statusHtml = '<div class="mt-4 p-3 bg-green-100 text-green-800 rounded-lg text-center">ðŸŽ‰ ' + opponent.name + ' ist bereit! Setze dein Wort.</div>';
                }
                app.innerHTML = '<div class="min-h-screen flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">' +
                    '<h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">WÃ¤hle dein geheimes Wort</h2>' +
                    '<p class="text-gray-600 mb-4 text-center">WÃ¤hle ein 5-Buchstaben-Wort mit einzigartigen Buchstaben</p>' +
                    '<input type="text" id="myWord" placeholder="Dein geheimes Wort" value="' + state.myWord + '" maxlength="5" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 text-lg uppercase text-center focus:outline-none focus:border-purple-500">' +
                    '<button onclick="state.myWord = document.getElementById(\'myWord\').value; setSecretWord()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition text-lg">Wort setzen</button>' +
                    (state.message ? '<div class="mt-4 p-3 bg-purple-100 text-purple-800 rounded-lg text-center">' + state.message + '</div>' : '') +
                    statusHtml +
                    '<button onclick="cancelGame()" class="w-full mt-4 text-gray-500 hover:text-gray-700 text-sm">â† ZurÃ¼ck zur Startseite</button>' +
                    '</div></div>' + modals;
                var wordInput = document.getElementById('myWord');
                if (wordInput) wordInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { state.myWord = wordInput.value; setSecretWord(); } });
                return;
            }

            var opponentId = Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; });
            var opponent = opponentId ? state.gameState.players[opponentId] : null;
            var isMyTurn = state.gameState.currentTurn === state.playerId;
            var letterStates = myPlayer.letterStates || {};
            var confirmedLetters = state.confirmedLetters || [];

            var circlePositions = [];
            for (var i = 0; i < 5; i++) {
                var angle = (i * 72 - 90) * (Math.PI / 180);
                var x = 77 + 56 * Math.cos(angle);
                var y = 77 + 56 * Math.sin(angle);
                circlePositions.push({ x: x, y: y, letter: confirmedLetters[i] || '' });
            }
            var circleSvg = '';
            for (var i = 0; i < circlePositions.length; i++) {
                var pos = circlePositions[i];
                circleSvg += '<g><circle cx="' + pos.x + '" cy="' + pos.y + '" r="14" fill="' + (pos.letter ? '#22c55e' : '#f3f4f6') + '" stroke="#d1d5db" stroke-width="2"/>' +
                    '<text x="' + pos.x + '" y="' + pos.y + '" text-anchor="middle" dy="5" font-size="14" font-weight="bold" fill="' + (pos.letter ? 'white' : '#9ca3af') + '">' + pos.letter + '</text></g>';
            }

            var alphabetHtml = '';
            for (var i = 0; i < ALPHABET.length; i++) {
                var letter = ALPHABET[i];
                var lState = letterStates[letter];
                var btnClass = lState === 'excluded' ? 'bg-red-500 text-white line-through' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300';
                alphabetHtml += '<button data-letter="' + letter + '" class="letter-btn w-9 h-9 rounded font-bold text-base transition ' + btnClass + '">' + letter + '</button>';
            }

            var VersucheHtml = '';
            if (myPlayer.Versuche && myPlayer.Versuche.length > 0) {
                for (var i = myPlayer.Versuche.length - 1; i >= 0; i--) {
                    var guess = myPlayer.Versuche[i];
                    var coloredWord = '';
                    for (var j = 0; j < guess.word.length; j++) {
                        var letter = guess.word[j];
                        var lState = letterStates[letter];
                        var letterClass = lState === 'excluded' ? 'bg-red-500 text-white' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-800';
                        coloredWord += '<span class="inline-block w-7 h-7 rounded text-center leading-7 font-bold text-sm ' + letterClass + '">' + letter + '</span>';
                    }
                    var isNewest = (i === myPlayer.Versuche.length - 1);
                    VersucheHtml += '<div class="bg-gray-100 rounded-lg p-2 flex justify-between items-center' + (isNewest ? ' guess-row' : '') + '"><div class="flex gap-0.5">' + coloredWord + '</div>' +
                        '<span class="bg-purple-500 text-white px-2 py-0.5 rounded-full text-sm font-bold">' + guess.matches + '</span></div>';
                }
            } else {
                VersucheHtml = '<div class="text-gray-400 text-center py-4 text-sm">Noch keine Versuche</div>';
            }

            var gameEndContent = '';
            var gameEndBanner = '';
            if (myPlayer.won) {
                gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 shadow-lg z-50">' +
                    '<div class="max-w-2xl mx-auto text-center">' +
                    '<h2 class="text-2xl font-bold mb-1">Gewonnen! ðŸŽ‰</h2>' +
                    '<p class="text-sm mb-3">Erraten in ' + myPlayer.Versuche.length + ' Versuchen!</p>' +
                    '<div class="flex justify-center gap-2">' +
                    '<button onclick="shareResult()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">Ergebnis teilen</button>' +
                    '<button onclick="startRevanche()" class="bg-white text-green-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">Revanche</button>' +
                    '</div></div></div>';
            } else if (opponent && opponent.won) {
                gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-red-500 to-rose-600 text-white p-4 shadow-lg z-50">' +
                    '<div class="max-w-2xl mx-auto text-center">' +
                    '<h2 class="text-2xl font-bold mb-1">Du hast verloren</h2>' +
                    '<p class="text-sm mb-3">' + opponent.name + ' hat dein Wort erraten!</p>' +
                    '<div class="flex justify-center gap-2">' +
                    '<button onclick="shareResult()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">Teilen</button>' +
                    '<button onclick="startRevanche()" class="bg-white text-red-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">Revanche</button>' +
                    '</div></div></div>';
            } else if (!state.gameState.started) {
                gameEndContent = '<div class="bg-white rounded-2xl shadow-2xl p-4 text-center"><p class="text-gray-600">Warte auf Gegner...</p></div>';
            }

            var circleSection = state.circleExpanded 
                ? '<div class="mb-3"><button onclick="state.circleExpanded = false; render()" class="flex items-center gap-2 text-sm text-gray-600 mb-2 font-semibold hover:text-gray-800">' +
                  '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>' +
                  'Dein Wort Your Word & Letters Buchstaben (' + confirmedLetters.length + '/5)</button>' +
                  '<div class="bg-gray-50 rounded-lg p-2">' +
                  '<div class="flex items-center justify-center gap-3 mb-2"><div id="secretWord" class="text-2xl font-bold tracking-widest text-gray-400">*****</div>' +
                  '<button id="showWordBtn" class="p-2 rounded-full hover:bg-gray-200 transition animate-pulse"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-500"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button></div>' +
                  '<div class="flex justify-center"><svg width="126" height="126" viewBox="0 0 154 154"><circle cx="77" cy="77" r="60" fill="none" stroke="#e5e7eb" stroke-width="2"/>' + circleSvg + '</svg></div></div></div>'
                : '<div class="mb-3"><button onclick="state.circleExpanded = true; render()" class="flex items-center gap-2 text-sm text-gray-600 font-semibold hover:text-gray-800">' +
                  '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>' +
                  'Dein Wort Your Word & Letters Buchstaben (' + confirmedLetters.length + '/5)</button></div>';

            // Build guess input section
            var guessInputHtml = '';
            if (state.gameState.started && !myPlayer.won && !(opponent && opponent.won)) {
                var turnClass = isMyTurn ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                var turnMsg = isMyTurn ? "Du bist dran!" : "Warte auf " + (opponent ? opponent.name : '') + "...";
                if (isMyTurn) {
                    guessInputHtml = '<div class="mb-3"><div class="flex gap-2">' +
                        '<input type="text" id="currentGuess" placeholder="Versuch eingeben" value="' + state.currentGuess + '" maxlength="5" class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-lg uppercase text-center focus:outline-none focus:border-purple-500">' +
                        '<button onclick="state.currentGuess = document.getElementById(\'currentGuess\').value; makeGuess()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">Go</button></div></div>';
                } else {
                    guessInputHtml = '<div class="mb-3 p-2 rounded-lg text-center text-sm font-semibold ' + turnClass + '">' + turnMsg + '</div>';
                }
            }

            // Generate contextual hints for new players
            var myGuessCount = myPlayer.Versuche ? myPlayer.Versuche.length : 0;
            var goalHint = (myGuessCount === 0 && state.gameState.started) ? generateHintsHtml('goal') : '';
            var alphabetHint = generateHintsHtml('alphabet');
            var firstGuessHint = (myGuessCount === 1) ? generateHintsHtml('first_guess') : '';

            app.innerHTML = gameEndBanner + '<div class="max-w-2xl mx-auto p-2' + (gameEndBanner ? ' pt-24' : '') + '"><div class="bg-white rounded-2xl shadow-2xl p-4 mb-2">' +
                '<div class="flex items-center justify-between mb-3">' +
                '<h1 class="text-2xl font-bold text-gray-800 logo-font">5Buchstaben</h1>' +
                '<div class="flex items-center gap-2">' +
                '<button onclick="toggleSound()" class="p-1 hover:bg-gray-100 rounded-lg" title="' + (state.soundEnabled ? 'Stumm' : 'Ton an') + '">' +
                (state.soundEnabled 
                    ? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>') +
                '</button>' +
                '<button onclick="state.showStatistik = true; render()" class="p-1 hover:bg-gray-100 rounded-lg" title="Statistik"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></button>' +
                (!gameEndBanner ? '<button onclick="confirmBeenden()" class="p-1 hover:bg-gray-100 rounded-lg" title="Beenden"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>' : '') +
                '<div class="text-right"><div class="bg-gray-100 rounded px-2 py-1 text-xs font-bold">' + state.gameId + '</div>' +
                '<div class="text-xs text-gray-500">vs ' + (opponent ? opponent.name : '...') + '</div></div></div></div>' +
                goalHint +
                circleSection +
                alphabetHint +
                '<div class="mb-3"><div class="text-xs text-gray-600 mb-1 font-semibold">Alphabet (Klick: ausschlieÃŸen, Lang drÃ¼cken: einschlieÃŸen)</div>' +
                '<div class="flex flex-wrap gap-1" id="alphabet">' + alphabetHtml + '</div></div>' +
                guessInputHtml +
                firstGuessHint +
                (state.message ? '<div class="mb-2 p-2 bg-purple-100 text-purple-800 rounded-lg text-center text-sm">' + state.message + '</div>' : '') +
                '<div class="border-t pt-3"><div class="text-xs text-gray-600 mb-2 font-semibold">Deine Versuche:</div>' +
                '<div class="space-y-1 max-h-72 overflow-y-auto">' + VersucheHtml + '</div></div></div>' +
                gameEndContent + '<p class="text-gray-500 text-xs text-center mt-2">Copyright 2026 5letters.fun/de</p></div>' + modals;

            var letterBtns = document.querySelectorAll('.letter-btn');
            letterBtns.forEach(function(btn) {
                var pressTimer = null;
                var longPressTriggered = false;
                var letter = btn.dataset.letter;
                btn.addEventListener('mousedown', function() {
                    longPressTriggered = false;
                    pressTimer = setTimeout(function() { longPressTriggered = true; toggleLetterState(letter, true); }, 500);
                });
                btn.addEventListener('mouseup', function() { if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleLetterState(letter, false); } });
                btn.addEventListener('mouseleave', function() { if (pressTimer) clearTimeout(pressTimer); });
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    longPressTriggered = false;
                    pressTimer = setTimeout(function() { longPressTriggered = true; toggleLetterState(letter, true); }, 500);
                });
                btn.addEventListener('touchend', function(e) { e.preventDefault(); if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleLetterState(letter, false); } });
            });

            var guessInput = document.getElementById('currentGuess');
            if (guessInput) guessInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { state.currentGuess = guessInput.value; makeGuess(); } });

            var showWordBtn = document.getElementById('showWordBtn');
            var secretWordEl = document.getElementById('secretWord');
            if (showWordBtn && secretWordEl) {
                var actualWord = myPlayer.word;
                showWordBtn.addEventListener('mousedown', function() { secretWordEl.textContent = actualWord; });
                showWordBtn.addEventListener('mouseup', function() { secretWordEl.textContent = '*****'; });
                showWordBtn.addEventListener('mouseleave', function() { secretWordEl.textContent = '*****'; });
                showWordBtn.addEventListener('touchstart', function(e) { e.preventDefault(); secretWordEl.textContent = actualWord; });
                showWordBtn.addEventListener('touchend', function(e) { e.preventDefault(); secretWordEl.textContent = '*****'; });
            }
        }

        // Log page view once on load
        logEvent('page_view');
        
        render();
    </script>
</body>
</html>
