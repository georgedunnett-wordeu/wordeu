<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5letters - Word Guessing Game</title>
    <meta name="description" content="Challenge friends to guess your secret 5-letter word! A fun two-player word guessing game.">
    <meta property="og:title" content="5letters - Word Guessing Game">
    <meta property="og:description" content="Challenge friends to guess your secret 5-letter word!">
    <meta property="og:url" content="https://www.5letters.fun">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="5letters - Word Guessing Game">
    <meta name="twitter:description" content="Challenge friends to guess your secret 5-letter word!">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%238B5CF6'/%3E%3Ctext x='16' y='23' text-anchor='middle' font-family='Arial,sans-serif' font-weight='bold' font-size='16' fill='white'%3E5L%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%238B5CF6'/%3E%3Ctext x='16' y='23' text-anchor='middle' font-family='Arial,sans-serif' font-weight='bold' font-size='16' fill='white'%3E5L%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='30' fill='%238B5CF6'/%3E%3Ctext x='90' y='120' text-anchor='middle' font-family='Arial,sans-serif' font-weight='bold' font-size='90' fill='white'%3E5L%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-database-compat.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        .logo-font { font-family: 'Playfair Display', serif; }
        .logo-container {
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        .logo-circle {
            width: 36px;
            height: 36px;
            background: #8b5cf6;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 800;
            color: white;
        }
        .logo-box {
            width: 32px;
            height: 38px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            color: white;
        }
        .logo-green { background: #22c55e; }
        .logo-red { background: #ef4444; }
        .logo-gray { background: #374151; }
        /* Mobile responsive logo sizing */
        @media (max-width: 640px) {
            .logo-container {
                gap: 2px;
            }
            .logo-circle {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }
            .logo-box {
                width: 22px;
                height: 26px;
                font-size: 13px;
            }
        }
        .banner-enter { animation: slideDown 0.3s ease-out; }
        .banner-exit { animation: slideUp 0.3s ease-in forwards; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(-100px) rotate(720deg); opacity: 0; } }
        .shake { animation: shake 0.4s ease-in-out; }
        .pop { animation: pop 0.2s ease-out; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .guess-row { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-800 min-h-screen">
    <div id="app"></div>
    <div id="banner"></div>
    <div id="confetti"></div>
    <script>
        // Sound effects using Web Audio API
        var audioCtx = null;
        function getAudioContext() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            return audioCtx;
        }
        
        function playSound(type) {
            if (!state.soundEnabled) return;
            try {
                var ctx = getAudioContext();
                var oscillator = ctx.createOscillator();
                var gainNode = ctx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                if (type === 'click') {
                    oscillator.frequency.value = 600;
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.1);
                } else if (type === 'success') {
                    oscillator.frequency.value = 523;
                    gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
                    oscillator.start(ctx.currentTime);
                    oscillator.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(784, ctx.currentTime + 0.2);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                    oscillator.stop(ctx.currentTime + 0.4);
                } else if (type === 'error') {
                    oscillator.frequency.value = 200;
                    oscillator.type = 'square';
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.2);
                } else if (type === 'win') {
                    var notes = [523, 659, 784, 1047];
                    notes.forEach(function(freq, i) {
                        var osc = ctx.createOscillator();
                        var gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.15, ctx.currentTime + i * 0.15);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.15 + 0.3);
                        osc.start(ctx.currentTime + i * 0.15);
                        osc.stop(ctx.currentTime + i * 0.15 + 0.3);
                    });
                } else if (type === 'lose') {
                    oscillator.frequency.value = 300;
                    oscillator.type = 'sawtooth';
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.5);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.5);
                } else if (type === 'match') {
                    oscillator.frequency.value = 440;
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    oscillator.frequency.setValueAtTime(550, ctx.currentTime + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.2);
                }
            } catch (e) { /* Audio not supported */ }
        }
        
        function haptic(type) {
            if (navigator.vibrate) {
                if (type === 'light') navigator.vibrate(10);
                else if (type === 'medium') navigator.vibrate(25);
                else if (type === 'heavy') navigator.vibrate(50);
                else if (type === 'error') navigator.vibrate([50, 50, 50]);
                else if (type === 'success') navigator.vibrate([30, 50, 30]);
            }
        }
        
        function showConfetti() {
            var container = document.getElementById('confetti');
            var colors = ['#8B5CF6', '#22C55E', '#F59E0B', '#EF4444', '#3B82F6'];
            for (var i = 0; i < 50; i++) {
                var confetti = document.createElement('div');
                confetti.style.cssText = 'position:fixed;width:10px;height:10px;background:' + colors[i % colors.length] + 
                    ';left:' + Math.random() * 100 + '%;top:50%;border-radius:2px;pointer-events:none;z-index:100;' +
                    'animation:confetti 1s ease-out forwards;animation-delay:' + (Math.random() * 0.5) + 's;';
                container.appendChild(confetti);
            }
            setTimeout(function() { container.innerHTML = ''; }, 2000);
        }

        var fbConfig = {
            apiKey: "AIzaSyA9SGAh5bXJyNNs7LD9Jd8kFkRW4JRv6gI",
            authDomain: "wordeu-742d5.firebaseapp.com",
            databaseURL: "https://wordeu-742d5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "wordeu-742d5",
            storageBucket: "wordeu-742d5.firebasestorage.app",
            messagingSenderId: "391013275080",
            appId: "1:391013275080:web:51d96cabffbc1527521cfd"
        };
        firebase.initializeApp(fbConfig);
        var database = firebase.database();

        // ========== LANGUAGE SYSTEM ==========
        var currentLang = localStorage.getItem('5letters_lang') || (navigator.language.startsWith('de') ? 'de' : navigator.language.startsWith('fr') ? 'fr' : 'en');
        var langData = null;
        
        function t(key) { return (langData && langData.ui && langData.ui[key]) || key; }
        function getAlphabet() { return ((langData && langData.config && langData.config.alphabet) || 'ABCDEFGHIJKLMNOPQRSTUVWXYZ').split(''); }
        function getWords() {
            // First try from loaded langData
            if (langData && langData.words) return langData.words;
            // Fall back to cached word list for offline support
            return loadWordList(currentLang);
        }

        function renderLogo() {
            // Get logo configuration from language data
            var logoConfig = langData && langData.ui && langData.ui.logo;
            if (!logoConfig) {
                // Fallback to simple text logo
                return '<span class="text-2xl font-bold text-gray-800 logo-font">' + t('logoText') + '</span>';
            }

            var html = '<div class="logo-container">';
            html += '<span class="logo-circle">5</span>';

            var text = logoConfig.text || 'LETTERS';
            var colors = logoConfig.colors || [];

            for (var i = 0; i < text.length; i++) {
                var letter = text[i];
                var color = colors[i] || 'gray';
                html += '<span class="logo-box logo-' + color + '">' + letter + '</span>';
            }

            html += '</div>';
            return html;
        }

        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('5letters_lang', lang);
            database.ref('languages/' + lang).once('value').then(function(snap) {
                if (snap.exists()) {
                    langData = snap.val();
                    // Cache word list for offline support
                    if (langData.words) {
                        saveWordList(lang, langData.words);
                    }
                }
                render();
            });
        }

        // Load language on startup
        database.ref('languages/' + currentLang).once('value').then(function(snap) {
            if (snap.exists()) {
                langData = snap.val();
                // Cache word list for offline support
                if (langData.words) {
                    saveWordList(currentLang, langData.words);
                }
            }
            render();
        }).catch(function() { render(); });

        var savedId = localStorage.getItem('visitorId');
        var newId = Math.random().toString(36).substr(2, 9);
        var visitorId = savedId ? savedId : newId;
        localStorage.setItem('visitorId', visitorId);

        var sessionPlayerId = sessionStorage.getItem('playerId');
        if (!sessionPlayerId) {
            sessionPlayerId = Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('playerId', sessionPlayerId);
        }

        function loadStats() {
            var stats = localStorage.getItem('wordoStats_' + visitorId);
            if (stats) return JSON.parse(stats);
            return { gamesPlayed: 0, gamesWon: 0, gamesLost: 0, currentStreak: 0, bestStreak: 0, totalGuesses: 0, quickestWin: null };
        }

        function saveStats(stats) {
            localStorage.setItem('wordoStats_' + visitorId, JSON.stringify(stats));
        }

        function loadPlayerName() {
            return localStorage.getItem('wordoPlayerName_' + visitorId) || '';
        }

        function savePlayerName(name) {
            localStorage.setItem('wordoPlayerName_' + visitorId, name);
        }

        function saveWordList(lang, words) {
            try {
                localStorage.setItem('wordoWordList_' + lang, JSON.stringify(words));
            } catch (e) {
                // localStorage might be full, silently fail
            }
        }

        function loadWordList(lang) {
            try {
                var cached = localStorage.getItem('wordoWordList_' + lang);
                if (cached) return JSON.parse(cached);
            } catch (e) {
                // Parse error or missing, return null
            }
            return null;
        }

        function loadActiveGame() {
            var saved = localStorage.getItem('wordoActiveGame_' + visitorId);
            if (saved) return JSON.parse(saved);
            return null;
        }

        function saveActiveGame(gameId, playerId) {
            localStorage.setItem('wordoActiveGame_' + visitorId, JSON.stringify({ gameId: gameId, playerId: playerId }));
        }

        function clearActiveGame() {
            localStorage.removeItem('wordoActiveGame_' + visitorId);
        }

        function loadSoundEnabled() {
            var saved = localStorage.getItem('wordoSoundEnabled_' + visitorId);
            return saved === null ? true : saved === 'true';
        }

        function saveSoundEnabled(enabled) {
            localStorage.setItem('wordoSoundEnabled_' + visitorId, enabled.toString());
        }

        function loadGameHistory() {
            var saved = localStorage.getItem('wordoGameHistory_' + visitorId);
            if (saved) return JSON.parse(saved);
            return [];
        }

        function saveGameToHistory(gameData) {
            var history = loadGameHistory();
            history.unshift(gameData); // Add to beginning
            if (history.length > 10) history = history.slice(0, 10); // Keep last 10
            localStorage.setItem('wordoGameHistory_' + visitorId, JSON.stringify(history));
        }

        function isFirstTimeUser() { return !localStorage.getItem('wordoInstructionsSeen'); }
        function markInstructionsSeen() { localStorage.setItem('wordoInstructionsSeen', 'true'); }

        // Hints system - show tips for first few games
        function getGamesPlayed() {
            var stats = loadStats();
            return stats.gamesPlayed || 0;
        }
        function shouldShowHints() {
            return getGamesPlayed() < 3;
        }
        function getHintsDismissed() {
            var saved = localStorage.getItem('wordoHintsDismissed_' + visitorId);
            if (saved) return JSON.parse(saved);
            return {};
        }
        function dismissHint(hintId) {
            var dismissed = getHintsDismissed();
            dismissed[hintId] = true;
            localStorage.setItem('wordoHintsDismissed_' + visitorId, JSON.stringify(dismissed));
        }
        function isHintDismissed(hintId) {
            return getHintsDismissed()[hintId] === true;
        }

        // Analytics logging
        function logEvent(eventName, data) {
            try {
                database.ref('analytics/' + eventName).push({
                    timestamp: Date.now(),
                    visitorId: visitorId,
                    data: data || null
                }).catch(function(error) {
                    // Silently fail if analytics permissions not configured
                });
            } catch (e) {
                // Silently fail if database not available
            }
        }

        // Generate contextual hints HTML for new players
        function generateHintsHtml(context) {
            if (!shouldShowHints()) return '';
            var hints = [];
            
            // Context: 'start' - show at very start pointing to guess box
            if (context === 'start' && !isHintDismissed('start')) {
                hints.push({
                    id: 'start',
                    text: t('hintStart'),
                    color: 'green'
                });
            }
            
            // Context: 'first_guess' - show after first guess is made
            if (context === 'first_guess' && !isHintDismissed('first_guess')) {
                hints.push({
                    id: 'first_guess',
                    text: t('hintFirstGuess'),
                    color: 'blue'
                });
            }
            
            // Context: 'alphabet' - show near alphabet section
            if (context === 'alphabet' && !isHintDismissed('alphabet')) {
                hints.push({
                    id: 'alphabet',
                    text: t('hintAlphabet'),
                    color: 'amber'
                });
            }
            
            // Context: 'goal' - show at start of game
            if (context === 'goal' && !isHintDismissed('goal')) {
                hints.push({
                    id: 'goal',
                    text: t('hintGoal'),
                    color: 'purple'
                });
            }
            
            if (hints.length === 0) return '';
            
            var html = '';
            hints.forEach(function(hint) {
                var bgColor = hint.color === 'blue' ? 'bg-blue-50 border-blue-200 text-blue-800' :
                              hint.color === 'amber' ? 'bg-amber-50 border-amber-200 text-amber-800' :
                              hint.color === 'green' ? 'bg-green-50 border-green-200 text-green-800' :
                              'bg-purple-50 border-purple-200 text-purple-800';
                html += '<div class="' + bgColor + ' border rounded-lg p-3 mb-2 text-sm relative">' +
                    '<button onclick="dismissHint(\'' + hint.id + '\'); render()" class="absolute top-1 right-2 text-gray-400 hover:text-gray-600 text-lg leading-none">&times;</button>' +
                    '<div class="pr-6">' + hint.text + '</div></div>';
            });
            return html;
        }

        var state = {
            playerId: sessionPlayerId,
            visitorId: visitorId,
            playerName: loadPlayerName(),
            gameId: '',
            gameState: null,
            myWord: '',
            currentGuess: '',
            message: '',
            confirmedLetters: [],
            showJoinModal: false,
            showShareModal: false,
            showInstructions: isFirstTimeUser(),
            showStats: false,
            showHistory: false,
            showShareResult: false,
            showQuitConfirm: false,
            circleExpanded: true,
            lastOpponentGuessCount: 0,
            stats: loadStats(),
            bannerTimeout: null,
            soundEnabled: loadSoundEnabled(),
            lastGameResult: null,
            // Single player mode
            singlePlayer: null  // { secretWord, guesses[], letterStates{}, confirmedLetters[], gameOver, won }
        };
        
        var ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

        // Word list for single player mode (common 5-letter words with unique letters)
        var WORD_LIST = [
            'ABOUT','ABOVE','ABUSE','ACUTE','ADEPT','ADMIT','ADOPT','ADULT','AGENT','AGILE',
            'ALARM','ALBUM','ALIEN','ALIGN','AMBER','AMUSE','ANGEL','ANGER','ANGLE','ANKLE',
            'APART','ARGUE','ARISE','ARMED','AROMA','ASIDE','ASKED','ASPIC','ATLAS','AUDIO',
            'BADGE','BADLY','BAKED','BALDY','BASIN','BATCH','BEACH','BEADS','BEARD','BEAST',
            'BEGAN','BEING','BELOW','BENCH','BIGOT','BIRCH','BLACK','BLADE','BLAME','BLAND',
            'BLANK','BLAST','BLAZE','BLEAT','BLEND','BLIMP','BLIND','BLOCK','BLOKE','BLOND',
            'BLOWN','BLUES','BLUNT','BOARD','BOAST','BONED','BONUS','BOTCH','BOUGH','BOUND',
            'BRACE','BRAIN','BRAKE','BRAND','BRASH','BRAVO','BREAD','BREAK','BRICK','BRIDE',
            'BRING','BRISK','BROAD','BROIL','BROKE','BRUNT','BRUSH','BRUTE','BUILD','BUILT',
            'BUNCH','BURST','CABLE','CADET','CAMEL','CAMEO','CAMPS','CANDY','CANOE','CAPER',
            'CAROM','CAUSE','CEDAR','CHAIR','CHALK','CHAMP','CHANT','CHARM','CHASE','CHEAP',
            'CHEAT','CHEST','CHILD','CHIME','CHINA','CHIMP','CHIRP','CHOMP','CHORD','CHOSE',
            'CHUNK','CIGAR','CINCH','CLAIM','CLAMP','CLANG','CLANK','CLASH','CLASP','CLEAN',
            'CLEAR','CLIMB','CLING','CLOAK','CLONE','CLOTH','CLOUD','CLOUT','CLOWN','CLUBS',
            'CLUED','CLUMP','CLUNG','COACH','COAST','COBRA','COILS','COLDS','COMET','COMFY',
            'COMIC','CORAL','COUCH','COUGH','COULD','COUNT','COUPLE','COURT','COVER','CRAFT',
            'CRAMP','CRANE','CRANK','CRASH','CRAWL','CRAZY','CREAM','CREST','CRISP','CROAK',
            'CRONE','CROWD','CROWN','CRUDE','CRUEL','CRUSH','CRUST','CURLY','DAILY','DAIRY',
            'DAISY','DANCE','DEALT','DEATH','DECAL','DECAY','DELTA','DEMON','DEPOT','DEPTH',
            'DIARY','DINER','DIRTY','DISCO','DITCH','DOUBT','DOUGH','DRAFT','DRAIN','DRAKE',
            'DRANK','DRAPE','DRAWN','DREAD','DREAM','DRESS','DRIFT','DRINK','DRIVE','DROIT',
            'DROWN','DRUGS','DRUMS','DRUNK','DUSTY','DWARF','DYING','EAGER','EARLY','EARTH',
            'EBONY','EDICT','EIGHT','ELBOW','EMILY','EMPTY','ENACT','ENJOY','ENTRY','EPOCH',
            'EQUIP','ERUPT','EVICT','EXACT','EXAMS','EXULT','FABLE','FACTS','FAINT','FAIRY',
            'FAITH','FALSE','FANCY','FARCE','FAULT','FAUNA','FEAST','FEATS','FETCH','FIELD',
            'FIEND','FIERY','FIFTY','FIGHT','FILTH','FINAL','FINCH','FIRED','FIRST','FIXED',
            'FJORD','FLACK','FLAIR','FLAKE','FLAME','FLANK','FLARE','FLASH','FLASK','FLAXY',
            'FLESH','FLICK','FLING','FLINT','FLOAT','FLOCK','FLOOD','FLOOR','FLORA','FLOSS',
            'FLOUT','FLOWN','FLUID','FLUKE','FLUNG','FLUNK','FLUSH','FLUTE','FOCAL','FOCUS',
            'FOGEY','FOLKS','FORCE','FORGE','FORGO','FORMS','FORTH','FORTY','FORUM','FOSSIL',
            'FOUND','FOYER','FRAIL','FRAME','FRANK','FRAUD','FREAK','FRESH','FRIED','FRIES',
            'FROCK','FROGS','FRONT','FROST','FROWN','FROZE','FRUIT','FUDGE','FUNGI','FUNKY',
            'GAMES','GAUDY','GAUGE','GAUNT','GAUZE','GAVEL','GENUS','GHOST','GIANT','GIVEN',
            'GLAND','GLARE','GLEAM','GLEAN','GLIDE','GLINT','GLOBE','GLOOM','GLORY','GLOSS',
            'GLOVE','GLUED','GLYPH','GNOME','GOALS','GOATS','GODLY','GOING','GOLEM','GONER',
            'GRAFT','GRAIL','GRAIN','GRAND','GRANT','GRAPE','GRAPH','GRASP','GRASS','GRATE',
            'GRAVE','GRAVY','GRAZE','GREAT','GREED','GREET','GRIEF','GRILL','GRIME','GRIND',
            'GRIPE','GROAN','GROIN','GROOM','GROPE','GROSS','GROUP','GROVE','GROWL','GROWN',
            'GUARD','GUEST','GUIDE','GUILD','GUILT','GUISE','GULCH','GUMMY','GUPPY','GUSSY',
            'GUSTO','GUSTY','HABIT','HACKY','HAIKU','HAIRY','HALTS','HANDY','HAPPY','HARDY',
            'HASTE','HASTY','HATCH','HAUNT','HAVEN','HEADS','HEARD','HEART','HEAVY','HEDGE',
            'HEIST','HERBS','HERON','HIKER','HIRED','HITCH','HOARD','HOBBY','HOIST','HOLDS',
            'HOMES','HONEY','HOPED','HORSE','HOSED','HOTEL','HOUND','HOURS','HOUSE','HUMAN',
            'HUMID','HUSKY','ICING','ICONS','IDEAL','IDLER','IMAGE','IMPLY','INANE','INDEX',
            'INEPT','INERT','INGOT','INNER','INPUT','INTRO','IRATE','IRKED','IRONY','ISSUE',
            'ITCHY','IVORY','JAILS','JAUNT','JEANS','JERKY','JEWEL','JIFFY','JOKER','JOLLY',
            'JOUST','JUDGE','JUICE','JUICY','JUMBO','JUMPS','JUMPY','JUNCO','JUNKY','JUROR',
            'KARMA','KAYAK','KEBAB','KELPS','KICKS','KILNS','KILTS','KINDS','KINGS','KIOSK',
            'KNIFE','KNOCK','KNOWN','KUDOS','LABEL','LABOR','LACED','LADLE','LAGER','LANCE',
            'LANES','LAPSE','LARGE','LASER','LATCH','LATER','LATEX','LATHE','LATIN','LAUGH',
            'LAYER','LEACH','LEADS','LEAFY','LEAKY','LEANT','LEARN','LEASE','LEASH','LEAST',
            'LEDGE','LEMON','LIENS','LIGHT','LIMBO','LIMBS','LIMPS','LINED','LINER','LINES',
            'LINKS','LIONS','LITER','LIVER','LIVED','LIVES','LOADS','LOANS','LOATH','LOCAL',
            'LOCKS','LODGE','LOFTY','LOGIC','LONER','LONGS','LOOPY','LORDS','LOSER','LOTUS',
            'LOUSE','LOUSY','LOVED','LOVER','LOWER','LOYAL','LUCID','LUCKY','LUMEN','LUMPS',
            'LUMPY','LUNAR','LUNCH','LUNGE','LUNGS','LURCH','LURID','LYING','LYRIC','MACHO',
            'MACRO','MAGIC','MAINS','MAIZE','MAJOR','MAKER','MALES','MANGE','MANGO','MANGY',
            'MANOR','MAPLE','MARCH','MARSH','MASON','MATCH','MAYOR','MEALY','MEANT','MEATY',
            'MEDAL','MEDIA','MELON','MERCY','MERGE','MERIT','MESSY','METAL','MICRO','MIDGE',
            'MIDST','MIGHT','MINCE','MINDS','MINED','MINER','MINOR','MINTY','MINUS','MIRTH',
            'MISER','MISTY','MIXED','MIXER','MODEL','MOIST','MOLAR','MONEY','MONTH','MOOSE',
            'MORAL','MORON','MORPH','MOSSY','MOTEL','MOTIF','MOTOR','MOULD','MOUNT','MOURN',
            'MOUSE','MOUSY','MOUTH','MOVED','MOVER','MOVIE','MUCKY','MUCUS','MUDDY','MULCH',
            'MUNCH','MURAL','MURKY','MUSIC','MUSKY','MUSTY','MYTHS','NACHO','NAIVE','NAKED',
            'NAMES','NAPPY','NASTY','NAVAL','NAVEL','NECKS','NERDY','NERVE','NEWLY','NICER',
            'NICHE','NIGHT','NINJA','NOBLE','NOISE','NOISY','NOMAD','NORTH','NOTCH','NOTED',
            'NOTES','NOVEL','NUDGE','NURSE','OAKEN','OATER','OCCUR','OCEAN','OCTET','ODIUM',
            'OFFER','OFTEN','OILED','OLDEN','OLDER','OLIVE','ONSET','OPENS','OPERA','OPTED',
            'OPTIC','ORBIT','ORDER','ORGAN','OTHER','OUGHT','OUNCE','OUTER','OUTGO','OVARY',
            'OVERT','OWNED','OWNER','OXIDE','OZONE','PACED','PACER','PAGER','PAGES','PAINT',
            'PAIRS','PALER','PALMS','PALSY','PANEL','PANIC','PANTS','PAPER','PARKS','PARTS',
            'PARTY','PASTA','PASTE','PASTY','PATCH','PATIO','PAUSE','PEACE','PEACH','PEAKS',
            'PEARL','PECAN','PEDAL','PENAL','PENNY','PERCH','PERKY','PESKY','PETAL','PETRI',
            'PETTY','PHASE','PHONE','PHONY','PIANO','PICKS','PICKY','PIECE','PIETY','PIGMY',
            'PIKED','PILED','PILOT','PINCH','PINED','PINTO','PIOUS','PIPES','PITCH','PITHY',
            'PIVOT','PIXEL','PLACE','PLAID','PLAIN','PLANE','PLANK','PLANS','PLANT','PLATE',
            'PLAYS','PLAZA','PLEAD','PLEAT','PLEDGE','PLIER','PLODS','PLONK','PLOTS','PLUCK',
            'PLUGS','PLUMB','PLUME','PLUMP','PLUMS','PLUNK','PLUSH','POACH','POEMS','POETS',
            'POINT','POISE','POKEY','POLAR','POLES','PONDS','PORCH','PORES','PORKS','PORKY',
            'PORTS','POSED','POSER','POSIT','POSSE','POUCH','POULT','POUND','POWER','PRANK',
            'PRAWN','PREACH','PRESS','PREYS','PRICE','PRIDE','PRIED','PRIME','PRINT','PRIOR',
            'PRISM','PRIVY','PRIZE','PROBE','PRODS','PRONE','PRONG','PROOF','PROSE','PROUD',
            'PROVE','PROWL','PRUDE','PRUNE','PSALM','PUBIC','PUFFY','PULSE','PUNCH','PUNKS',
            'PUNTS','PURGE','PUSHY','QUALM','QUART','QUEEN','QUERY','QUEST','QUICK','QUIET',
            'QUILT','QUIRK','QUOTA','QUOTE','RABID','RACED','RACER','RADAR','RADIO','RADON',
            'RAGED','RAIDS','RAILS','RAINY','RAISE','RALLY','RANCH','RANGE','RANTS','RAPID',
            'RASPY','RATIO','RAVEN','RAZOR','REACH','REACT','READS','READY','REALM','REAMS',
            'RECAP','REDUX','REEDY','REFIT','REGAL','REIGN','RELAX','RELAY','RELIC','REMIX',
            'RENAL','REPAY','REPLY','RESIN','RETRO','RHINO','RHYME','RIDGE','RIFLE','RIGHT',
            'RIGID','RIGOR','RINDS','RINGS','RINSE','RISEN','RISKY','RITZY','RIVAL','RIVEN',
            'RIVER','ROADS','ROAMS','ROAST','ROBED','ROBES','ROBIN','ROBOT','ROCKS','ROCKY',
            'RODEO','ROGUE','ROLES','ROMAN','ROOST','ROSES','ROSIN','ROTOR','ROUGE','ROUGH',
            'ROUND','ROUSE','ROUTE','ROVER','ROWDY','ROYAL','RUBES','RUCKS','RUDDY','RUDER',
            'RUGBY','RUINS','RULED','RULER','RUMMY','RUMPS','RUPEE','RURAL','RUSTY','SADLY',
            'SAFER','SAINT','SALTY','SALVE','SANDY','SANER','SAPLING','SAPPY','SATIN','SAUCE',
            'SAUCY','SAUNA','SAVOR','SCALD','SCALE','SCALP','SCALY','SCAMP','SCANT','SCARE',
            'SCARF','SCARS','SCARY','SCENE','SCENT','SCHMO','SCONE','SCOOP','SCOPE','SCORE',
            'SCORN','SCOUT','SCOWL','SCRAM','SCRAP','SCRUB','SEAMS','SEARS','SEDAN','SEDGE',
            'SEEDY','SEGUE','SEIZE','SENSE','SEPIA','SERUM','SERVE','SETUP','SEVEN','SEWER',
            'SHACK','SHADE','SHADY','SHAFT','SHAKE','SHAKY','SHALE','SHAME','SHANK','SHAPE',
            'SHARD','SHARE','SHARK','SHARP','SHAVE','SHAWL','SHEAF','SHEAR','SHEEN','SHEEP',
            'SHEER','SHELF','SHELL','SHIFT','SHINE','SHINY','SHIRE','SHIRK','SHIRT','SHOCK',
            'SHOES','SHONE','SHOOK','SHOOT','SHORE','SHORN','SHORT','SHOUT','SHOVE','SHOWN',
            'SHOWY','SHRUB','SHRUG','SHUCK','SHUNT','SIDED','SIDES','SIEGE','SIGMA','SIGHT',
            'SIGMA','SIGNS','SILKY','SILTS','SINCE','SINGE','SIREN','SIREN','SITED','SITES',
            'SIXTH','SIXTY','SIZED','SKATE','SKEIN','SKIER','SKIES','SKIMP','SKIMS','SKINS',
            'SKIRT','SKULK','SKULL','SKUNK','SLACK','SLAIN','SLANG','SLANT','SLASH','SLATE',
            'SLAVE','SLEEK','SLEEP','SLEET','SLEPT','SLICE','SLIDE','SLIME','SLIMY','SLING',
            'SLINK','SLIPS','SLOPE','SLOSH','SLOTH','SLUMP','SLUNG','SLUNK','SLURP','SLYLY',
            'SMACK','SMALL','SMART','SMASH','SMEAR','SMELL','SMELT','SMILE','SMIRK','SMITE',
            'SMITH','SMOKE','SMOKY','SNACK','SNAIL','SNAKE','SNAKY','SNAPS','SNARE','SNARL',
            'SNEAK','SNIDE','SNIFF','SNIPE','SNORE','SNORT','SNOUT','SNOWY','SNUCK','SNUGLY',
            'SOAPY','SOBER','SOCKS','SOGGY','SOLAR','SOLED','SOLID','SOLVE','SONIC','SORRY',
            'SORTS','SOUGHT','SOULS','SOUND','SOUTH','SPACE','SPADE','SPARE','SPARK','SPAWN',
            'SPEAK','SPEAR','SPECK','SPECS','SPEED','SPELL','SPEND','SPENT','SPICE','SPICY',
            'SPIED','SPIKE','SPIKY','SPILL','SPILT','SPINE','SPINY','SPIRE','SPITE','SPLAT',
            'SPLIT','SPOIL','SPOKE','SPOON','SPORT','SPOTS','SPOUT','SPRAY','SPRIG','SPRIT',
            'SPROUT','SPRUCE','SPUD','SPUME','SPUNK','SPURN','SPURT','SQUAT','SQUID','STABS',
            'STACK','STAFF','STAGE','STAIN','STAIR','STAKE','STALE','STALK','STAMP','STAND',
            'STANK','STARE','STARK','STARS','START','STASH','STATE','STAYS','STEAD','STEAK',
            'STEAL','STEAM','STEEL','STEEP','STEER','STEMS','STEPS','STERN','STICK','STIFF',
            'STILL','STILT','STING','STINK','STINT','STOCK','STOIC','STOKE','STOMP','STONE',
            'STONY','STOOD','STOOL','STOOP','STORE','STORM','STORY','STOUT','STOVE','STRAP',
            'STRAW','STRAY','STRIP','STRUM','STRUNG','STRUT','STUCK','STUDY','STUFF','STUMP',
            'STUNG','STUNK','STUNT','STYLE','SUAVE','SUGAR','SUITE','SULKY','SUNNY','SUPER',
            'SURGE','SWAMP','SWANK','SWARM','SWATH','SWEAR','SWEAT','SWEEP','SWEET','SWELL',
            'SWEPT','SWIFT','SWIMS','SWINE','SWING','SWIPE','SWIRL','SWOON','SWOOP','SWORD',
            'SWORE','SWORN','SWUNG','TABLE','TABOO','TACIT','TACKY','TAILS','TAKEN','TAKER',
            'TALES','TALKS','TAMER','TANGY','TANKS','TARDY','TARPS','TASTE','TASTY','TAUNT',
            'TAWNY','TAXES','TEACH','TEAMS','TEARS','TEARY','TEASE','TEDDY','TEENS','TEETH',
            'TEMPO','TENDS','TENOR','TENSE','TENTH','TERMS','TEPID','TERRA','TERSE','TESTS',
            'THANK','THEFT','THEIR','THEME','THERE','THESE','THICK','THIEF','THIGH','THING',
            'THINK','THIRD','THORN','THOSE','THREE','THREW','THROB','THROW','THRUM','THUDS',
            'THUMB','THUMP','TIARA','TIDAL','TIGER','TIGHT','TILTS','TIMER','TIMES','TIMID',
            'TIPSY','TIRED','TITAN','TITLE','TOAST','TODAY','TONED','TONER','TONES','TONIC',
            'TOOLS','TOOTH','TOPIC','TORCH','TORSO','TOTAL','TOTEM','TOUCH','TOUGH','TOURS',
            'TOWEL','TOWER','TOWNS','TOXIC','TRACE','TRACK','TRACT','TRADE','TRAIL','TRAIN',
            'TRAIT','TRAMP','TRASH','TRAWL','TREAD','TREAT','TREND','TRIAL','TRIBE','TRICK',
            'TRIED','TRIKE','TRIMS','TRIOS','TRITE','TROLL','TROMP','TROOP','TROPE','TROTH',
            'TROTS','TROUT','TROVE','TROWEL','TRUCE','TRUCK','TRULY','TRUMP','TRUNK','TRUSS',
            'TRUST','TRUTH','TRYST','TULIP','TUMOR','TUNED','TUNER','TUNES','TUNIC','TURBO',
            'TURFS','TURNS','TUTOR','TWAIN','TWANG','TWEAK','TWEED','TWICE','TWIGS','TWINE',
            'TWIRL','TWIST','TYING','TYPED','TYPES','UDDER','ULCER','ULTRA','UMBRA','UNARM',
            'UNCAP','UNCLE','UNCUT','UNDER','UNDID','UNDUE','UNFED','UNFIT','UNHIP','UNION',
            'UNITE','UNITS','UNITY','UNLIT','UNMET','UNPIN','UNSAY','UNSET','UNTIE','UNTIL',
            'UNWED','UNWET','UNWIT','UNWON','UNZIP','UPPER','UPSET','URBAN','URGED','URINE',
            'USAGE','USHER','USING','USUAL','UTTER','VAGUE','VALET','VALID','VALOR','VALUE',
            'VALVE','VAPID','VAULT','VAUNT','VEILS','VEINS','VEINY','VENOM','VENUE','VERGE',
            'VERSE','VICAR','VIDEO','VIED','VIEWS','VIGIL','VIGOR','VIPER','VIRAL','VIRUS',
            'VISIT','VISOR','VISTA','VITAL','VIVID','VIXEN','VOCAL','VODKA','VOGUE','VOICE',
            'VOILA','VOMIT','VOTED','VOTER','VOUCH','VOWED','VOWEL','VULGAR','WACKY','WADER',
            'WAGED','WAGER','WAGES','WAGON','WAIST','WAKEN','WAKER','WALKS','WALTZ','WANDS',
            'WANTS','WARPS','WARTS','WARTY','WASHY','WASTE','WATCH','WATER','WAVED','WAVER',
            'WAVES','WAXEN','WAXY','WEAK','WEALD','WEALTH','WEARY','WEAVE','WEDGE','WEEDS',
            'WEEDY','WEEKS','WEIGH','WEIRD','WELCH','WELLS','WELSH','WENCH','WETLY','WHACK',
            'WHALE','WHARF','WHEAT','WHEEL','WHERE','WHICH','WHIFF','WHILE','WHIMS','WHINE',
            'WHINY','WHIPS','WHIRL','WHISK','WHITE','WHOLE','WHOMP','WHOSE','WIDEN','WIDER',
            'WIDOW','WIDTH','WIELD','WILES','WILLS','WIMPY','WINCE','WINCH','WINDS','WINDY',
            'WINES','WINGS','WINKS','WIPED','WIPER','WIRED','WIRES','WISER','WISPS','WISPY',
            'WITCH','WITTY','WIVES','WOKEN','WOMAN','WOMEN','WOODS','WOODY','WORDS','WORDY',
            'WORKS','WORLD','WORMS','WORMY','WORRY','WORSE','WORST','WORTH','WOULD','WOUND',
            'WOVEN','WRATH','WREAK','WRECK','WREST','WRING','WRIST','WRITE','WRONG','WROTE',
            'YACHT','YARDS','YARNS','YAWNS','YEARN','YEARS','YEAST','YIELD','YOUNG','YOURS',
            'YOUTH','ZEBRA','ZESTY','ZILCH','ZINCS','ZONAL','ZONES'
        ].filter(function(w) { return hasUniqueLetters(w); });

        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            saveSoundEnabled(state.soundEnabled);
            if (state.soundEnabled) playSound('click');
            render();
        }

        function hasUniqueLetters(word) {
            var alphabet = getAlphabet();
            var letters = {};
            for (var i = 0; i < word.length; i++) {
                var char = word[i].toUpperCase();
                if (alphabet.indexOf(char) === -1) return false;
                if (letters[char]) return false;
                letters[char] = true;
            }
            return true;
        }

        function sanitizeWord(word) {
            var alphabet = getAlphabet();
            return word.toUpperCase().split('').filter(function(c) { return alphabet.indexOf(c) !== -1; }).join('');
        }

        function checkWord(word) {
            var type = (langData && langData.config && langData.config.dictionaryType) || 'english';
            if (type === 'wiktionary') {
                // For German, just check if word is in our list (Wiktionary API is unreliable)
                var words = getWords();
                if (words && words.indexOf(word.toUpperCase()) !== -1) {
                    return Promise.resolve(true);
                }
                // If not in list, try Wiktionary as fallback
                return fetch('https://' + currentLang + '.wiktionary.org/w/api.php?action=query&titles=' + encodeURIComponent(word.toLowerCase()) + '&format=json&origin=*')
                    .then(function(r) { return r.json(); })
                    .then(function(d) { return Object.keys(d.query.pages)[0] !== '-1'; })
                    .catch(function() { return true; });
            }
            // For English, try Dictionary API first, fall back to cached word list for offline support
            return fetch('https://api.dictionaryapi.dev/api/v2/entries/en/' + word.toLowerCase())
                .then(function(r) { return r.ok; })
                .catch(function() {
                    // If API fails (offline), check cached word list
                    var words = getWords();
                    if (words && words.indexOf(word.toUpperCase()) !== -1) {
                        return true;
                    }
                    return false;
                });
        }

        function shareGame(url) {
            var text = 'Join my 5letters game! ' + url;
            if (navigator.share) {
                navigator.share({ text: text })
                .then(function() { state.showShareModal = false; render(); })
                .catch(function(err) { 
                    // If share fails or cancelled, fall back to clipboard
                    copyToClipboard(url);
                });
            } else {
                copyToClipboard(url);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                state.message = 'Link copied to clipboard!';
                state.showShareModal = false;
                render();
            }).catch(function() {
                prompt('Copy this link to share:', text);
                state.showShareModal = false;
                render();
            });
        }

        function checkUrlForGame() {
            var urlParams = new URLSearchParams(window.location.search);
            var gameCode = urlParams.get('game');
            var langParam = urlParams.get('lang');
            if (gameCode) {
                state.gameId = gameCode.toUpperCase();
                state.message = 'Enter your name to join game ' + state.gameId;
                // Switch to the game's language if specified
                if (langParam && langParam !== currentLang) {
                    switchLanguage(langParam);
                }
            }
        }
        checkUrlForGame();

        function tryRejoinActiveGame() {
            var activeGame = loadActiveGame();
            if (activeGame && !state.gameId) {
                // Check if the game still exists and is not finished
                database.ref('games/' + activeGame.gameId).once('value').then(function(snapshot) {
                    if (snapshot.exists()) {
                        var game = snapshot.val();
                        var myPlayer = game.players[activeGame.playerId];
                        // Only rejoin if game exists, we're in it, and it's not over
                        if (myPlayer && !game.gameOver) {
                            state.gameId = activeGame.gameId;
                            state.playerId = activeGame.playerId;
                            sessionStorage.setItem('playerId', activeGame.playerId);
                            state.lastOpponentGuessCount = 0;
                            listenToGame(activeGame.gameId);
                            window.history.pushState({}, '', '?game=' + activeGame.gameId);
                        } else {
                            clearActiveGame();
                        }
                    } else {
                        clearActiveGame();
                    }
                });
            }
        }
        tryRejoinActiveGame();

        function showOpponentGuessBanner(guess, matchCount, opponentName, myWord) {
            var bannerEl = document.getElementById('banner');
            var matchingLetters = [];
            for (var i = 0; i < guess.length; i++) {
                if (myWord.indexOf(guess[i]) !== -1) matchingLetters.push(guess[i]);
            }
            var matchingLettersHtml = matchingLetters.length > 0 
                ? matchingLetters.map(function(l) { return '<span class="inline-block w-8 h-8 bg-white text-orange-600 rounded text-center leading-8 font-bold mx-1">' + l + '</span>'; }).join('')
                : '<span class="text-orange-200">None</span>';
            
            bannerEl.innerHTML = '<div onclick="dismissBanner()" class="fixed top-0 left-0 right-0 bg-gradient-to-r from-orange-500 to-red-500 text-white p-4 shadow-lg z-50 banner-enter cursor-pointer">' +
                '<div class="max-w-2xl mx-auto text-center">' +
                '<p class="font-bold text-lg mb-2">' + opponentName + ' guessed: <span class="tracking-widest bg-white/20 px-2 py-1 rounded">' + guess + '</span></p>' +
                '<p class="text-sm mb-2">Letters matching your word: ' + matchingLettersHtml + ' (' + matchCount + ' match' + (matchCount !== 1 ? 'es' : '') + ')</p>' +
                '<p class="font-semibold text-yellow-200">âš¡ ' + t('yourTurnNow') + '</p>' +
                '<p class="text-xs mt-2 text-orange-200">Tap to dismiss</p>' +
                '</div></div>';
            
            state.bannerTimeout = setTimeout(function() {
                dismissBanner();
            }, 5000);
        }

        function dismissBanner() {
            if (state.bannerTimeout) {
                clearTimeout(state.bannerTimeout);
                state.bannerTimeout = null;
            }
            var bannerEl = document.getElementById('banner');
            var banner = bannerEl.querySelector('div');
            if (banner) {
                banner.classList.remove('banner-enter');
                banner.classList.add('banner-exit');
                setTimeout(function() { bannerEl.innerHTML = ''; }, 300);
            }
        }

        function updateStats(won, guessCount) {
            state.stats.gamesPlayed++;
            if (won) {
                state.stats.gamesWon++;
                state.stats.currentStreak++;
                if (state.stats.currentStreak > state.stats.bestStreak) state.stats.bestStreak = state.stats.currentStreak;
                state.stats.totalGuesses += guessCount;
                if (!state.stats.quickestWin || guessCount < state.stats.quickestWin) state.stats.quickestWin = guessCount;
            } else {
                state.stats.gamesLost++;
                state.stats.currentStreak = 0;
            }
            saveStats(state.stats);
        }

        function createGame() {
            if (!state.playerName.trim()) { state.message = 'Please enter your name'; render(); return; }
            savePlayerName(state.playerName);
            var gameId = Math.random().toString(36).substr(2, 6).toUpperCase();
            var gameData = { players: {}, currentTurn: null, started: false, createdAt: Date.now(), gameOver: false, blitzMode: false, blitzModeRequestedBy: null, blitzModeAcceptedBy: [] };
            gameData.players[state.playerId] = {
                name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
            };
            database.ref('games/' + gameId).set(gameData).then(function() {
                state.gameId = gameId;
                state.showShareModal = true;
                state.message = '';
                state.lastOpponentGuessCount = 0;
                saveActiveGame(gameId, state.playerId);
                listenToGame(gameId);
                window.history.pushState({}, '', '?game=' + gameId);
                logEvent('game_created', { mode: 'multiplayer' });
                render();
            }).catch(function(error) { state.message = 'Error creating game: ' + error.message; render(); });
        }

        function joinGame() {
            if (!state.playerName.trim()) { state.message = 'Please enter your name'; render(); return; }
            savePlayerName(state.playerName);
            state.gameId = state.gameId.toUpperCase();
            var gameId = state.gameId;
            database.ref('games/' + gameId).once('value').then(function(snapshot) {
                if (!snapshot.exists()) { state.message = 'Game not found'; render(); return; }
                var game = snapshot.val();
                if (game.players[state.playerId]) {
                    state.message = 'Rejoined game';
                    state.lastOpponentGuessCount = 0;
                    saveActiveGame(gameId, state.playerId);
                    listenToGame(gameId);
                    render();
                    return;
                }
                if (Object.keys(game.players).length >= 2) { state.message = 'Game is full'; render(); return; }
                database.ref('games/' + gameId + '/players/' + state.playerId).set({
                    name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                    guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
                }).then(function() {
                    state.message = 'Joined game! Choose your secret word.';
                    state.lastOpponentGuessCount = 0;
                    saveActiveGame(gameId, state.playerId);
                    listenToGame(gameId);
                    logEvent('game_joined', { mode: 'multiplayer' });
                    render();
                }).catch(function(error) { state.message = 'Error joining game: ' + error.message; render(); });
            }).catch(function(error) { state.message = 'Error finding game: ' + error.message; render(); });
        }

        var prevGameState = null;
        
        function shouldSkipRender(oldState, newState) {
            if (!oldState || !newState) return false;
            if (!oldState.players || !newState.players) return false;
            
            // Find opponent ID
            var opponentId = Object.keys(newState.players).find(function(id) { return id !== state.playerId; });
            if (!opponentId) return false;
            
            // Create copies without opponent's letterStates and confirmedLetters for comparison
            var dominated = ['letterStates', 'confirmedLetters'];
            
            // Check if anything OTHER than opponent's letterStates/confirmedLetters changed
            // Compare top-level game properties
            if (oldState.started !== newState.started) return false;
            if (oldState.currentTurn !== newState.currentTurn) return false;
            if (oldState.gameOver !== newState.gameOver) return false;
            if (Object.keys(oldState.players).length !== Object.keys(newState.players).length) return false;
            
            // Check each player
            for (var pid in newState.players) {
                var oldPlayer = oldState.players[pid];
                var newPlayer = newState.players[pid];
                if (!oldPlayer) return false; // New player joined
                
                // For opponent, skip letterStates and confirmedLetters
                if (pid === opponentId) {
                    if (oldPlayer.word !== newPlayer.word) return false;
                    if (oldPlayer.wordSet !== newPlayer.wordSet) return false;
                    if (oldPlayer.won !== newPlayer.won) return false;
                    if (oldPlayer.name !== newPlayer.name) return false;
                    if (JSON.stringify(oldPlayer.guesses || []) !== JSON.stringify(newPlayer.guesses || [])) return false;
                } else {
                    // For my player, check everything
                    if (JSON.stringify(oldPlayer) !== JSON.stringify(newPlayer)) return false;
                }
            }
            
            // If we get here, only opponent's letterStates/confirmedLetters changed
            return true;
        }
        
        function listenToGame(gameId) {
            database.ref('games/' + gameId).on('value', function(snapshot) {
                if (snapshot.exists()) {
                    var newGameState = snapshot.val();
                    var skipRender = shouldSkipRender(prevGameState, newGameState);
                    
                    prevGameState = JSON.parse(JSON.stringify(newGameState)); // Deep copy for next comparison
                    state.gameState = newGameState;
                    var myPlayer = state.gameState.players[state.playerId];
                    if (myPlayer) state.confirmedLetters = myPlayer.confirmedLetters || [];
                    
                    var opponentId = Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; });
                    if (opponentId && state.gameState.players[opponentId]) {
                        var opponent = state.gameState.players[opponentId];
                        var opponentGuesses = opponent.guesses || [];
                        if (opponentGuesses.length > state.lastOpponentGuessCount && state.lastOpponentGuessCount > 0) {
                            var latestGuess = opponentGuesses[opponentGuesses.length - 1];
                            if (myPlayer && myPlayer.word) showOpponentGuessBanner(latestGuess.word, latestGuess.matches, opponent.name, myPlayer.word);
                        }
                        state.lastOpponentGuessCount = opponentGuesses.length;
                    }
                    
                    if (myPlayer && !myPlayer.statsRecorded) {
                        var opponent = opponentId ? state.gameState.players[opponentId] : null;
                        if (myPlayer.won) {
                            updateStats(true, myPlayer.guesses.length);
                            var gameRecord = {
                                date: Date.now(),
                                opponent: opponent ? opponent.name : 'Unknown',
                                won: true,
                                guesses: myPlayer.guesses.length,
                                myWord: myPlayer.word,
                                theirWord: opponent ? opponent.word : '',
                                guessData: myPlayer.guesses.slice(-3)
                            };
                            saveGameToHistory(gameRecord);
                            state.lastGameResult = gameRecord;
                            logEvent('game_completed', { mode: 'multiplayer', won: true, guesses: myPlayer.guesses.length });
                            database.ref('games/' + gameId + '/players/' + state.playerId + '/statsRecorded').set(true);
                        } else if (opponentId && state.gameState.players[opponentId].won) {
                            updateStats(false, 0);
                            var gameRecord = {
                                date: Date.now(),
                                opponent: opponent ? opponent.name : 'Unknown',
                                won: false,
                                guesses: myPlayer.guesses ? myPlayer.guesses.length : 0,
                                myWord: myPlayer.word,
                                theirWord: opponent ? opponent.word : '',
                                guessData: myPlayer.guesses ? myPlayer.guesses.slice(-3) : []
                            };
                            saveGameToHistory(gameRecord);
                            state.lastGameResult = gameRecord;
                            logEvent('game_completed', { mode: 'multiplayer', won: false, guesses: myPlayer.guesses ? myPlayer.guesses.length : 0 });
                            playSound('lose'); haptic('heavy');
                            database.ref('games/' + gameId + '/players/' + state.playerId + '/statsRecorded').set(true);
                        }
                    }
                    
                    if (!skipRender) render();
                }
            });
        }

        function setSecretWord() {
            var word = sanitizeWord(state.myWord);
            if (word.length !== 5) { state.message = t('wordMustBe5'); playSound('error'); haptic('error'); render(); return; }
            if (!hasUniqueLetters(word)) { state.message = t('uniqueLetters'); playSound('error'); haptic('error'); render(); return; }
            state.message = '';
            checkWord(word).then(function(isValid) {
                if (!isValid) { state.message = t('notValidWord'); playSound('error'); haptic('error'); render(); return; }
                playSound('success'); haptic('success');
                database.ref('games/' + state.gameId + '/players/' + state.playerId).update({ word: word, wordSet: true }).then(function() {
                    database.ref('games/' + state.gameId).once('value').then(function(snapshot) {
                        var game = snapshot.val();
                        var playerCount = Object.keys(game.players).length;
                        var allWordsSet = Object.values(game.players).every(function(p) { return p.wordSet; });
                        if (playerCount === 2 && allWordsSet && !game.started) {
                            var firstPlayer = Object.keys(game.players)[0];
                            database.ref('games/' + state.gameId).update({ started: true, currentTurn: firstPlayer });
                        }
                    });
                    state.myWord = '';
                    state.message = 'Word set! Waiting for game to start...';
                    render();
                }).catch(function(error) { state.message = 'Error setting word: ' + error.message; render(); });
            });
        }

        function makeGuess() {
            var guess = sanitizeWord(state.currentGuess);
            if (guess.length !== 5) { state.message = t('guessMustBe5'); playSound('error'); haptic('error'); render(); return; }
            if (!hasUniqueLetters(guess)) { state.message = t('uniqueLetters'); playSound('error'); haptic('error'); render(); return; }
            state.message = '';
            checkWord(guess).then(function(isValid) {
                if (!isValid) { state.message = t('notValidWord'); playSound('error'); haptic('error'); render(); return; }
                var opponentId = Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; });
                if (!opponentId || !state.gameState.players[opponentId].wordSet) { state.message = 'Waiting for opponent'; render(); return; }
                var opponentWord = state.gameState.players[opponentId].word;
                var matchCount = 0;
                for (var i = 0; i < guess.length; i++) { if (opponentWord.indexOf(guess[i]) !== -1) matchCount++; }
                var isWin = guess === opponentWord;
                var newGuess = { word: guess, matches: matchCount, timestamp: Date.now() };
                var myGuesses = state.gameState.players[state.playerId].guesses || [];
                myGuesses.push(newGuess);
                var updates = {};
                updates['games/' + state.gameId + '/players/' + state.playerId + '/guesses'] = myGuesses;
                if (isWin) {
                    updates['games/' + state.gameId + '/players/' + state.playerId + '/won'] = true;
                    updates['games/' + state.gameId + '/gameOver'] = true;
                    state.message = 'ðŸŽ‰ You won!';
                    playSound('win'); haptic('success'); showConfetti();
                } else {
                    // Only switch turns if not in blitz mode
                    if (!state.gameState.blitzMode) {
                        updates['games/' + state.gameId + '/currentTurn'] = opponentId;
                    }
                    if (matchCount > 0) { playSound('match'); haptic('medium'); }
                    else { playSound('click'); haptic('light'); }
                }
                database.ref().update(updates).catch(function(error) { state.message = 'Error: ' + error.message; render(); });
                state.currentGuess = '';
                render();
            });
        }

        function requestBlitzMode() {
            if (!state.gameState || !state.gameState.started) { return; }
            var opponentId = Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; });
            if (!opponentId) { return; }

            database.ref('games/' + state.gameId).update({
                blitzModeRequestedBy: state.playerId
            });
            playSound('click'); haptic('light');
        }

        function acceptBlitzMode() {
            if (!state.gameState) { return; }
            var acceptedBy = state.gameState.blitzModeAcceptedBy || [];
            acceptedBy.push(state.playerId);

            database.ref('games/' + state.gameId).update({
                blitzModeAcceptedBy: acceptedBy,
                blitzMode: true,
                blitzModeRequestedBy: null
            });
            playSound('match'); haptic('success');
        }

        function declineBlitzMode() {
            if (!state.gameState) { return; }

            database.ref('games/' + state.gameId).update({
                blitzModeRequestedBy: null
            });
            playSound('error'); haptic('light');
        }

        function startRematch() {
            // Get current game info for rematch
            var currentGameId = state.gameId;
            var opponentId = state.gameState ? Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; }) : null;
            var opponentName = opponentId && state.gameState.players[opponentId] ? state.gameState.players[opponentId].name : null;
            
            // Check if there's already a rematch game created by opponent
            if (state.gameState && state.gameState.rematchGameId) {
                // Join the existing rematch game
                var rematchId = state.gameState.rematchGameId;
                database.ref('games/' + state.gameId).off('value');
                clearActiveGame();
                state.gameState = null;
                state.myWord = '';
                state.currentGuess = '';
                state.message = '';
                state.confirmedLetters = [];
                state.lastOpponentGuessCount = 0;
                state.lastGameResult = null;
                state.gameId = rematchId;
                
                // Join the rematch game
                database.ref('games/' + rematchId).once('value').then(function(snapshot) {
                    if (snapshot.exists()) {
                        var game = snapshot.val();
                        if (!game.players[state.playerId]) {
                            // Add ourselves to the rematch game
                            database.ref('games/' + rematchId + '/players/' + state.playerId).set({
                                name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                                guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
                            }).then(function() {
                                saveActiveGame(rematchId, state.playerId);
                                listenToGame(rematchId);
                                window.history.pushState({}, '', '?game=' + rematchId);
                            });
                        } else {
                            // Already in game, just listen
                            saveActiveGame(rematchId, state.playerId);
                            listenToGame(rematchId);
                            window.history.pushState({}, '', '?game=' + rematchId);
                        }
                    }
                });
                return;
            }
            
            // Create new rematch game and store ID in old game
            var newGameId = Math.random().toString(36).substr(2, 6).toUpperCase();
            var gameData = { 
                players: {}, 
                currentTurn: null, 
                started: false, 
                createdAt: Date.now(), 
                gameOver: false,
                isRematch: true,
                previousGameId: currentGameId
            };
            gameData.players[state.playerId] = {
                name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
            };
            
            // Create new game and update old game with rematch ID
            database.ref('games/' + newGameId).set(gameData).then(function() {
                // Store rematch game ID in old game so opponent can find it
                database.ref('games/' + currentGameId + '/rematchGameId').set(newGameId);
                
                database.ref('games/' + currentGameId).off('value');
                clearActiveGame();
                state.gameState = null;
                state.myWord = '';
                state.currentGuess = '';
                state.confirmedLetters = [];
                state.lastOpponentGuessCount = 0;
                state.lastGameResult = null;
                state.gameId = newGameId;
                state.message = opponentName ? 'Rematch created! Waiting for ' + opponentName + '...' : '';
                saveActiveGame(newGameId, state.playerId);
                listenToGame(newGameId);
                window.history.pushState({}, '', '?game=' + newGameId);
                render();
            });
        }

        function cancelGame() {
            if (state.gameState) {
                database.ref('games/' + state.gameId).off('value');
            }
            clearActiveGame();
            state.gameState = null;
            state.myWord = '';
            state.currentGuess = '';
            state.message = '';
            state.confirmedLetters = [];
            state.lastOpponentGuessCount = 0;
            state.gameId = '';
            state.singlePlayer = null;
            state.showQuitConfirm = false;
            state.showShareModal = false;
            window.history.pushState({}, '', window.location.pathname);
            render();
        }

        function confirmQuit() {
            state.showQuitConfirm = true;
            render();
        }

        // Get today's daily word (same for all players)
        function getDailyWord(validWords) {
            // Get today's date string (YYYY-MM-DD in UTC)
            var now = new Date();
            var dateStr = now.getUTCFullYear() + '-' +
                         String(now.getUTCMonth() + 1).padStart(2, '0') + '-' +
                         String(now.getUTCDate()).padStart(2, '0');

            // Simple hash function for the date to get a seed
            var hash = 0;
            for (var i = 0; i < dateStr.length; i++) {
                hash = ((hash << 5) - hash) + dateStr.charCodeAt(i);
                hash = hash & hash; // Convert to 32-bit integer
            }

            // Use the hash to select a word deterministically
            var index = Math.abs(hash) % validWords.length;
            return validWords[index];
        }

        // Get formatted date for sharing (e.g., "1st Jan")
        function getFormattedDate() {
            var now = new Date();
            var day = now.getUTCDate();
            var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            var month = months[now.getUTCMonth()];

            // Add ordinal suffix
            var suffix = 'th';
            if (day === 1 || day === 21 || day === 31) suffix = 'st';
            else if (day === 2 || day === 22) suffix = 'nd';
            else if (day === 3 || day === 23) suffix = 'rd';

            return day + suffix + ' ' + month;
        }

        function startSinglePlayer() {
            var words = getWords() || WORD_LIST;
            // Filter to only words with unique letters
            var validWords = words.filter(function(w) { return hasUniqueLetters(w); });

            // Check if this is the player's first game today
            var lastDailyWord = localStorage.getItem('lastDailyWord');
            var lastDailyDate = localStorage.getItem('lastDailyDate');
            var today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            var isDailyWordGame = !lastDailyWord || lastDailyDate !== today;

            var selectedWord;
            if (isDailyWordGame) {
                // First game of the day - use daily word
                selectedWord = getDailyWord(validWords);
                localStorage.setItem('lastDailyWord', selectedWord);
                localStorage.setItem('lastDailyDate', today);
            } else {
                // Subsequent games - use random word
                selectedWord = validWords[Math.floor(Math.random() * validWords.length)];
            }

            state.singlePlayer = {
                secretWord: selectedWord,
                guesses: [],
                letterStates: {},
                confirmedLetters: [],
                gameOver: false,
                won: false,
                isDailyWord: isDailyWordGame
            };
            state.currentGuess = '';
            state.message = '';
            logEvent('game_started', { mode: 'solo', isDailyWord: isDailyWordGame });
            render();
        }

        function makeSinglePlayerGuess() {
            var guess = sanitizeWord(state.currentGuess);
            if (guess.length !== 5) { state.message = t('guessMustBe5'); playSound('error'); haptic('error'); render(); return; }
            if (!hasUniqueLetters(guess)) { state.message = t('uniqueLetters'); playSound('error'); haptic('error'); render(); return; }
            state.message = '';
            checkWord(guess).then(function(isValid) {
                if (!isValid) { state.message = t('notValidWord'); playSound('error'); haptic('error'); render(); return; }
                
                var secretWord = state.singlePlayer.secretWord;
                var matchCount = 0;
                for (var i = 0; i < guess.length; i++) { 
                    if (secretWord.indexOf(guess[i]) !== -1) matchCount++; 
                }
                var isWin = guess === secretWord;
                
                state.singlePlayer.guesses.push({ word: guess, matches: matchCount, timestamp: Date.now() });
                state.currentGuess = '';
                
                if (isWin) {
                    state.singlePlayer.gameOver = true;
                    state.singlePlayer.won = true;
                    playSound('win'); haptic('success'); showConfetti();
                    // Save to history
                    var gameRecord = {
                        date: Date.now(),
                        opponent: 'Computer',
                        won: true,
                        guesses: state.singlePlayer.guesses.length,
                        myWord: '-',
                        theirWord: secretWord,
                        guessData: state.singlePlayer.guesses.slice(-3), // Last 3 guesses for sharing
                        isDailyWord: state.singlePlayer.isDailyWord
                    };
                    saveGameToHistory(gameRecord);
                    updateStats(true, state.singlePlayer.guesses.length);
                    state.lastGameResult = gameRecord;
                    logEvent('game_completed', { mode: 'solo', won: true, guesses: state.singlePlayer.guesses.length });
                } else {
                    if (matchCount > 0) { playSound('match'); haptic('medium'); }
                    else { playSound('click'); haptic('light'); }
                }
                render();
            });
        }

        function toggleSinglePlayerLetter(letter, longPress) {
            var sp = state.singlePlayer;
            var currentState = sp.letterStates[letter];
            
            if (longPress) {
                if (currentState !== 'included' && sp.confirmedLetters.length >= 5) { 
                    state.message = 'Maximum 5 letters'; haptic('error'); render(); return; 
                }
                var newState = currentState === 'included' ? null : 'included';
                sp.letterStates[letter] = newState;
                if (newState === 'included' && sp.confirmedLetters.indexOf(letter) === -1) {
                    sp.confirmedLetters.push(letter);
                } else if (newState === null) {
                    var idx = sp.confirmedLetters.indexOf(letter);
                    if (idx > -1) sp.confirmedLetters.splice(idx, 1);
                }
                haptic('medium');
            } else {
                if (currentState === 'included') {
                    sp.letterStates[letter] = null;
                    var idx = sp.confirmedLetters.indexOf(letter);
                    if (idx > -1) sp.confirmedLetters.splice(idx, 1);
                } else {
                    sp.letterStates[letter] = currentState === 'excluded' ? null : 'excluded';
                }
                haptic('light');
            }
            render();
        }

        function giveUpSinglePlayer() {
            state.singlePlayer.gameOver = true;
            state.singlePlayer.won = false;
            playSound('lose'); haptic('heavy');
            // Save to history
            var gameRecord = {
                date: Date.now(),
                opponent: 'Computer',
                won: false,
                guesses: state.singlePlayer.guesses.length,
                myWord: '-',
                theirWord: state.singlePlayer.secretWord,
                guessData: state.singlePlayer.guesses.slice(-3),
                isDailyWord: state.singlePlayer.isDailyWord
            };
            saveGameToHistory(gameRecord);
            updateStats(false, 0);
            state.lastGameResult = gameRecord;
            logEvent('game_completed', { mode: 'solo', won: false, guesses: state.singlePlayer.guesses.length, gaveUp: true });
            render();
        }

        function shareResult() {
            if (!state.lastGameResult) return;
            var result = state.lastGameResult;
            
            // Build grid with letters for last 3 guesses (red/green like in-game alphabet)
            // Reverse order so most recent is at top
            var guessGrid = '';
            if (result.guessData && result.guessData.length > 0) {
                var secretWord = result.theirWord;
                var guesses = result.guessData.slice().reverse(); // Copy and reverse
                guesses.forEach(function(guess, idx) {
                    var isWinningGuess = (idx === 0) && result.won; // First in reversed = most recent
                    var line = '';
                    for (var i = 0; i < guess.word.length; i++) {
                        var letter = guess.word[i];
                        if (isWinningGuess) {
                            // Winning guess - all green
                            line += 'ðŸŸ©';
                        } else if (secretWord.indexOf(letter) !== -1) {
                            // Letter is in the word - green
                            line += 'ðŸŸ©';
                        } else {
                            // Letter not in word - red
                            line += 'ðŸŸ¥';
                        }
                    }
                    // For daily word, don't include guess words (spoilers!)
                    if (result.isDailyWord) {
                        guessGrid += line + ' ' + guess.matches + '\n';
                    } else {
                        guessGrid += guess.word + ' ' + line + ' ' + guess.matches + '\n';
                    }
                });
            }
            
            var header;
            if (result.isDailyWord) {
                // Special format for daily word
                var formattedDate = getFormattedDate();
                var guessText = result.guesses === 1 ? 'guess' : 'guesses';
                header = "Today's 5letters " + formattedDate + ' - ' + result.guesses + ' ' + guessText;
            } else {
                // Regular format for other games
                var opponentText = result.opponent === 'Computer' ? '' : ' against ' + result.opponent;
                header = result.won
                    ? 'ðŸŽ‰ I won at 5letters in ' + result.guesses + ' guesses' + opponentText + '!'
                    : 'ðŸ˜… I lost at 5letters after ' + result.guesses + ' guesses' + opponentText;
            }

            var text = header + '\n\n' + guessGrid + '\nhttps://5letters.fun';
            
            if (navigator.share) {
                // On mobile, use share API with just text (URL in text already)
                navigator.share({ text: text })
                    .catch(function(e) { console.log('Share cancelled'); });
            } else {
                // On desktop, copy to clipboard
                navigator.clipboard.writeText(text).then(function() {
                    state.message = 'Result copied to clipboard!';
                    render();
                }).catch(function() {
                    prompt('Copy this to share:', text);
                });
            }
        }

        function toggleLetterState(letter, longPress) {
            var currentStates = state.gameState.players[state.playerId].letterStates || {};
            var currentConfirmed = state.gameState.players[state.playerId].confirmedLetters || [];
            var currentState = currentStates[letter];
            if (longPress) {
                if (currentState !== 'included' && currentConfirmed.length >= 5) { state.message = 'Maximum 5 letters'; haptic('error'); render(); return; }
                var newState = currentState === 'included' ? null : 'included';
                currentStates[letter] = newState;
                if (newState === 'included' && currentConfirmed.indexOf(letter) === -1) currentConfirmed.push(letter);
                else if (newState === null) { var idx = currentConfirmed.indexOf(letter); if (idx > -1) currentConfirmed.splice(idx, 1); }
                haptic('medium');
            } else {
                if (currentState === 'included') {
                    currentStates[letter] = null;
                    var idx = currentConfirmed.indexOf(letter);
                    if (idx > -1) currentConfirmed.splice(idx, 1);
                } else {
                    currentStates[letter] = currentState === 'excluded' ? null : 'excluded';
                }
                haptic('light');
            }
            database.ref('games/' + state.gameId + '/players/' + state.playerId).update({
                letterStates: currentStates, confirmedLetters: currentConfirmed
            }).catch(function(error) { state.message = 'Error: ' + error.message; render(); });
        }

        function render() {
            var app = document.getElementById('app');
            var modals = '';
            
            if (state.showInstructions) {
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">' +
                    '<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">' + t('howToPlayTitle') + '</h2>' +
                    '<div class="space-y-4 text-gray-700">' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">1</span><p>' + t('rule1') + '</p></div>' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">2</span><p>' + t('rule2') + '</p></div>' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">3</span><p>' + t('rule3') + '</p></div>' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">4</span><p>' + t('rule4') + '</p></div>' +
                    '<div class="border-t pt-4 mt-4"><p class="font-semibold mb-2">' + t('tips') + '</p>' +
                    '<ul class="list-disc list-inside space-y-1 text-sm">' +
                    '<li>' + t('tip1') + '</li>' +
                    '<li>' + t('tip2') + '</li>' +
                    '</ul></div></div>' +
                    '<button onclick="state.showInstructions = false; markInstructionsSeen(); render()" class="w-full mt-6 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">' + t('gotIt') + '</button>' +
                    '</div></div>';
            }

            if (state.showQuitConfirm) {
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                    '<h3 class="text-xl font-bold text-gray-800 mb-4 text-center">' + t('quitGame') + '</h3>' +
                    '<p class="text-gray-600 mb-6 text-center">' + t('quitConfirm') + '</p>' +
                    '<div class="flex gap-3">' +
                    '<button onclick="state.showQuitConfirm = false; render()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">' + t('cancel') + '</button>' +
                    '<button onclick="cancelGame()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition">' + t('quit') + '</button>' +
                    '</div></div></div>';
            }

            // Show blitz mode request dialog if opponent requested it
            if (state.gameState && state.gameState.blitzModeRequestedBy && state.gameState.blitzModeRequestedBy !== state.playerId && !state.gameState.blitzMode) {
                var requesterName = state.gameState.players[state.gameState.blitzModeRequestedBy] ? state.gameState.players[state.gameState.blitzModeRequestedBy].name : 'Opponent';
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                    '<div class="text-center mb-4"><div class="inline-block p-3 bg-orange-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" class="text-orange-600"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg></div></div>' +
                    '<h3 class="text-xl font-bold text-gray-800 mb-2 text-center">Blitz Mode Request</h3>' +
                    '<p class="text-gray-600 mb-4 text-center"><strong>' + requesterName + '</strong> wants to play in Blitz Mode!</p>' +
                    '<div class="bg-orange-50 rounded-lg p-3 mb-4 text-sm text-gray-700"><p class="mb-2">âš¡ <strong>Blitz Mode:</strong> Both players can guess simultaneously without waiting for turns.</p>' +
                    '<p class="text-xs text-gray-600">Race to guess your opponent\'s word first!</p></div>' +
                    '<div class="flex gap-3">' +
                    '<button onclick="declineBlitzMode()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">Decline</button>' +
                    '<button onclick="acceptBlitzMode()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition">Accept</button>' +
                    '</div></div></div>';
            }

            if (state.showStats) {
                var stats = state.stats;
                var winRate = stats.gamesPlayed > 0 ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100) : 0;
                var avgGuesses = stats.gamesWon > 0 ? (stats.totalGuesses / stats.gamesWon).toFixed(1) : '-';
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                    '<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">' + t('yourStats') + '</h2>' +
                    '<div class="grid grid-cols-2 gap-4 mb-4">' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-purple-600">' + stats.gamesPlayed + '</div><div class="text-xs text-gray-600">' + t('gamesPlayed') + '</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-green-600">' + winRate + '%</div><div class="text-xs text-gray-600">' + t('winRate') + '</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-orange-600">' + stats.currentStreak + '</div><div class="text-xs text-gray-600">' + t('currentStreak') + '</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-red-600">' + stats.bestStreak + '</div><div class="text-xs text-gray-600">' + t('bestStreak') + '</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-blue-600">' + avgGuesses + '</div><div class="text-xs text-gray-600">' + t('avgGuesses') + '</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-indigo-600">' + (stats.quickestWin || '-') + '</div><div class="text-xs text-gray-600">' + t('quickestWin') + '</div></div>' +
                    '</div>' +
                    '<button onclick="state.showStats = false; state.showHistory = true; render()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition mb-2">' + t('viewHistory') + '</button>' +
                    '<button onclick="state.showStats = false; render()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">' + t('close') + '</button>' +
                    '</div></div>';
            }

            if (state.showHistory) {
                var history = loadGameHistory();
                var historyHtml = '';
                if (history.length === 0) {
                    historyHtml = '<p class="text-gray-500 text-center py-4">' + t('noGamesYet') + '</p>';
                } else {
                    history.forEach(function(game) {
                        var date = new Date(game.date);
                        var dateStr = date.toLocaleDateString();
                        var resultClass = game.won ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300';
                        var resultText = game.won ? t('wonIn') + ' ' + game.guesses : t('lost');
                        historyHtml += '<div class="' + resultClass + ' border rounded-lg p-3 mb-2">' +
                            '<div class="flex justify-between items-center">' +
                            '<div><span class="font-semibold">vs ' + game.opponent + '</span>' +
                            '<span class="text-xs text-gray-500 ml-2">' + dateStr + '</span></div>' +
                            '<span class="text-sm font-bold">' + resultText + '</span></div>' +
                            '<div class="text-xs text-gray-600 mt-1">' + t('yourWord') + ' ' + game.myWord + ' Â· ' + t('theirWord') + ' ' + game.theirWord + '</div>' +
                            '</div>';
                    });
                }
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full max-h-[80vh] overflow-y-auto">' +
                    '<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">' + t('gameHistory') + '</h2>' +
                    '<div class="mb-4">' + historyHtml + '</div>' +
                    '<button onclick="state.showHistory = false; render()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">' + t('close') + '</button>' +
                    '</div></div>';
            }

            // Single Player Mode rendering
            if (state.singlePlayer) {
                var sp = state.singlePlayer;
                var letterStates = sp.letterStates || {};
                var confirmedLetters = sp.confirmedLetters || [];

                var circlePositions = [];
                for (var i = 0; i < 5; i++) {
                    var angle = (i * 72 - 90) * (Math.PI / 180);
                    var x = 77 + 56 * Math.cos(angle);
                    var y = 77 + 56 * Math.sin(angle);
                    circlePositions.push({ x: x, y: y, letter: confirmedLetters[i] || '' });
                }
                var circleSvg = '';
                for (var i = 0; i < circlePositions.length; i++) {
                    var pos = circlePositions[i];
                    circleSvg += '<g><circle cx="' + pos.x + '" cy="' + pos.y + '" r="14" fill="' + (pos.letter ? '#22c55e' : '#f3f4f6') + '" stroke="#d1d5db" stroke-width="2"/>' +
                        '<text x="' + pos.x + '" y="' + pos.y + '" text-anchor="middle" dy="5" font-size="14" font-weight="bold" fill="' + (pos.letter ? 'white' : '#9ca3af') + '">' + pos.letter + '</text></g>';
                }

                var alphabetHtml = '';
                for (var i = 0; i < getAlphabet().length; i++) {
                    var letter = getAlphabet()[i];
                    var lState = letterStates[letter];
                    var btnClass = lState === 'excluded' ? 'bg-red-500 text-white line-through' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300';
                    alphabetHtml += '<button data-letter="' + letter + '" data-sp="true" class="sp-letter-btn w-9 h-9 rounded font-bold text-base transition ' + btnClass + '">' + letter + '</button>';
                }

                var guessesHtml = '';
                if (sp.guesses && sp.guesses.length > 0) {
                    for (var i = sp.guesses.length - 1; i >= 0; i--) {
                        var guess = sp.guesses[i];
                        var coloredWord = '';
                        for (var j = 0; j < guess.word.length; j++) {
                            var letter = guess.word[j];
                            var lState = letterStates[letter];
                            var letterClass = lState === 'excluded' ? 'bg-red-500 text-white' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-800';
                            coloredWord += '<span class="inline-block w-7 h-7 rounded text-center leading-7 font-bold text-sm ' + letterClass + '">' + letter + '</span>';
                        }
                        var isNewest = (i === sp.guesses.length - 1);
                        guessesHtml += '<div class="bg-gray-100 rounded-lg p-2 flex justify-between items-center' + (isNewest ? ' guess-row' : '') + '"><div class="flex gap-0.5">' + coloredWord + '</div>' +
                            '<span class="bg-purple-500 text-white px-2 py-0.5 rounded-full text-sm font-bold">' + guess.matches + '</span></div>';
                    }
                } else {
                    guessesHtml = '<div class="text-gray-400 text-center py-4 text-sm">' + t('noGuessesYet') + '</div>';
                }

                var gameEndBanner = '';
                if (sp.gameOver) {
                    if (sp.won) {
                        gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 shadow-lg z-50">' +
                            '<div class="max-w-2xl mx-auto text-center">' +
                            '<h2 class="text-2xl font-bold mb-1">' + t('youWon') + '</h2>' +
                            '<p class="text-sm mb-3">' + t('guessedIn') + ' ' + sp.guesses.length + '' + t('tries') + ' ' + t('theWordWas') + ' ' + sp.secretWord + '</p>' +
                            '<div class="flex justify-center gap-2">' +
                            '<button onclick="shareResult()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">' + t('share') + '</button>' +
                            '<button onclick="startSinglePlayer()" class="bg-white text-green-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">' + t('playAgain') + '</button>' +
                            '<button onclick="cancelGame()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">' + t('home') + '</button>' +
                            '</div></div></div>';
                    } else {
                        gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-red-500 to-rose-600 text-white p-4 shadow-lg z-50">' +
                            '<div class="max-w-2xl mx-auto text-center">' +
                            '<h2 class="text-2xl font-bold mb-1">' + t('gameOver') + '</h2>' +
                            '<p class="text-sm mb-3">' + t('theWordWas') + ': <span class="font-bold">' + sp.secretWord + '</span></p>' +
                            '<div class="flex justify-center gap-2">' +
                            '<button onclick="startSinglePlayer()" class="bg-white text-red-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">' + t('tryAgain') + '</button>' +
                            '<button onclick="cancelGame()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">' + t('home') + '</button>' +
                            '</div></div></div>';
                    }
                }

                var circleSection = state.circleExpanded 
                    ? '<div class="mb-3"><button onclick="state.circleExpanded = false; render()" class="flex items-center gap-2 text-sm text-gray-600 mb-2 font-semibold hover:text-gray-800">' +
                      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>' +
                      t('confirmedLetters') + ' (' + confirmedLetters.length + '/5)</button>' +
                      '<div class="bg-gray-50 rounded-lg p-2">' +
                      '<div class="flex justify-center"><svg width="126" height="126" viewBox="0 0 154 154"><circle cx="77" cy="77" r="60" fill="none" stroke="#e5e7eb" stroke-width="2"/>' + circleSvg + '</svg></div></div></div>'
                    : '<div class="mb-3"><button onclick="state.circleExpanded = true; render()" class="flex items-center gap-2 text-sm text-gray-600 font-semibold hover:text-gray-800">' +
                      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>' +
                      t('confirmedLetters') + ' (' + confirmedLetters.length + '/5)</button></div>';

                var guessInputHtml = '';
                var isFirstGuess = sp.guesses.length === 0;
                if (!sp.gameOver) {
                    var inputClass = isFirstGuess 
                        ? 'flex-1 px-4 py-4 border-3 border-purple-400 rounded-lg text-xl uppercase text-center focus:outline-none focus:border-purple-600 shadow-lg bg-purple-50'
                        : 'flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-lg uppercase text-center focus:outline-none focus:border-purple-500';
                    var buttonClass = isFirstGuess
                        ? 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-lg transition text-lg shadow-lg'
                        : 'bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition';
                    guessInputHtml = '<div class="mb-3"><div class="flex gap-2">' +
                        '<input type="text" id="spGuess" placeholder="' + (isFirstGuess ? t('typeGuessHere') : t('enterGuess')) + '" value="' + state.currentGuess + '" maxlength="5" autocapitalize="characters" autocomplete="off" class="' + inputClass + '">' +
                        '<button onclick="state.currentGuess = document.getElementById(\'spGuess\').value; makeSinglePlayerGuess()" class="' + buttonClass + '">' + t('go') + '</button></div></div>';
                }

                // Generate contextual hints for new players
                var goalHint = (sp.guesses.length === 0) ? generateHintsHtml('goal') : '';
                var startHint = (sp.guesses.length === 0) ? generateHintsHtml('start') : '';
                var alphabetHint = generateHintsHtml('alphabet');
                var firstGuessHint = (sp.guesses.length === 1) ? generateHintsHtml('first_guess') : '';

                app.innerHTML = gameEndBanner + '<div class="max-w-2xl mx-auto p-2' + (gameEndBanner ? ' pt-24' : '') + '"><div class="bg-white rounded-2xl shadow-2xl p-4 mb-2">' +
                    '<div class="flex items-center justify-between mb-3">' +
                    renderLogo() +
                    '<div class="flex items-center gap-2">' +
                    '<button onclick="toggleSound()" class="p-1 hover:bg-gray-100 rounded-lg" title="' + (state.soundEnabled ? 'Mute' : 'Unmute') + '">' +
                    (state.soundEnabled 
                        ? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>'
                        : '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>') +
                    '</button>' +
                    '<button onclick="state.showStats = true; render()" class="p-1 hover:bg-gray-100 rounded-lg" title="Stats"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></button>' +
                    (!sp.gameOver ? '<button onclick="confirmQuit()" class="p-1 hover:bg-gray-100 rounded-lg" title="Quit"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>' : '') +
                    '<div class="text-right"><div class="bg-gray-100 rounded px-2 py-1 text-xs font-bold">Solo</div>' +
                    '<div class="text-xs text-gray-500">' + sp.guesses.length + '' + t('guesses') + '</div></div></div></div>' +
                    goalHint +
                    startHint +
                    guessInputHtml +
                    circleSection +
                    alphabetHint +
                    '<div class="mb-3"><div class="text-xs text-gray-600 mb-1 font-semibold">' + t('alphabetHint') + '</div>' +
                    '<div class="flex flex-wrap gap-1" id="spAlphabet">' + alphabetHtml + '</div></div>' +
                    firstGuessHint +
                    (state.message ? '<div class="mb-2 p-2 bg-purple-100 text-purple-800 rounded-lg text-center text-sm">' + state.message + '</div>' : '') +
                    (!sp.gameOver ? '<button onclick="giveUpSinglePlayer()" class="w-full mb-3 text-gray-500 hover:text-gray-700 text-sm">' + t('giveUp') + '</button>' : '') +
                    '<div class="border-t pt-3"><div class="text-xs text-gray-600 mb-2 font-semibold">' + t('yourGuesses') + '</div>' +
                    '<div class="space-y-1 max-h-72 overflow-y-auto">' + guessesHtml + '</div></div></div>' +
                    '<p class="text-gray-500 text-xs text-center mt-2">Copyright 2026 5letters.fun</p></div>' + modals;

                // Add event listeners for single player alphabet
                var spLetterBtns = document.querySelectorAll('.sp-letter-btn');
                spLetterBtns.forEach(function(btn) {
                    var pressTimer = null;
                    var longPressTriggered = false;
                    var letter = btn.dataset.letter;
                    btn.addEventListener('mousedown', function() {
                        longPressTriggered = false;
                        pressTimer = setTimeout(function() { longPressTriggered = true; toggleSinglePlayerLetter(letter, true); }, 500);
                    });
                    btn.addEventListener('mouseup', function() { if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleSinglePlayerLetter(letter, false); } });
                    btn.addEventListener('mouseleave', function() { if (pressTimer) clearTimeout(pressTimer); });
                    btn.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        longPressTriggered = false;
                        pressTimer = setTimeout(function() { longPressTriggered = true; toggleSinglePlayerLetter(letter, true); }, 500);
                    });
                    btn.addEventListener('touchend', function(e) { e.preventDefault(); if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleSinglePlayerLetter(letter, false); } });
                });

                var spGuessInput = document.getElementById('spGuess');
                if (spGuessInput) {
                    spGuessInput.addEventListener('input', function(e) { state.currentGuess = spGuessInput.value; });
                    spGuessInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { state.currentGuess = spGuessInput.value; makeSinglePlayerGuess(); } });
                }
                
                return;
            }

            if (!state.gameState) {
                var joinModal = '';
                if (state.showJoinModal) {
                    joinModal = '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                        '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                        '<h3 class="text-xl font-bold text-gray-800 mb-4">' + t('enterGameCode') + '</h3>' +
                        '<input type="text" id="gameCodeInput" placeholder="e.g. ABC123" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 text-lg uppercase text-center focus:outline-none focus:border-purple-500">' +
                        '<div class="flex gap-3">' +
                        '<button onclick="state.showJoinModal = false; render()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">' + t('cancel') + '</button>' +
                        '<button onclick="state.gameId = document.getElementById(\'gameCodeInput\').value; state.showJoinModal = false; joinGame()" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">' + t('joinGame') + '</button>' +
                        '</div></div></div>';
                }
                var shareModal = '';
                if (state.showShareModal) {
                    var gameUrl = window.location.origin + window.location.pathname + '?game=' + state.gameId + '&lang=' + currentLang;
                    shareModal = '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                        '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                        '<h3 class="text-xl font-bold text-gray-800 mb-2">' + t('gameCreated') + '</h3>' +
                        '<p class="text-gray-600 mb-4">' + t('code') + ': <span class="font-bold text-purple-600">' + state.gameId + '</span></p>' +
                        '<div class="flex flex-col gap-3">' +
                        '<button onclick="shareGame(\'' + gameUrl + '\')" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition">' + t('shareInviteLink') + '</button>' +
                        '<button onclick="state.showShareModal = false; render()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">' + t('continue') + '</button>' +
                        '</div></div></div>';
                }
                var hasGameCode = state.gameId && state.gameId.length > 0;
                var buttonsHtml = hasGameCode 
                    ? '<button onclick="state.playerName = document.getElementById(\'playerName\').value; joinGame()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition text-lg">' + t('joinGame') + ' ' + state.gameId + '</button>'
                    : '<button onclick="startSinglePlayer()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-4 rounded-lg transition text-lg shadow-lg">' + t('playNow') + '</button>' +
                      '<div class="flex gap-3 mt-4 pt-4 border-t border-gray-200">' +
                      '<button onclick="state.playerName = document.getElementById(\'playerName\').value; createGame()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg transition text-sm">' + t('twoPlayerStart') + '</button>' +
                      '<button onclick="state.playerName = document.getElementById(\'playerName\').value; if(!state.playerName.trim()) { state.message = t(\'enterName\'); render(); return; } state.showJoinModal = true; render()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg transition text-sm">' + t('joinTwoPlayer') + '</button></div>';
                
                app.innerHTML = '<div class="min-h-screen flex flex-col items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">' +
                    '<div class="flex justify-center mb-2">' + renderLogo() + '</div>' +
                    '<div class="flex justify-center items-center gap-4 mb-6">' +
                    '<button onclick="state.showInstructions = true; render()" class="text-purple-600 hover:text-purple-800 text-sm font-semibold">' + t('howToPlay') + '</button>' +
                    '<button onclick="state.showStats = true; render()" class="text-purple-600 hover:text-purple-800 text-sm font-semibold">' + t('yourStats') + '</button>' +
                    '<button onclick="toggleSound()" class="text-purple-600 hover:text-purple-800" title="' + (state.soundEnabled ? 'Mute' : 'Unmute') + '">' +
                    (state.soundEnabled 
                        ? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>'
                        : '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>') +
                    '</button></div>' +
                    '<input type="text" id="playerName" placeholder="' + t('namePlaceholder') + '" value="' + state.playerName + '" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 text-lg focus:outline-none focus:border-purple-500">' +
                    buttonsHtml +
                    (state.message ? '<div class="mt-4 p-3 bg-purple-100 text-purple-800 rounded-lg text-center">' + state.message + '</div>' : '') +
                    '<div class="flex justify-center gap-4 mt-4"><button onclick="switchLanguage(\'en\')" class="text-2xl ' + (currentLang==='en'?'':'opacity-40') + '">ðŸ‡¬ðŸ‡§</button><button onclick="switchLanguage(\'de\')" class="text-2xl ' + (currentLang==='de'?'':'opacity-40') + '">ðŸ‡©ðŸ‡ª</button><button onclick="switchLanguage(\'fr\')" class="text-2xl ' + (currentLang==='fr'?'':'opacity-40') + '">ðŸ‡«ðŸ‡·</button></div>' +
                    '</div><p class="text-gray-500 text-xs mt-4">Copyright 2026 5letters.fun</p></div>' + joinModal + shareModal + modals;
                return;
            }

            var myPlayer = state.gameState.players[state.playerId];
            if (!myPlayer.wordSet) {
                var opponent = Object.values(state.gameState.players).find(function(p) { return p !== myPlayer; });
                var playerCount = Object.keys(state.gameState.players).length;
                var gameUrl = window.location.origin + window.location.pathname + '?game=' + state.gameId + '&lang=' + currentLang;
                var statusHtml = '';
                if (playerCount === 1) {
                    statusHtml = '<div class="mt-4 p-4 bg-yellow-100 text-yellow-800 rounded-lg text-center">' +
                        '<p class="font-semibold mb-2">â³ ' + t('waitingForOpponent') + '</p>' +
                        '<p class="text-sm mb-3">' + t('code') + ': <span class="font-bold">' + state.gameId + '</span></p>' +
                        '<div class="flex gap-2 justify-center">' +
                        '<button onclick="shareGame(\'' + gameUrl + '\')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm">' + t('shareInvite') + '</button>' +
                        '<button onclick="cancelGame()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition text-sm">' + t('cancel') + '</button>' +
                        '</div></div>';
                } else if (opponent && !opponent.wordSet) {
                    statusHtml = '<div class="mt-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg text-center">' +
                        '<p>' + t('waitingFor') + ' ' + opponent.name + '...</p>' +
                        '<button onclick="cancelGame()" class="mt-2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-lg transition text-sm">' + t('cancel') + '</button>' +
                        '</div>';
                } else if (opponent && opponent.wordSet) {
                    statusHtml = '<div class="mt-4 p-3 bg-green-100 text-green-800 rounded-lg text-center">ðŸŽ‰ ' + opponent.name + ' ' + t('isReady') + '</div>';
                }
                app.innerHTML = '<div class="min-h-screen flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">' +
                    '<h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">' + t('chooseSecretWord') + '</h2>' +
                    '<p class="text-gray-600 mb-4 text-center">' + t('pickWord') + '</p>' +
                    '<input type="text" id="myWord" placeholder="' + t('secretWordPlaceholder') + '" value="' + state.myWord + '" maxlength="5" autocapitalize="characters" autocomplete="off" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 text-lg uppercase text-center focus:outline-none focus:border-purple-500">' +
                    '<button onclick="state.myWord = document.getElementById(\'myWord\').value; setSecretWord()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition text-lg">' + t('setWord') + '</button>' +
                    (state.message ? '<div class="mt-4 p-3 bg-purple-100 text-purple-800 rounded-lg text-center">' + state.message + '</div>' : '') +
                    statusHtml +
                    '<button onclick="cancelGame()" class="w-full mt-4 text-gray-500 hover:text-gray-700 text-sm">' + t('backToHome') + '</button>' +
                    '</div></div>' + modals;
                var wordInput = document.getElementById('myWord');
                if (wordInput) wordInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { state.myWord = wordInput.value; setSecretWord(); } });
                return;
            }

            var opponentId = Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; });
            var opponent = opponentId ? state.gameState.players[opponentId] : null;
            var isMyTurn = state.gameState.blitzMode || state.gameState.currentTurn === state.playerId;
            var letterStates = myPlayer.letterStates || {};
            var confirmedLetters = state.confirmedLetters || [];

            var circlePositions = [];
            for (var i = 0; i < 5; i++) {
                var angle = (i * 72 - 90) * (Math.PI / 180);
                var x = 77 + 56 * Math.cos(angle);
                var y = 77 + 56 * Math.sin(angle);
                circlePositions.push({ x: x, y: y, letter: confirmedLetters[i] || '' });
            }
            var circleSvg = '';
            for (var i = 0; i < circlePositions.length; i++) {
                var pos = circlePositions[i];
                circleSvg += '<g><circle cx="' + pos.x + '" cy="' + pos.y + '" r="14" fill="' + (pos.letter ? '#22c55e' : '#f3f4f6') + '" stroke="#d1d5db" stroke-width="2"/>' +
                    '<text x="' + pos.x + '" y="' + pos.y + '" text-anchor="middle" dy="5" font-size="14" font-weight="bold" fill="' + (pos.letter ? 'white' : '#9ca3af') + '">' + pos.letter + '</text></g>';
            }

            var alphabetHtml = '';
            for (var i = 0; i < getAlphabet().length; i++) {
                var letter = getAlphabet()[i];
                var lState = letterStates[letter];
                var btnClass = lState === 'excluded' ? 'bg-red-500 text-white line-through' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300';
                alphabetHtml += '<button data-letter="' + letter + '" class="letter-btn w-9 h-9 rounded font-bold text-base transition ' + btnClass + '">' + letter + '</button>';
            }

            var guessesHtml = '';
            if (myPlayer.guesses && myPlayer.guesses.length > 0) {
                for (var i = myPlayer.guesses.length - 1; i >= 0; i--) {
                    var guess = myPlayer.guesses[i];
                    var coloredWord = '';
                    for (var j = 0; j < guess.word.length; j++) {
                        var letter = guess.word[j];
                        var lState = letterStates[letter];
                        var letterClass = lState === 'excluded' ? 'bg-red-500 text-white' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-800';
                        coloredWord += '<span class="inline-block w-7 h-7 rounded text-center leading-7 font-bold text-sm ' + letterClass + '">' + letter + '</span>';
                    }
                    var isNewest = (i === myPlayer.guesses.length - 1);
                    guessesHtml += '<div class="bg-gray-100 rounded-lg p-2 flex justify-between items-center' + (isNewest ? ' guess-row' : '') + '"><div class="flex gap-0.5">' + coloredWord + '</div>' +
                        '<span class="bg-purple-500 text-white px-2 py-0.5 rounded-full text-sm font-bold">' + guess.matches + '</span></div>';
                }
            } else {
                guessesHtml = '<div class="text-gray-400 text-center py-4 text-sm">' + t('noGuessesYet') + '</div>';
            }

            var gameEndContent = '';
            var gameEndBanner = '';
            if (myPlayer.won) {
                gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 shadow-lg z-50">' +
                    '<div class="max-w-2xl mx-auto text-center">' +
                    '<h2 class="text-2xl font-bold mb-1">' + t('youWon') + '</h2>' +
                    '<p class="text-sm mb-3">' + t('guessedIn') + ' ' + myPlayer.guesses.length + '' + t('tries') + '</p>' +
                    '<div class="flex justify-center gap-2">' +
                    '<button onclick="shareResult()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">' + t('share') + '</button>' +
                    '<button onclick="startRematch()" class="bg-white text-green-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">' + t('rematch') + '</button>' +
                    '<button onclick="cancelGame()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">' + t('home') + '</button>' +
                    '</div></div></div>';
            } else if (opponent && opponent.won) {
                gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-red-500 to-rose-600 text-white p-4 shadow-lg z-50">' +
                    '<div class="max-w-2xl mx-auto text-center">' +
                    '<h2 class="text-2xl font-bold mb-1">' + t('youLost') + '</h2>' +
                    '<p class="text-sm mb-3">' + opponent.name + ' ' + t('guessedYourWord') + '</p>' +
                    '<div class="flex justify-center gap-2">' +
                    '<button onclick="shareResult()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">' + t('share') + '</button>' +
                    '<button onclick="startRematch()" class="bg-white text-red-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">' + t('rematch') + '</button>' +
                    '<button onclick="cancelGame()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">' + t('home') + '</button>' +
                    '</div></div></div>';
            } else if (!state.gameState.started) {
                gameEndContent = '<div class="bg-white rounded-2xl shadow-2xl p-4 text-center"><p class="text-gray-600">' + t('waitingForOpponent') + '</p></div>';
            }

            var circleSection = state.circleExpanded 
                ? '<div class="mb-3"><button onclick="state.circleExpanded = false; render()" class="flex items-center gap-2 text-sm text-gray-600 mb-2 font-semibold hover:text-gray-800">' +
                  '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>' +
                  'Your Word & Letters (' + confirmedLetters.length + '/5)</button>' +
                  '<div class="bg-gray-50 rounded-lg p-2">' +
                  '<div class="flex items-center justify-center gap-3 mb-2"><div id="secretWord" class="text-2xl font-bold tracking-widest text-gray-400">*****</div>' +
                  '<button id="showWordBtn" class="p-2 rounded-full hover:bg-gray-200 transition animate-pulse"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-500"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button></div>' +
                  '<div class="flex justify-center"><svg width="126" height="126" viewBox="0 0 154 154"><circle cx="77" cy="77" r="60" fill="none" stroke="#e5e7eb" stroke-width="2"/>' + circleSvg + '</svg></div></div></div>'
                : '<div class="mb-3"><button onclick="state.circleExpanded = true; render()" class="flex items-center gap-2 text-sm text-gray-600 font-semibold hover:text-gray-800">' +
                  '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>' +
                  'Your Word & Letters (' + confirmedLetters.length + '/5)</button></div>';

            // Build guess input section
            var guessInputHtml = '';
            if (state.gameState.started && !myPlayer.won && !(opponent && opponent.won)) {
                if (state.gameState.blitzMode) {
                    // In blitz mode, always show input
                    guessInputHtml = '<div class="mb-3"><div class="p-2 bg-orange-100 text-orange-800 rounded-lg text-center text-sm font-bold mb-2">âš¡ Blitz Mode Active!</div><div class="flex gap-2">' +
                        '<input type="text" id="currentGuess" placeholder="' + t('enterGuess') + '" value="' + state.currentGuess + '" maxlength="5" autocapitalize="characters" autocomplete="off" class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-lg uppercase text-center focus:outline-none focus:border-purple-500">' +
                        '<button onclick="state.currentGuess = document.getElementById(\'currentGuess\').value; makeGuess()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">' + t('go') + '</button></div></div>';
                } else {
                    var turnClass = isMyTurn ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    var turnMsg = isMyTurn ? t('yourTurn') : t('waitingFor') + ' ' + (opponent ? opponent.name : '') + '...';
                    if (isMyTurn) {
                        guessInputHtml = '<div class="mb-3"><div class="flex gap-2">' +
                            '<input type="text" id="currentGuess" placeholder="' + t('enterGuess') + '" value="' + state.currentGuess + '" maxlength="5" autocapitalize="characters" autocomplete="off" class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-lg uppercase text-center focus:outline-none focus:border-purple-500">' +
                            '<button onclick="state.currentGuess = document.getElementById(\'currentGuess\').value; makeGuess()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">' + t('go') + '</button></div></div>';
                    } else {
                        guessInputHtml = '<div class="mb-3 p-2 rounded-lg text-center text-sm font-semibold ' + turnClass + '">' + turnMsg + '</div>';
                    }
                }
            }

            // Generate contextual hints for new players
            var myGuessCount = myPlayer.guesses ? myPlayer.guesses.length : 0;
            var goalHint = (myGuessCount === 0 && state.gameState.started) ? generateHintsHtml('goal') : '';
            var alphabetHint = generateHintsHtml('alphabet');
            var firstGuessHint = (myGuessCount === 1) ? generateHintsHtml('first_guess') : '';

            app.innerHTML = gameEndBanner + '<div class="max-w-2xl mx-auto p-2' + (gameEndBanner ? ' pt-24' : '') + '"><div class="bg-white rounded-2xl shadow-2xl p-4 mb-2">' +
                '<div class="flex items-center justify-between mb-3">' +
                renderLogo() +
                '<div class="flex items-center gap-2">' +
                '<button onclick="toggleSound()" class="p-1 hover:bg-gray-100 rounded-lg" title="' + (state.soundEnabled ? 'Mute' : 'Unmute') + '">' +
                (state.soundEnabled 
                    ? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>') +
                '</button>' +
                '<button onclick="state.showStats = true; render()" class="p-1 hover:bg-gray-100 rounded-lg" title="Stats"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></button>' +
                (!gameEndBanner ? '<button onclick="confirmQuit()" class="p-1 hover:bg-gray-100 rounded-lg" title="Quit"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>' : '') +
                '<div class="text-right"><div class="bg-gray-100 rounded px-2 py-1 text-xs font-bold">' + state.gameId + '</div>' +
                '<div class="text-xs text-gray-500">vs ' + (opponent ? opponent.name : '...') + '</div>' +
                (opponent && opponent.confirmedLetters ? '<div class="text-xs text-green-600 font-semibold">ðŸŽ¯ ' + (opponent.confirmedLetters.length || 0) + '/5</div>' : '') +
                '</div></div></div>' +
                (state.gameState.started && !myPlayer.won && !(opponent && opponent.won) && !state.gameState.blitzMode ?
                    (state.gameState.blitzModeRequestedBy === state.playerId ?
                        '<div class="mb-3 flex justify-center"><div class="flex items-center gap-1 bg-orange-100 text-orange-800 font-semibold py-1 px-3 rounded-lg text-xs"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span>Waiting for ' + (opponent ? opponent.name : 'opponent') + ' to accept...</span></div></div>' :
                        (!state.gameState.blitzModeRequestedBy ? '<div class="mb-3 flex justify-center"><button onclick="requestBlitzMode()" class="flex items-center gap-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition" title="Request Blitz Mode"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span>Blitz Mode</span></button></div>' : '')) : '') +
                goalHint +
                circleSection +
                alphabetHint +
                '<div class="mb-3"><div class="text-xs text-gray-600 mb-1 font-semibold">' + t('alphabetHint') + '</div>' +
                '<div class="flex flex-wrap gap-1" id="alphabet">' + alphabetHtml + '</div></div>' +
                guessInputHtml +
                firstGuessHint +
                (state.message ? '<div class="mb-2 p-2 bg-purple-100 text-purple-800 rounded-lg text-center text-sm">' + state.message + '</div>' : '') +
                '<div class="border-t pt-3"><div class="text-xs text-gray-600 mb-2 font-semibold">' + t('yourGuesses') + '</div>' +
                '<div class="space-y-1 max-h-72 overflow-y-auto">' + guessesHtml + '</div></div></div>' +
                gameEndContent + '<p class="text-gray-500 text-xs text-center mt-2">Copyright 2026 5letters.fun</p></div>' + modals;

            var letterBtns = document.querySelectorAll('.letter-btn');
            letterBtns.forEach(function(btn) {
                var pressTimer = null;
                var longPressTriggered = false;
                var letter = btn.dataset.letter;
                btn.addEventListener('mousedown', function() {
                    longPressTriggered = false;
                    pressTimer = setTimeout(function() { longPressTriggered = true; toggleLetterState(letter, true); }, 500);
                });
                btn.addEventListener('mouseup', function() { if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleLetterState(letter, false); } });
                btn.addEventListener('mouseleave', function() { if (pressTimer) clearTimeout(pressTimer); });
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    longPressTriggered = false;
                    pressTimer = setTimeout(function() { longPressTriggered = true; toggleLetterState(letter, true); }, 500);
                });
                btn.addEventListener('touchend', function(e) { e.preventDefault(); if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleLetterState(letter, false); } });
            });

            var guessInput = document.getElementById('currentGuess');
            if (guessInput) {
                guessInput.addEventListener('input', function(e) { state.currentGuess = guessInput.value; });
                guessInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { state.currentGuess = guessInput.value; makeGuess(); } });
            }

            var showWordBtn = document.getElementById('showWordBtn');
            var secretWordEl = document.getElementById('secretWord');
            if (showWordBtn && secretWordEl) {
                var actualWord = myPlayer.word;
                showWordBtn.addEventListener('mousedown', function() { secretWordEl.textContent = actualWord; });
                showWordBtn.addEventListener('mouseup', function() { secretWordEl.textContent = '*****'; });
                showWordBtn.addEventListener('mouseleave', function() { secretWordEl.textContent = '*****'; });
                showWordBtn.addEventListener('touchstart', function(e) { e.preventDefault(); secretWordEl.textContent = actualWord; });
                showWordBtn.addEventListener('touchend', function(e) { e.preventDefault(); secretWordEl.textContent = '*****'; });
            }
        }

        // Log page view once on load
        logEvent('page_view');
        
        render();
    </script>
</body>
</html>
