<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5letters - Word Guessing Game</title>
    <meta name="description" content="Challenge friends to guess your secret 5-letter word! A fun two-player word guessing game.">
    <meta property="og:title" content="5letters - Word Guessing Game">
    <meta property="og:description" content="Challenge friends to guess your secret 5-letter word!">
    <meta property="og:url" content="https://www.5letters.fun">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="5letters - Word Guessing Game">
    <meta name="twitter:description" content="Challenge friends to guess your secret 5-letter word!">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%238B5CF6'/%3E%3Ctext x='16' y='23' text-anchor='middle' font-family='Arial,sans-serif' font-weight='bold' font-size='16' fill='white'%3E5L%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%238B5CF6'/%3E%3Ctext x='16' y='23' text-anchor='middle' font-family='Arial,sans-serif' font-weight='bold' font-size='16' fill='white'%3E5L%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='30' fill='%238B5CF6'/%3E%3Ctext x='90' y='120' text-anchor='middle' font-family='Arial,sans-serif' font-weight='bold' font-size='90' fill='white'%3E5L%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-database-compat.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        .logo-font { font-family: 'Playfair Display', serif; }
        .banner-enter { animation: slideDown 0.3s ease-out; }
        .banner-exit { animation: slideUp 0.3s ease-in forwards; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(-100px) rotate(720deg); opacity: 0; } }
        .shake { animation: shake 0.4s ease-in-out; }
        .pop { animation: pop 0.2s ease-out; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .guess-row { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-800 min-h-screen">
    <div id="app"></div>
    <div id="banner"></div>
    <div id="confetti"></div>
    <script>
        // ==================== TRANSLATIONS ====================
        var translations = {
            en: {
                logoText: '5letters', title: '5letters - Word Guessing Game',
                howToPlay: 'How to Play', yourStats: 'Your Stats', playNow: 'Play Now',
                twoPlayerStart: '2-Player Start', joinTwoPlayer: 'Join 2-Player Game',
                namePlaceholder: 'Your name (optional)', gameCodePlaceholder: 'Enter Game Code',
                joinGame: 'Join Game', gameCreated: 'Game Created!', code: 'Code',
                shareInviteLink: 'Share Invite Link', continue: 'Continue', cancel: 'Cancel',
                close: 'Close', chooseSecretWord: 'Choose Your Secret Word',
                pickWord: 'Pick a 5-letter word with unique letters',
                secretWordPlaceholder: 'Your secret word', setWord: 'Set Word',
                waitingForOpponent: 'Waiting for opponent...', shareInvite: 'Share Invite',
                settingWord: 'to set their word...', isReady: 'is ready! Set your word.',
                backToHome: '‚Üê Back to Home', guessMustBe5: 'Guess must be exactly 5 letters',
                wordMustBe5: 'Word must be exactly 5 letters', uniqueLetters: 'All letters must be unique',
                notValidWord: 'Not a valid word', waitingFor: 'Waiting for', youWon: 'You Won!',
                gameNotFound: 'Game not found', rejoinedGame: 'Rejoined game', gameIsFull: 'Game is full',
                joinedGame: 'Joined game! Choose your secret word.',
                wordSet: 'Word set! Waiting for game to start...',
                enterName: 'Please enter your name', noGuessesYet: 'No guesses yet',
                yourGuesses: 'Your Guesses:', enterGuess: 'Enter guess',
                typeGuessHere: 'Type your guess here', yourTurn: 'Your turn!', guesses: 'guesses',
                giveUp: 'Give up & reveal word', guessedIn: 'Guessed in', tries: 'tries!',
                theWordWas: 'The word was', shareResult: 'Share Result', share: 'Share',
                rematch: 'Rematch', playAgain: 'Play Again', tryAgain: 'Try Again', home: 'Home',
                gameOver: 'Game Over', guessedYourWord: 'guessed your word!',
                copied: 'Result copied to clipboard!', copyToShare: 'Copy this to share:',
                max5Letters: 'Maximum 5 letters', stats: 'Stats', gamesPlayed: 'Games Played',
                winRate: 'Win Rate', currentStreak: 'Current Streak', bestStreak: 'Best Streak',
                avgGuesses: 'Avg Guesses/Win', quickestWin: 'Quickest Win',
                viewHistory: 'View Game History', gameHistory: 'Game History',
                noGamesYet: 'No games yet', wonIn: 'Won in', lost: 'Lost',
                yourWord: 'Your word:', theirWord: 'Their word:', quitGame: 'Quit Game?',
                quitConfirm: 'Are you sure? Your progress will be lost.', quit: 'Quit',
                howToPlayTitle: 'How to Play 5letters',
                rule1: 'Each player picks a secret 5-letter word with <strong>unique letters</strong>',
                rule2: 'Take turns guessing your opponent\'s word',
                rule3: 'After each guess, see how many letters match (but not which ones!)',
                rule4: 'First to guess the opponent\'s word wins!', tips: 'Tips:',
                tip1: '<strong>Click</strong> a letter to exclude it (red)',
                tip2: '<strong>Long press</strong> a letter to include it (green)', gotIt: 'Got it!',
                hintStart: 'üëá <strong>Start here!</strong> Type any 5-letter word with unique letters in the box below and tap "Go" to make your first guess.',
                hintFirstGuess: 'üí° <strong>The number shows how many of YOUR letters appear in the secret word</strong> ‚Äî but not which ones! Use logic to narrow it down.',
                hintAlphabet: 'üí° <strong>Red and green are YOUR notes</strong> ‚Äî click letters to mark them as ruled out (red), or long-press to mark as definitely in the word (green). The game doesn\'t tell you which letters match!',
                hintGoal: 'üéØ <strong>Goal:</strong> Guess the secret word in as few tries as possible! Each guess tells you how many letters match.',
                shareWon: 'üéâ I won at 5letters in {n} guesses{opponent}!',
                shareLost: 'üòÖ I lost at 5letters after {n} guesses{opponent}',
                against: ' against ', opponentGuessed: ' guessed: ',
                lettersMatching: 'Letters matching your word: ', hits: 'hits',
                yourTurnNow: '‚ö° Your turn now!', tapToDismiss: 'Tap to dismiss', none: 'None',
                copyright: 'Copyright 2026 5letters.fun', shareGameText: 'Join my 5letters game! ',
                go: 'Go'
            },
            de: {
                logoText: '5Buchstaben', title: '5Buchstaben - Wort-Ratespiel',
                howToPlay: 'So geht\'s', yourStats: 'Deine Statistik', playNow: 'Jetzt spielen',
                twoPlayerStart: '2-Spieler starten', joinTwoPlayer: '2-Spieler beitreten',
                namePlaceholder: 'Dein Name (optional)', gameCodePlaceholder: 'Spielcode eingeben',
                joinGame: 'Spiel beitreten', gameCreated: 'Spiel erstellt!', code: 'Code',
                shareInviteLink: 'Einladungslink teilen', continue: 'Weiter', cancel: 'Abbrechen',
                close: 'Schlie√üen', chooseSecretWord: 'W√§hle dein geheimes Wort',
                pickWord: 'W√§hle ein 5-Buchstaben-Wort mit einzigartigen Buchstaben',
                secretWordPlaceholder: 'Dein geheimes Wort', setWord: 'Wort setzen',
                waitingForOpponent: 'Warte auf Gegner...', shareInvite: 'Einladung teilen',
                settingWord: 'setzt sein Wort...', isReady: 'ist bereit! Setze dein Wort.',
                backToHome: '‚Üê Zur√ºck zur Startseite',
                guessMustBe5: 'Versuch muss genau 5 Buchstaben haben',
                wordMustBe5: 'Wort muss genau 5 Buchstaben haben',
                uniqueLetters: 'Alle Buchstaben m√ºssen einzigartig sein',
                notValidWord: 'Kein g√ºltiges Wort', waitingFor: 'Warte auf', youWon: 'Gewonnen!',
                gameNotFound: 'Spiel nicht gefunden', rejoinedGame: 'Spiel wieder beigetreten',
                gameIsFull: 'Spiel ist voll', joinedGame: 'Beigetreten! W√§hle dein geheimes Wort.',
                wordSet: 'Wort gesetzt! Warte auf Spielstart...',
                enterName: 'Bitte gib deinen Namen ein', noGuessesYet: 'Noch keine Versuche',
                yourGuesses: 'Deine Versuche:', enterGuess: 'Versuch eingeben',
                typeGuessHere: 'Gib deinen Versuch ein', yourTurn: 'Du bist dran!',
                guesses: 'Versuche', giveUp: 'Aufgeben & Wort zeigen', guessedIn: 'Erraten in',
                tries: 'Versuchen!', theWordWas: 'Das Wort war', shareResult: 'Ergebnis teilen',
                share: 'Teilen', rematch: 'Revanche', playAgain: 'Nochmal spielen',
                tryAgain: 'Nochmal versuchen', home: 'Startseite', gameOver: 'Spiel vorbei',
                guessedYourWord: 'hat dein Wort erraten!',
                copied: 'Ergebnis in Zwischenablage kopiert!',
                copyToShare: 'Kopiere dies zum Teilen:', max5Letters: 'Maximal 5 Buchstaben',
                stats: 'Statistik', gamesPlayed: 'Spiele gespielt', winRate: 'Gewinnrate',
                currentStreak: 'Aktuelle Serie', bestStreak: 'Beste Serie',
                avgGuesses: '√ò Versuche/Sieg', quickestWin: 'Schnellster Sieg',
                viewHistory: 'Spielverlauf anzeigen', gameHistory: 'Spielverlauf',
                noGamesYet: 'Noch keine Spiele', wonIn: 'Gewonnen in', lost: 'Verloren',
                yourWord: 'Dein Wort:', theirWord: 'Deren Wort:', quitGame: 'Spiel beenden?',
                quitConfirm: 'Bist du sicher? Dein Fortschritt geht verloren.', quit: 'Beenden',
                howToPlayTitle: 'So spielst du 5Buchstaben',
                rule1: 'Jeder Spieler w√§hlt ein geheimes 5-Buchstaben-Wort mit <strong>einzigartigen Buchstaben</strong>',
                rule2: 'Ratet abwechselnd das Wort des Gegners',
                rule3: 'Nach jedem Versuch siehst du, wie viele Buchstaben √ºbereinstimmen (aber nicht welche!)',
                rule4: 'Wer zuerst das Wort des Gegners err√§t, gewinnt!', tips: 'Tipps:',
                tip1: '<strong>Klicke</strong> einen Buchstaben zum Ausschlie√üen (rot)',
                tip2: '<strong>Lang dr√ºcken</strong> um ihn einzuschlie√üen (gr√ºn)', gotIt: 'Verstanden!',
                hintStart: 'üëá <strong>Hier starten!</strong> Gib ein 5-Buchstaben-Wort mit einzigartigen Buchstaben ein und tippe auf "Los" f√ºr deinen ersten Versuch.',
                hintFirstGuess: 'üí° <strong>Die Zahl zeigt, wie viele DEINER Buchstaben im geheimen Wort vorkommen</strong> ‚Äî aber nicht welche! Nutze Logik zum Eingrenzen.',
                hintAlphabet: 'üí° <strong>Rot und gr√ºn sind DEINE Notizen</strong> ‚Äî klicke Buchstaben zum Ausschlie√üen (rot), oder lang dr√ºcken zum Einschlie√üen (gr√ºn). Das Spiel zeigt nicht, welche Buchstaben √ºbereinstimmen!',
                hintGoal: 'üéØ <strong>Ziel:</strong> Errate das geheime Wort in so wenigen Versuchen wie m√∂glich! Jeder Versuch zeigt dir, wie viele Buchstaben √ºbereinstimmen.',
                shareWon: 'üéâ Ich habe bei 5Buchstaben in {n} Versuchen gewonnen{opponent}!',
                shareLost: 'üòÖ Ich habe bei 5Buchstaben nach {n} Versuchen verloren{opponent}',
                against: ' gegen ', opponentGuessed: ' hat geraten: ',
                lettersMatching: 'Buchstaben in deinem Wort: ', hits: 'Treffer',
                yourTurnNow: '‚ö° Du bist dran!', tapToDismiss: 'Tippen zum Schlie√üen', none: 'Keine',
                copyright: 'Copyright 2026 5letters.fun', shareGameText: 'Spiel mit mir 5Buchstaben! ',
                go: 'Los'
            }
        };

        // Language-specific word lists
        var wordLists = {
            en: [
                'ABOUT','ABOVE','ABUSE','ACUTE','ADEPT','ADMIT','ADOPT','ADULT','AGENT','AGILE',
                'ALARM','ALBUM','ALIEN','ALIGN','AMBER','AMUSE','ANGEL','ANGER','ANGLE','ANKLE',
                'APART','ARGUE','ARISE','ARMED','AROMA','ASIDE','ASKED','ATLAS','AUDIO','BADGE',
                'BADLY','BAKED','BASIN','BATCH','BEACH','BEADS','BEARD','BEAST','BEGAN','BEING',
                'BELOW','BENCH','BIRCH','BLACK','BLADE','BLAME','BLAND','BLANK','BLAST','BLAZE',
                'BLEND','BLIND','BLOCK','BLOND','BLOWN','BLUES','BLUNT','BOARD','BOAST','BONED',
                'BONUS','BOUGH','BOUND','BRACE','BRAIN','BRAKE','BRAND','BRAVO','BREAD','BREAK',
                'BRICK','BRIDE','BRING','BRISK','BROAD','BROKE','BRUNT','BRUSH','BRUTE','BUILD',
                'BUILT','BUNCH','BURST','CABLE','CADET','CAMEL','CANDY','CANOE','CAPER','CARVE',
                'CAUSE','CEDAR','CHAIN','CHAIR','CHALK','CHAMP','CHANT','CHARM','CHASE','CHEAP',
                'CHEST','CHILD','CHIME','CHINA','CHIRP','CHOMP','CHORD','CHOSE','CHUNK','CIGAR',
                'CLAIM','CLAMP','CLANG','CLANK','CLASH','CLASP','CLEAN','CLEAR','CLIMB','CLING',
                'CLOAK','CLONE','CLOTH','CLOUD','CLOUT','CLOWN','CLUBS','CLUMP','CLUNG','COACH',
                'COAST','COBRA','COMET','CORAL','COUCH','COUGH','COULD','COUNT','COURT','COVER',
                'CRAFT','CRAMP','CRANE','CRANK','CRASH','CRAWL','CRAZY','CREAM','CREST','CRISP',
                'CROWD','CROWN','CRUDE','CRUEL','CRUSH','CRUST','CURLY','DAILY','DAIRY','DAISY',
                'DANCE','DEALT','DEATH','DECAL','DECAY','DELTA','DEMON','DEPOT','DEPTH','DIARY',
                'DINER','DIRTY','DISCO','DOUBT','DOUGH','DRAFT','DRAIN','DRAKE','DRANK','DRAPE',
                'DRAWN','DREAD','DREAM','DRIFT','DRINK','DRIVE','DROWN','DRUMS','DRUNK','DUSTY',
                'DWARF','DYING','EAGER','EARLY','EARTH','EBONY','EIGHT','ELBOW','EMPTY','ENJOY',
                'ENTRY','EPOCH','EQUIP','ERUPT','EVICT','EXACT','FABLE','FACTS','FAINT','FAIRY',
                'FAITH','FALSE','FANCY','FARCE','FAULT','FAUNA','FEAST','FEATS','FIBER','FIELD',
                'FIEND','FIERY','FIFTY','FIGHT','FILTH','FINAL','FINCH','FIRED','FIRST','FIXED',
                'FJORD','FLAIR','FLAKE','FLAME','FLANK','FLARE','FLASH','FLASK','FLESH','FLICK',
                'FLING','FLINT','FLOAT','FLOCK','FLOOD','FLORA','FLOUT','FLUID','FLUKE','FLUNG',
                'FLUSH','FOCAL','FORCE','FORGE','FORTH','FORTY','FORUM','FOUND','FOYER','FRAIL',
                'FRAME','FRANK','FRAUD','FREAK','FRESH','FRIED','FROCK','FRONT','FROST','FRUIT',
                'FUDGE','FUNGI','GHOST','GIANT','GIVEN','GLAND','GLARE','GLEAM','GLIDE','GLOBE',
                'GLORY','GLOVE','GLYPH','GNOME','GOATS','GODLY','GOING','GRACE','GRADE','GRAIN',
                'GRAND','GRAPE','GRASP','GRAVE','GRAVY','GRAZE','GREAT','GREED','GRIND','GROAN',
                'GROIN','GROOM','GROUP','GROVE','GROWL','GROWN','GUARD','GUEST','GUIDE','GUILD',
                'GUILT','GUISE','HABIT','HANDY','HARDY','HARSH','HASTE','HASTY','HATCH','HAUNT',
                'HAVEN','HAZEL','HEADS','HEARD','HEART','HEAVY','HEDGE','HEIST','HELPS','HENCE',
                'HERBS','HINGE','HITCH','HOARD','HOBBY','HOIST','HONEY','HORSE','HOTEL','HOUND',
                'HOURS','HOUSE','HUMAN','HUMID','HUSKY','IDEAL','IMAGE','IMPLY','INDEX','INEPT',
                'INGOT','INPUT','INTRO','IRONY','IVORY','JAUNT','JEANS','JEWEL','JOINT','JOKER',
                'JOLLY','JOUST','JUDGE','JUICE','JUICY','JUMBO','JUMPS','KAYAK','KNIFE','KNOCK',
                'KNOTS','KNOWN','LABEL','LABOR','LACED','LADEN','LADLE','LAGER','LANCE','LAPSE',
                'LARGE','LARVA','LASER','LATCH','LATER','LATHE','LAUGH','LAYER','LEACH','LEADS',
                'LEAPT','LEARN','LEASE','LEASH','LEAST','LEAVE','LEDGE','LEGAL','LEMON','LIGHT',
                'LIMBO','LIMBS','LIMIT','LINED','LINEN','LINER','LINES','LINKS','LIONS','LITER',
                'LIVER','LOADS','LOAFS','LOANS','LOFTY','LOGIC','LONER','LOOPS','LORDS','LOSER',
                'LOTUS','LOUSE','LOUSY','LOVED','LOVER','LOWER','LUCID','LUCKY','LUMEN','LUMPS',
                'LUNAR','LUNCH','LUNGE','LURCH','LURKS','LYING','LYRIC','MACHO','MAGIC','MAJOR',
                'MAKER','MANGO','MANLY','MANOR','MAPLE','MARCH','MARSH','MATCH','MAYBE','MAYOR',
                'MEANS','MEATS','MEDAL','MEDIA','MELON','MERCY','MERGE','MERIT','METAL','MICRO',
                'MIDST','MIGHT','MILES','MILKY','MINCE','MINDS','MINED','MINER','MINOR','MINTY',
                'MINUS','MIRTH','MISTY','MIXED','MODEL','MOIST','MOLDS','MONEY','MONTH','MOODY',
                'MORAL','MOUND','MOUNT','MOURN','MOUSE','MOUTH','MOVED','MOVER','MOVIE','MULCH',
                'MUNCH','MURAL','MURKY','MUSHY','MUSIC','MUSKY','MYTHS','NAILS','NAIVE','NAMED',
                'NAMES','NASTY','NAVAL','NAVEL','NERDY','NERVE','NEWLY','NIGHT','NINJA','NINTH',
                'NOBLE','NOBLY','NOISY','NORTH','NOTCH','NOTED','NOVEL','NUDGE','NURSE','OCCUR',
                'OCEAN','OFTEN','OLIVE','ONSET','OPERA','OPTIC','ORBIT','ORDER','ORGAN','OTHER',
                'OTTER','OUGHT','OUNCE','OUTER','OWNED','OWNER','OXIDE','OZONE','PACED','PAINT',
                'PAIRS','PANDA','PANEL','PANIC','PANTS','PAPER','PARTY','PASTE','PATCH','PATIO',
                'PAUSE','PEACH','PEARL','PEDAL','PERCH','PERIL','PERKY','PETAL','PHASE','PHONE',
                'PHOTO','PIANO','PICKY','PIECE','PILOT','PINCH','PINTS','PIPER','PITCH','PITHY',
                'PIVOT','PIXEL','PLACE','PLAID','PLAIN','PLANE','PLANK','PLANT','PLATE','PLAZA',
                'PLEAD','PLEAT','PLODS','PLUCK','PLUGS','PLUMB','PLUME','PLUMP','PLUMS','PLUNK',
                'PLUSH','POACH','POEMS','POINT','POISE','POLAR','PONDS','PORCH','PORES','PORTS',
                'POSED','POUCH','POUND','POWER','PRANK','PRAWN','PRESS','PRICE','PRIDE','PRIED',
                'PRIME','PRINT','PRIOR','PRISM','PRIVY','PRIZE','PROBE','PRODS','PRONE','PRONG',
                'PROSE','PROUD','PROVE','PROWL','PRUDE','PRUNE','PSALM','PULSE','PUNCH','PUNKS',
                'PUNTS','PURGE','PUSHY','QUALM','QUART','QUERY','QUEST','QUICK','QUIET','QUILT',
                'QUIRK','QUOTA','QUOTE','RABID','RACED','RACER','RADAR','RADIO','RADON','RAGED',
                'RAIDS','RAILS','RAINY','RAISE','RALLY','RANCH','RANGE','RANTS','RAPID','RATIO',
                'RAVEN','RAZOR','REACH','REACT','READS','READY','REALM','REAMS','RECAP','REGAL',
                'REIGN','RELAX','RELAY','RELIC','REMIX','RENAL','REPAY','REPLY','RESIN','RETRO',
                'RHINO','RHYME','RIDGE','RIFLE','RIGHT','RIGID','RIGOR','RINDS','RINGS','RINSE',
                'RISEN','RISKY','RITZY','RIVAL','RIVEN','RIVER','ROADS','ROAMS','ROAST','ROBED',
                'ROBES','ROBIN','ROBOT','ROCKS','ROCKY','RODEO','ROGUE','ROLES','ROMAN','ROOST',
                'ROSES','ROUGE','ROUGH','ROUND','ROUSE','ROUTE','ROVER','ROWDY','ROYAL','RUGBY',
                'RUINS','RULED','RULER','RUPEE','RURAL','RUSTY','SADLY','SAFER','SAINT','SALTY',
                'SALVE','SANDY','SANER','SATIN','SAUCE','SAUCY','SAUNA','SAVOR','SCALD','SCALE',
                'SCALP','SCAMP','SCANT','SCARE','SCARF','SCARY','SCENE','SCENT','SCONE','SCOOP',
                'SCOPE','SCORE','SCORN','SCOUT','SCOWL','SCRAM','SCRAP','SCRUB','SEAMS','SEDAN',
                'SEGUE','SEIZE','SENSE','SERUM','SERVE','SETUP','SEVEN','SHADE','SHADY','SHAFT',
                'SHAKE','SHAKY','SHALE','SHAME','SHANK','SHAPE','SHARD','SHARE','SHARK','SHARP',
                'SHAVE','SHAWL','SHEAR','SHELF','SHIFT','SHINE','SHINY','SHIRE','SHIRK','SHIRT',
                'SHOCK','SHONE','SHORE','SHORN','SHORT','SHOUT','SHOVE','SHOWN','SHOWY','SHRUB',
                'SHRUG','SHUCK','SHUNT','SIDED','SIEGE','SIGMA','SIGHT','SIGNS','SILKY','SINCE',
                'SINGE','SIREN','SITED','SIXTH','SIXTY','SIZED','SKATE','SKEIN','SKIER','SKIMP',
                'SKINS','SKIRT','SKULK','SKULL','SKUNK','SLACK','SLAIN','SLANG','SLANT','SLASH',
                'SLATE','SLAVE','SLEEK','SLEPT','SLICE','SLIDE','SLIME','SLIMY','SLING','SLINK',
                'SLOPE','SLOSH','SLOTH','SLUMP','SLUNG','SLUNK','SLURP','SMACK','SMALL','SMART',
                'SMASH','SMEAR','SMELT','SMILE','SMIRK','SMITE','SMITH','SMOKE','SMOKY','SNACK',
                'SNAIL','SNAKE','SNAKY','SNARE','SNARL','SNEAK','SNIDE','SNIFF','SNIPE','SNORE',
                'SNORT','SNOUT','SNOWY','SNUCK','SOAPY','SOBER','SOCKS','SOGGY','SOLAR','SOLED',
                'SOLID','SOLVE','SONIC','SORTS','SOULS','SOUND','SOUTH','SPACE','SPADE','SPARE',
                'SPARK','SPAWN','SPEAK','SPEAR','SPECK','SPEND','SPENT','SPICE','SPICY','SPIED',
                'SPIKE','SPIKY','SPILT','SPINE','SPINY','SPIRE','SPITE','SPLAT','SPLIT','SPOIL',
                'SPOKE','SPORE','SPORT','SPOUT','SPRAY','SPRIG','SPUNK','SPURN','SQUAD','SQUID',
                'STACK','STAFF','STAGE','STAID','STAIN','STAIR','STAKE','STALE','STALK','STAMP',
                'STAND','STANK','STARK','STASH','STATE','STAVE','STEAK','STEAL','STEAM','STEEP',
                'STERN','STICK','STIFF','STILL','STING','STINK','STINT','STOCK','STOIC','STOMP',
                'STONE','STONY','STOOD','STOOL','STOOP','STORE','STORK','STORM','STORY','STOUT',
                'STOVE','STRAP','STRAW','STRAY','STRIP','STRUM','STRUT','STUCK','STUDY','STUFF',
                'STUMP','STUNG','STUNK','STUNT','STYLE','SUAVE','SUGAR','SUING','SUITE','SULKY',
                'SUNNY','SUPER','SURGE','SWAMP','SWARM','SWEAR','SWEAT','SWEEP','SWELL','SWEPT',
                'SWIFT','SWINE','SWING','SWIPE','SWIRL','SWORD','SWORE','SWORN','SWUNG','SYRUP',
                'TABLE','TACKY','TAILS','TAKEN','TAKER','TALES','TALKS','TANGY','TANGO','TANKS',
                'TARDY','TASTE','TASTY','TAUNT','TAXES','TEACH','TEAMS','TEARS','TEASE','TEMPO',
                'TENDS','TENOR','TENSE','TENTH','TERMS','THANK','THEFT','THEIR','THEME','THERE',
                'THESE','THICK','THIEF','THIGH','THING','THINK','THIRD','THORN','THOSE','THREE',
                'THREW','THROB','THROW','THUDS','THUMB','THUMP','TIDAL','TIGER','TIGHT','TIMER',
                'TIMES','TIPSY','TIRED','TITAN','TITLE','TOAST','TODAY','TONED','TONER','TONES',
                'TONIC','TOOLS','TOPIC','TORCH','TORSO','TOTAL','TOUCH','TOUGH','TOURS','TOWEL',
                'TOWER','TOWNS','TOXIC','TRACE','TRACK','TRACT','TRADE','TRAIL','TRAIN','TRAIT',
                'TRAMP','TRASH','TRAWL','TREAD','TREAT','TREND','TRIAL','TRIBE','TRICK','TRIED',
                'TRIKE','TRIMS','TRITE','TROLL','TROMP','TROOP','TROPE','TROTS','TROUT','TROVE',
                'TRUCE','TRUCK','TRULY','TRUMP','TRUNK','TRUST','TRUTH','TULIP','TUMOR','TUNED',
                'TUNER','TUNES','TUNIC','TURBO','TURNS','TUTOR','TWANG','TWEAK','TWEED','TWICE',
                'TWIGS','TWINE','TWIRL','TWIST','TYING','TYPED','TYPES','ULTRA','UNCLE','UNCUT',
                'UNDER','UNDID','UNDUE','UNFED','UNFIT','UNION','UNITE','UNITS','UNITY','UNLIT',
                'UNMET','UNPIN','UNSET','UNTIE','UNTIL','UNWED','UNZIP','UPPER','UPSET','URBAN',
                'URGED','URINE','USAGE','USHER','USING','USUAL','UTTER','VAGUE','VALET','VALID',
                'VALOR','VALUE','VALVE','VAULT','VEINS','VENOM','VENUE','VERGE','VERSE','VIDEO',
                'VIEWS','VIGIL','VIGOR','VIPER','VIRAL','VIRUS','VISIT','VISOR','VISTA','VITAL',
                'VIVID','VIXEN','VOCAL','VODKA','VOGUE','VOICE','VOMIT','VOTED','VOTER','VOUCH',
                'VOWED','VOWEL','WACKY','WAGED','WAGER','WAGES','WAGON','WAIST','WAKEN','WALKS',
                'WALTZ','WANDS','WANTS','WARPS','WARTS','WARTY','WASTE','WATCH','WATER','WAVED',
                'WAVER','WAVES','WAXEN','WEARY','WEAVE','WEDGE','WEEDS','WEIGH','WEIRD','WELLS',
                'WETLY','WHACK','WHALE','WHARF','WHEAT','WHEEL','WHERE','WHICH','WHIFF','WHILE',
                'WHIMS','WHINE','WHINY','WHIPS','WHIRL','WHISK','WHITE','WHOLE','WHOSE','WIDEN',
                'WIDER','WIDOW','WIDTH','WIELD','WILES','WIMPY','WINCE','WINCH','WINDS','WINDY',
                'WINES','WINGS','WINKS','WIPED','WIPER','WIRED','WIRES','WISER','WISPS','WISPY',
                'WITCH','WITTY','WOKEN','WOMAN','WOODS','WORDY','WORKS','WORLD','WORMS','WORMY',
                'WORSE','WORST','WORTH','WOULD','WOUND','WOVEN','WRATH','WREAK','WRECK','WREST',
                'WRING','WRIST','WRITE','WRONG','WROTE','YACHT','YARDS','YARNS','YAWNS','YEARN',
                'YEARS','YEAST','YIELD','YOUNG','YOURS','YOUTH','ZEBRA','ZESTY','ZILCH','ZONAL','ZONES'
            ],
            de: [
                'ABEND','ADLER','AHORN','AMPEL','ANGST','APFEL','ARTIG','AUDIO','BANDE','BAUER',
                'BERGE','BETON','BIEST','BIRKE','BLASE','BLECH','BLICK','BLIND','BLITZ','BLOND',
                'BLUME','BODEN','BOHNE','BOXEN','BRAND','BRAUT','BRIEF','BRISE','BRUST','BUCHT',
                'DAMPF','DANKE','DAUER','DEICH','DENKT','DICHT','DRAHT','DRANG','DRUCK','DUNST',
                'DURCH','DURST','ECHTE','EIFER','EISEN','ENGEL','ENKEL','ERDIG','ERNST','ETWAS',
                'FAHRT','FALKE','FARBE','FAUST','FEDER','FEIND','FELGE','FISCH','FLACH','FLECK',
                'FLUCH','FLUID','FOKUS','FORMT','FOYER','FRAGT','FRANK','FRECH','FREMD','FROST',
                'FUCHS','FUNKT','GABEL','GANZE','GEIST','GENIE','GLANZ','GLAUB','GNADE','GRABT',
                'GREIS','GRENZ','GRUND','GRUFT','GUNST','GURKE','HACKT','HAFEN','HAKEN','HALTE',
                'HANDY','HARFE','HAUPT','HEBEL','HECKE','HEILT','HILFE','HOBEL','HONIG','HORST',
                'HOTEL','HUNDE','JACKE','JUBEL','JUNGE','KAMPF','KANAL','KANTE','KARTE','KAUFT',
                'KEGEL','KEHRT','KERZE','KINDS','KLANG','KLAUT','KLEBT','KLEIN','KLIMA','KLUGE',
                'KNABE','KNOPF','KOHLE','KOMBI','KRAFT','KRAUT','KREBS','KREIS','KREUZ','KRIEG',
                'KRONE','KUGEL','KUNDE','KUNST','KURVE','LACHE','LACHS','LADEN','LAGER','LAMPE',
                'LANGE','LASER','LAUBE','LAUFT','LAUNE','LEDER','LEHRT','LEINE','LEISE','LENKT',
                'LETZT','LEUTE','LICHT','LIEBT','LIEGT','LIEST','LINDE','LINKS','LIPPE','LITER',
                'LOBEN','LOCKT','LOGIK','LOHNT','LUDER','LUNCH','LUNGE','MACHT','MAGST','MAKEL',
                'MALER','MANCH','MARKE','MARKT','MASKE','MAUER','MEINT','MEIST','MENGE','MERKT',
                'MIETE','MILCH','MINZE','MOBIL','MODEL','MONAT','MULDE','MUSIK','NACHT','NADEL',
                'NAGEL','NARBE','NATUR','NEBEL','NEHMT','NEIGT','NERVE','NICHT','NIMMT','NOBEL',
                'NOTIZ','NUDEL','NUTZE','OHREN','OLIVE','OPFER','ORDEN','ORGEL','ORTEN','OSTEN',
                'OZEAN','PAKET','PALME','PANDA','PANIK','PASTE','PAUSE','PEDAL','PEGEL','PERLE',
                'PFAND','PFEIL','PFERD','PIANO','PILOT','PLAGE','PLANK','PLATZ','POREN','PREIS',
                'PRINZ','PROBE','PROFI','PSALM','PUDER','PUMPE','PUNKT','QUALM','QUARK','RABEN',
                'RACHE','RADAR','RAGEN','RAHMT','RAMPE','RANCH','RASCH','RASEN','RATEN','RAUBE',
                'RAUCH','RECHT','REGAL','REGEN','REICH','REIFT','REIHE','REIST','REIZT','RENKT',
                'RENTE','REVUE','RINGS','RITEN','RITZE','ROBEN','ROBOT','ROHES','ROMAN','ROSTE',
                'ROUTE','RUBEL','RUDER','RUFEN','RUHIG','RUMPF','RUNDE','SACHE','SAGEN','SAHNE',
                'SAITE','SALBE','SALON','SALUT','SAMEN','SANFT','SATIN','SAUCE','SAUGT','SCHAF',
                'SCHAL','SCHEU','SECHS','SEGEL','SEGEN','SEHNT','SEIDE','SEIFE','SEILT','SEITE',
                'SEKTE','SENKT','SETZT','SIEBT','SIEGT','SIEHE','SILBE','SINGE','SINKT','SITTE',
                'SITZT','SKALA','SOCKE','SOHLE','SOLCH','SONDE','SORGE','SORGT','SPALT','SPART',
                'SPECK','SPIEL','SPION','SPITZ','SPORT','SPURT','STADT','STAHL','STAMM','STAND',
                'STANK','STARK','START','STAUB','STEAK','STEHT','STEIN','STERN','STETS','STICH',
                'STIER','STIFT','STILL','STIRN','STOCK','STOFF','STOLZ','STROM','STUBE','STUCK',
                'STUFE','STUHL','STUMM','STURM','SUCHE','SUCHT','SUMPF','SUPER','TAFEL','TALER',
                'TANNE','TANTE','TANZE','TAUBE','TAUFE','TAUGT','TAXEN','TEICH','TEMPO','TENOR',
                'TEUER','THEMA','THRON','TIERE','TIGER','TINTE','TISCH','TITEL','TOAST','TONNE',
                'TOTAL','TREND','TRICK','TRITT','TROPF','TROST','TROTZ','TRUCK','TRUHE','TRUNK',
                'TULPE','TUMOR','TURBO','TYPUS','UHREN','UMBAU','UMHER','UMWEG','UNART','UNION',
                'UNRAT','UNTEN','UNTER','URBAN','VALID','VATER','VENUS','VERSO','VIERT','VILLA',
                'VINYL','VIRUS','VITAL','VOGEL','VOKAL','VOLKS','VORAN','VORNE','WABEN','WACHE',
                'WACHT','WADEN','WAGEN','WAHLT','WAHRE','WALKE','WANGE','WANKT','WARNT','WARTE',
                'WARUM','WASCH','WATEN','WEBER','WECKT','WEDEL','WEHRT','WEICH','WEIDE','WEILT',
                'WEISE','WEIST','WEITE','WELCH','WELKT','WENIG','WERBE','WERFT','WERKE','WESEN',
                'WESPE','WESTE','WETTE','WIDER','WIDME','WIEGT','WIESE','WILDE','WILLE','WINDE',
                'WINKE','WINKT','WIRBT','WIRFT','WIRKE','WIRST','WISCH','WITWE','WITZE','WOCHE',
                'WODKA','WOHER','WOHIN','WOHLE','WOHNT','WOLFS','WOLKE','WOMIT','WORAN','WORTE',
                'WORUM','WOVON','WRANG','WUCHS','WULST','WUNDE','WURMS','WURST','YACHT','ZACKE',
                'ZAHNE','ZANGE','ZANKT','ZAPFT','ZARTE','ZAUNE','ZEBRA','ZECKE','ZEHEN','ZEHNT',
                'ZEIGT','ZEILE','ZELLE','ZELTE','ZERRT','ZEUGE','ZIEGE','ZIEHT','ZIELS','ZIERT',
                'ZINKE','ZINSE','ZIRKA','ZIVIL','ZOGEN','ZONEN','ZUCHT','ZUCKT','ZUDEM','ZUGEN',
                'ZUMAL','ZUNGE','ZWANG','ZWECK','ZWEIG','ZWEIT','ZWIRN','ZWIST'
            ]
        };

        // Language config
        var langConfig = {
            en: { alphabet: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''), letterRegex: /^[A-Z]$/, sanitizeRegex: /[^A-Z]/g },
            de: { alphabet: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ√Ñ√ñ√ú'.split(''), letterRegex: /^[A-Z√Ñ√ñ√ú]$/, sanitizeRegex: /[^A-Z√Ñ√ñ√ú]/g }
        };

        // Language management
        function getStoredLang() { return localStorage.getItem('5letters_lang'); }
        function setStoredLang(lang) { localStorage.setItem('5letters_lang', lang); }
        function detectBrowserLang() {
            var browserLang = navigator.language || navigator.userLanguage;
            if (browserLang && browserLang.startsWith('de')) return 'de';
            return 'en';
        }
        function getCurrentLang() {
            var urlParams = new URLSearchParams(window.location.search);
            var urlLang = urlParams.get('lang');
            if (urlLang && translations[urlLang]) { setStoredLang(urlLang); return urlLang; }
            var stored = getStoredLang();
            if (stored && translations[stored]) return stored;
            return detectBrowserLang();
        }
        
        var currentLang = getCurrentLang();
        function t(key) { return translations[currentLang][key] || translations['en'][key] || key; }
        function getLangConfig() { return langConfig[currentLang] || langConfig['en']; }
        function getWordList() { return wordLists[currentLang] || wordLists['en']; }
        function getAlphabet() { return getLangConfig().alphabet; }
        
        function switchLang(lang) {
            if (translations[lang]) {
                currentLang = lang;
                setStoredLang(lang);
                document.title = t('title');
                render();
            }
        }

        // Word validation with language support
        function checkWord(word) {
            if (currentLang === 'de') {
                return fetch('https://de.wiktionary.org/w/api.php?action=query&titles=' + encodeURIComponent(word.toLowerCase()) + '&format=json&origin=*')
                    .then(function(r) { return r.json(); })
                    .then(function(data) { var pages = data.query.pages; return Object.keys(pages)[0] !== '-1'; })
                    .catch(function() { return true; });
            }
            return fetch('https://api.dictionaryapi.dev/api/v2/entries/en/' + word.toLowerCase())
                .then(function(r) { return r.ok; })
                .catch(function() { return false; });
        }

        function hasUniqueLetters(word) {
            var config = getLangConfig();
            var letters = {};
            for (var i = 0; i < word.length; i++) {
                var char = word[i];
                if (!config.letterRegex.test(char)) return false;
                if (letters[char]) return false;
                letters[char] = true;
            }
            return true;
        }

        function sanitizeWord(word) {
            var config = getLangConfig();
            return word.toUpperCase().replace(config.sanitizeRegex, '');
        }

        // Sound effects using Web Audio API
        var audioCtx = null;
        function getAudioContext() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            return audioCtx;
        }
        
        function playSound(type) {
            if (!state.soundEnabled) return;
            try {
                var ctx = getAudioContext();
                var oscillator = ctx.createOscillator();
                var gainNode = ctx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                if (type === 'click') {
                    oscillator.frequency.value = 600;
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.1);
                } else if (type === 'success') {
                    oscillator.frequency.value = 523;
                    gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
                    oscillator.start(ctx.currentTime);
                    oscillator.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(784, ctx.currentTime + 0.2);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                    oscillator.stop(ctx.currentTime + 0.4);
                } else if (type === 'error') {
                    oscillator.frequency.value = 200;
                    oscillator.type = 'square';
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.2);
                } else if (type === 'win') {
                    var notes = [523, 659, 784, 1047];
                    notes.forEach(function(freq, i) {
                        var osc = ctx.createOscillator();
                        var gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.15, ctx.currentTime + i * 0.15);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.15 + 0.3);
                        osc.start(ctx.currentTime + i * 0.15);
                        osc.stop(ctx.currentTime + i * 0.15 + 0.3);
                    });
                } else if (type === 'lose') {
                    oscillator.frequency.value = 300;
                    oscillator.type = 'sawtooth';
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.5);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.5);
                } else if (type === 'match') {
                    oscillator.frequency.value = 440;
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    oscillator.frequency.setValueAtTime(550, ctx.currentTime + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.2);
                }
            } catch (e) { /* Audio not supported */ }
        }
        
        function haptic(type) {
            if (navigator.vibrate) {
                if (type === 'light') navigator.vibrate(10);
                else if (type === 'medium') navigator.vibrate(25);
                else if (type === 'heavy') navigator.vibrate(50);
                else if (type === 'error') navigator.vibrate([50, 50, 50]);
                else if (type === 'success') navigator.vibrate([30, 50, 30]);
            }
        }
        
        function showConfetti() {
            var container = document.getElementById('confetti');
            var colors = ['#8B5CF6', '#22C55E', '#F59E0B', '#EF4444', '#3B82F6'];
            for (var i = 0; i < 50; i++) {
                var confetti = document.createElement('div');
                confetti.style.cssText = 'position:fixed;width:10px;height:10px;background:' + colors[i % colors.length] + 
                    ';left:' + Math.random() * 100 + '%;top:50%;border-radius:2px;pointer-events:none;z-index:100;' +
                    'animation:confetti 1s ease-out forwards;animation-delay:' + (Math.random() * 0.5) + 's;';
                container.appendChild(confetti);
            }
            setTimeout(function() { container.innerHTML = ''; }, 2000);
        }

        var fbConfig = {
            apiKey: "AIzaSyA9SGAh5bXJyNNs7LD9Jd8kFkRW4JRv6gI",
            authDomain: "wordeu-742d5.firebaseapp.com",
            databaseURL: "https://wordeu-742d5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "wordeu-742d5",
            storageBucket: "wordeu-742d5.firebasestorage.app",
            messagingSenderId: "391013275080",
            appId: "1:391013275080:web:51d96cabffbc1527521cfd"
        };
        firebase.initializeApp(fbConfig);
        var database = firebase.database();

        var savedId = localStorage.getItem('visitorId');
        var newId = Math.random().toString(36).substr(2, 9);
        var visitorId = savedId ? savedId : newId;
        localStorage.setItem('visitorId', visitorId);

        var sessionPlayerId = sessionStorage.getItem('playerId');
        if (!sessionPlayerId) {
            sessionPlayerId = Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('playerId', sessionPlayerId);
        }

        function loadStats() {
            var stats = localStorage.getItem('wordoStats_' + visitorId);
            if (stats) return JSON.parse(stats);
            return { gamesPlayed: 0, gamesWon: 0, gamesLost: 0, currentStreak: 0, bestStreak: 0, totalGuesses: 0, quickestWin: null };
        }

        function saveStats(stats) {
            localStorage.setItem('wordoStats_' + visitorId, JSON.stringify(stats));
        }

        function loadPlayerName() {
            return localStorage.getItem('wordoPlayerName_' + visitorId) || '';
        }

        function savePlayerName(name) {
            localStorage.setItem('wordoPlayerName_' + visitorId, name);
        }

        function loadActiveGame() {
            var saved = localStorage.getItem('wordoActiveGame_' + visitorId);
            if (saved) return JSON.parse(saved);
            return null;
        }

        function saveActiveGame(gameId, playerId) {
            localStorage.setItem('wordoActiveGame_' + visitorId, JSON.stringify({ gameId: gameId, playerId: playerId }));
        }

        function clearActiveGame() {
            localStorage.removeItem('wordoActiveGame_' + visitorId);
        }

        function loadSoundEnabled() {
            var saved = localStorage.getItem('wordoSoundEnabled_' + visitorId);
            return saved === null ? true : saved === 'true';
        }

        function saveSoundEnabled(enabled) {
            localStorage.setItem('wordoSoundEnabled_' + visitorId, enabled.toString());
        }

        function loadGameHistory() {
            var saved = localStorage.getItem('wordoGameHistory_' + visitorId);
            if (saved) return JSON.parse(saved);
            return [];
        }

        function saveGameToHistory(gameData) {
            var history = loadGameHistory();
            history.unshift(gameData); // Add to beginning
            if (history.length > 10) history = history.slice(0, 10); // Keep last 10
            localStorage.setItem('wordoGameHistory_' + visitorId, JSON.stringify(history));
        }

        function isFirstTimeUser() { return !localStorage.getItem('wordoInstructionsSeen'); }
        function markInstructionsSeen() { localStorage.setItem('wordoInstructionsSeen', 'true'); }

        // Hints system - show tips for first few games
        function getGamesPlayed() {
            var stats = loadStats();
            return stats.gamesPlayed || 0;
        }
        function shouldShowHints() {
            return getGamesPlayed() < 3;
        }
        function getHintsDismissed() {
            var saved = localStorage.getItem('wordoHintsDismissed_' + visitorId);
            if (saved) return JSON.parse(saved);
            return {};
        }
        function dismissHint(hintId) {
            var dismissed = getHintsDismissed();
            dismissed[hintId] = true;
            localStorage.setItem('wordoHintsDismissed_' + visitorId, JSON.stringify(dismissed));
        }
        function isHintDismissed(hintId) {
            return getHintsDismissed()[hintId] === true;
        }

        // Analytics logging
        function logEvent(eventName, data) {
            try {
                database.ref('analytics/' + eventName).push({
                    timestamp: Date.now(),
                    visitorId: visitorId,
                    data: data || null
                });
            } catch (e) {
                console.log('Analytics error:', e);
            }
        }

        // Generate contextual hints HTML for new players
        function generateHintsHtml(context) {
            if (!shouldShowHints()) return '';
            var hints = [];
            
            // Context: 'start' - show at very start pointing to guess box
            if (context === 'start' && !isHintDismissed('start')) {
                hints.push({
                    id: 'start',
                    text: 'üëá <strong>Start here!</strong> Type any 5-letter word with unique letters in the box below and tap "Go" to make your first guess.',
                    color: 'green'
                });
            }
            
            // Context: 'first_guess' - show after first guess is made
            if (context === 'first_guess' && !isHintDismissed('first_guess')) {
                hints.push({
                    id: 'first_guess',
                    text: 'üí° <strong>The number shows how many of YOUR letters appear in the secret word</strong> ‚Äî but not which ones! Use logic to narrow it down.',
                    color: 'blue'
                });
            }
            
            // Context: 'alphabet' - show near alphabet section
            if (context === 'alphabet' && !isHintDismissed('alphabet')) {
                hints.push({
                    id: 'alphabet',
                    text: 'üí° <strong>Red and green are YOUR notes</strong> ‚Äî click letters to mark them as ruled out (red), or long-press to mark as definitely in the word (green). The game doesn\'t tell you which letters match!',
                    color: 'amber'
                });
            }
            
            // Context: 'goal' - show at start of game
            if (context === 'goal' && !isHintDismissed('goal')) {
                hints.push({
                    id: 'goal',
                    text: 'üéØ <strong>Goal:</strong> Guess the secret word in as few tries as possible! Each guess tells you how many letters match.',
                    color: 'purple'
                });
            }
            
            if (hints.length === 0) return '';
            
            var html = '';
            hints.forEach(function(hint) {
                var bgColor = hint.color === 'blue' ? 'bg-blue-50 border-blue-200 text-blue-800' :
                              hint.color === 'amber' ? 'bg-amber-50 border-amber-200 text-amber-800' :
                              hint.color === 'green' ? 'bg-green-50 border-green-200 text-green-800' :
                              'bg-purple-50 border-purple-200 text-purple-800';
                html += '<div class="' + bgColor + ' border rounded-lg p-3 mb-2 text-sm relative">' +
                    '<button onclick="dismissHint(\'' + hint.id + '\'); render()" class="absolute top-1 right-2 text-gray-400 hover:text-gray-600 text-lg leading-none">&times;</button>' +
                    '<div class="pr-6">' + hint.text + '</div></div>';
            });
            return html;
        }

        var state = {
            playerId: sessionPlayerId,
            visitorId: visitorId,
            playerName: loadPlayerName(),
            gameId: '',
            gameState: null,
            myWord: '',
            currentGuess: '',
            message: '',
            confirmedLetters: [],
            showJoinModal: false,
            showShareModal: false,
            showInstructions: isFirstTimeUser(),
            showStats: false,
            showHistory: false,
            showShareResult: false,
            showQuitConfirm: false,
            circleExpanded: true,
            lastOpponentGuessCount: 0,
            stats: loadStats(),
            bannerTimeout: null,
            soundEnabled: loadSoundEnabled(),
            lastGameResult: null,
            // Single player mode
            singlePlayer: null  // { secretWord, guesses[], letterStates{}, confirmedLetters[], gameOver, won }
        };
        

        function shareGame(url) {
            var text = 'Join my 5letters game! ' + url;
            if (navigator.share) {
                navigator.share({ text: text })
                .then(function() { state.showShareModal = false; render(); })
                .catch(function(err) { 
                    // If share fails or cancelled, fall back to clipboard
                    copyToClipboard(url);
                });
            } else {
                copyToClipboard(url);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                state.message = 'Link copied to clipboard!';
                state.showShareModal = false;
                render();
            }).catch(function() {
                prompt('Copy this link to share:', text);
                state.showShareModal = false;
                render();
            });
        }

        function checkUrlForGame() {
            var urlParams = new URLSearchParams(window.location.search);
            var gameCode = urlParams.get('game');
            if (gameCode) {
                state.gameId = gameCode.toUpperCase();
                state.message = 'Enter your name to join game ' + state.gameId;
            }
        }
        checkUrlForGame();

        function tryRejoinActiveGame() {
            var activeGame = loadActiveGame();
            if (activeGame && !state.gameId) {
                // Check if the game still exists and is not finished
                database.ref('games/' + activeGame.gameId).once('value').then(function(snapshot) {
                    if (snapshot.exists()) {
                        var game = snapshot.val();
                        var myPlayer = game.players[activeGame.playerId];
                        // Only rejoin if game exists, we're in it, and it's not over
                        if (myPlayer && !game.gameOver) {
                            state.gameId = activeGame.gameId;
                            state.playerId = activeGame.playerId;
                            sessionStorage.setItem('playerId', activeGame.playerId);
                            state.lastOpponentGuessCount = 0;
                            listenToGame(activeGame.gameId);
                            window.history.pushState({}, '', '?game=' + activeGame.gameId);
                        } else {
                            clearActiveGame();
                        }
                    } else {
                        clearActiveGame();
                    }
                });
            }
        }
        tryRejoinActiveGame();

        function showOpponentGuessBanner(guess, matchCount, opponentName, myWord) {
            var bannerEl = document.getElementById('banner');
            var matchingLetters = [];
            for (var i = 0; i < guess.length; i++) {
                if (myWord.indexOf(guess[i]) !== -1) matchingLetters.push(guess[i]);
            }
            var matchingLettersHtml = matchingLetters.length > 0 
                ? matchingLetters.map(function(l) { return '<span class="inline-block w-8 h-8 bg-white text-orange-600 rounded text-center leading-8 font-bold mx-1">' + l + '</span>'; }).join('')
                : '<span class="text-orange-200">None</span>';
            
            bannerEl.innerHTML = '<div onclick="dismissBanner()" class="fixed top-0 left-0 right-0 bg-gradient-to-r from-orange-500 to-red-500 text-white p-4 shadow-lg z-50 banner-enter cursor-pointer">' +
                '<div class="max-w-2xl mx-auto text-center">' +
                '<p class="font-bold text-lg mb-2">' + opponentName + ' guessed: <span class="tracking-widest bg-white/20 px-2 py-1 rounded">' + guess + '</span></p>' +
                '<p class="text-sm mb-2">Letters matching your word: ' + matchingLettersHtml + ' (' + matchCount + ' match' + (matchCount !== 1 ? 'es' : '') + ')</p>' +
                '<p class="font-semibold text-yellow-200">‚ö° Your turn now!</p>' +
                '<p class="text-xs mt-2 text-orange-200">Tap to dismiss</p>' +
                '</div></div>';
            
            state.bannerTimeout = setTimeout(function() {
                dismissBanner();
            }, 5000);
        }

        function dismissBanner() {
            if (state.bannerTimeout) {
                clearTimeout(state.bannerTimeout);
                state.bannerTimeout = null;
            }
            var bannerEl = document.getElementById('banner');
            var banner = bannerEl.querySelector('div');
            if (banner) {
                banner.classList.remove('banner-enter');
                banner.classList.add('banner-exit');
                setTimeout(function() { bannerEl.innerHTML = ''; }, 300);
            }
        }

        function updateStats(won, guessCount) {
            state.stats.gamesPlayed++;
            if (won) {
                state.stats.gamesWon++;
                state.stats.currentStreak++;
                if (state.stats.currentStreak > state.stats.bestStreak) state.stats.bestStreak = state.stats.currentStreak;
                state.stats.totalGuesses += guessCount;
                if (!state.stats.quickestWin || guessCount < state.stats.quickestWin) state.stats.quickestWin = guessCount;
            } else {
                state.stats.gamesLost++;
                state.stats.currentStreak = 0;
            }
            saveStats(state.stats);
        }

        function createGame() {
            if (!state.playerName.trim()) { state.message = 'Please enter your name'; render(); return; }
            savePlayerName(state.playerName);
            var gameId = Math.random().toString(36).substr(2, 6).toUpperCase();
            var gameData = { players: {}, currentTurn: null, started: false, createdAt: Date.now(), gameOver: false };
            gameData.players[state.playerId] = {
                name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
            };
            database.ref('games/' + gameId).set(gameData).then(function() {
                state.gameId = gameId;
                state.showShareModal = true;
                state.message = '';
                state.lastOpponentGuessCount = 0;
                saveActiveGame(gameId, state.playerId);
                listenToGame(gameId);
                window.history.pushState({}, '', '?game=' + gameId);
                logEvent('game_created', { mode: 'multiplayer' });
                render();
            }).catch(function(error) { state.message = 'Error creating game: ' + error.message; render(); });
        }

        function joinGame() {
            if (!state.playerName.trim()) { state.message = 'Please enter your name'; render(); return; }
            savePlayerName(state.playerName);
            state.gameId = state.gameId.toUpperCase();
            var gameId = state.gameId;
            database.ref('games/' + gameId).once('value').then(function(snapshot) {
                if (!snapshot.exists()) { state.message = 'Game not found'; render(); return; }
                var game = snapshot.val();
                if (game.players[state.playerId]) {
                    state.message = 'Rejoined game';
                    state.lastOpponentGuessCount = 0;
                    saveActiveGame(gameId, state.playerId);
                    listenToGame(gameId);
                    render();
                    return;
                }
                if (Object.keys(game.players).length >= 2) { state.message = 'Game is full'; render(); return; }
                database.ref('games/' + gameId + '/players/' + state.playerId).set({
                    name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                    guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
                }).then(function() {
                    state.message = 'Joined game! Choose your secret word.';
                    state.lastOpponentGuessCount = 0;
                    saveActiveGame(gameId, state.playerId);
                    listenToGame(gameId);
                    logEvent('game_joined', { mode: 'multiplayer' });
                    render();
                }).catch(function(error) { state.message = 'Error joining game: ' + error.message; render(); });
            }).catch(function(error) { state.message = 'Error finding game: ' + error.message; render(); });
        }

        function listenToGame(gameId) {
            database.ref('games/' + gameId).on('value', function(snapshot) {
                if (snapshot.exists()) {
                    state.gameState = snapshot.val();
                    var myPlayer = state.gameState.players[state.playerId];
                    if (myPlayer) state.confirmedLetters = myPlayer.confirmedLetters || [];
                    
                    var opponentId = Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; });
                    if (opponentId && state.gameState.players[opponentId]) {
                        var opponent = state.gameState.players[opponentId];
                        var opponentGuesses = opponent.guesses || [];
                        if (opponentGuesses.length > state.lastOpponentGuessCount && state.lastOpponentGuessCount > 0) {
                            var latestGuess = opponentGuesses[opponentGuesses.length - 1];
                            if (myPlayer && myPlayer.word) showOpponentGuessBanner(latestGuess.word, latestGuess.matches, opponent.name, myPlayer.word);
                        }
                        state.lastOpponentGuessCount = opponentGuesses.length;
                    }
                    
                    if (myPlayer && !myPlayer.statsRecorded) {
                        var opponent = opponentId ? state.gameState.players[opponentId] : null;
                        if (myPlayer.won) {
                            updateStats(true, myPlayer.guesses.length);
                            var gameRecord = {
                                date: Date.now(),
                                opponent: opponent ? opponent.name : 'Unknown',
                                won: true,
                                guesses: myPlayer.guesses.length,
                                myWord: myPlayer.word,
                                theirWord: opponent ? opponent.word : '',
                                guessData: myPlayer.guesses.slice(-3)
                            };
                            saveGameToHistory(gameRecord);
                            state.lastGameResult = gameRecord;
                            logEvent('game_completed', { mode: 'multiplayer', won: true, guesses: myPlayer.guesses.length });
                            database.ref('games/' + gameId + '/players/' + state.playerId + '/statsRecorded').set(true);
                        } else if (opponentId && state.gameState.players[opponentId].won) {
                            updateStats(false, 0);
                            var gameRecord = {
                                date: Date.now(),
                                opponent: opponent ? opponent.name : 'Unknown',
                                won: false,
                                guesses: myPlayer.guesses ? myPlayer.guesses.length : 0,
                                myWord: myPlayer.word,
                                theirWord: opponent ? opponent.word : '',
                                guessData: myPlayer.guesses ? myPlayer.guesses.slice(-3) : []
                            };
                            saveGameToHistory(gameRecord);
                            state.lastGameResult = gameRecord;
                            logEvent('game_completed', { mode: 'multiplayer', won: false, guesses: myPlayer.guesses ? myPlayer.guesses.length : 0 });
                            playSound('lose'); haptic('heavy');
                            database.ref('games/' + gameId + '/players/' + state.playerId + '/statsRecorded').set(true);
                        }
                    }
                    render();
                }
            });
        }

        function setSecretWord() {
            var word = sanitizeWord(state.myWord);
            if (word.length !== 5) { state.message = 'Word must be exactly 5 letters'; playSound('error'); haptic('error'); render(); return; }
            if (!hasUniqueLetters(word)) { state.message = 'All letters must be unique'; playSound('error'); haptic('error'); render(); return; }
            state.message = '';
            checkWord(word).then(function(isValid) {
                if (!isValid) { state.message = 'Not a valid English word'; playSound('error'); haptic('error'); render(); return; }
                playSound('success'); haptic('success');
                database.ref('games/' + state.gameId + '/players/' + state.playerId).update({ word: word, wordSet: true }).then(function() {
                    database.ref('games/' + state.gameId).once('value').then(function(snapshot) {
                        var game = snapshot.val();
                        var playerCount = Object.keys(game.players).length;
                        var allWordsSet = Object.values(game.players).every(function(p) { return p.wordSet; });
                        if (playerCount === 2 && allWordsSet && !game.started) {
                            var firstPlayer = Object.keys(game.players)[0];
                            database.ref('games/' + state.gameId).update({ started: true, currentTurn: firstPlayer });
                        }
                    });
                    state.myWord = '';
                    state.message = 'Word set! Waiting for game to start...';
                    render();
                }).catch(function(error) { state.message = 'Error setting word: ' + error.message; render(); });
            });
        }

        function makeGuess() {
            var guess = sanitizeWord(state.currentGuess);
            if (guess.length !== 5) { state.message = 'Guess must be exactly 5 letters'; playSound('error'); haptic('error'); render(); return; }
            if (!hasUniqueLetters(guess)) { state.message = 'All letters must be unique'; playSound('error'); haptic('error'); render(); return; }
            state.message = '';
            checkWord(guess).then(function(isValid) {
                if (!isValid) { state.message = 'Not a valid English word'; playSound('error'); haptic('error'); render(); return; }
                var opponentId = Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; });
                if (!opponentId || !state.gameState.players[opponentId].wordSet) { state.message = 'Waiting for opponent'; render(); return; }
                var opponentWord = state.gameState.players[opponentId].word;
                var matchCount = 0;
                for (var i = 0; i < guess.length; i++) { if (opponentWord.indexOf(guess[i]) !== -1) matchCount++; }
                var isWin = guess === opponentWord;
                var newGuess = { word: guess, matches: matchCount, timestamp: Date.now() };
                var myGuesses = state.gameState.players[state.playerId].guesses || [];
                myGuesses.push(newGuess);
                var updates = {};
                updates['games/' + state.gameId + '/players/' + state.playerId + '/guesses'] = myGuesses;
                if (isWin) {
                    updates['games/' + state.gameId + '/players/' + state.playerId + '/won'] = true;
                    updates['games/' + state.gameId + '/gameOver'] = true;
                    state.message = 'üéâ You won!';
                    playSound('win'); haptic('success'); showConfetti();
                } else {
                    updates['games/' + state.gameId + '/currentTurn'] = opponentId;
                    if (matchCount > 0) { playSound('match'); haptic('medium'); }
                    else { playSound('click'); haptic('light'); }
                }
                database.ref().update(updates).catch(function(error) { state.message = 'Error: ' + error.message; render(); });
                state.currentGuess = '';
                render();
            });
        }

        function startRematch() {
            // Get current game info for rematch
            var currentGameId = state.gameId;
            var opponentId = state.gameState ? Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; }) : null;
            var opponentName = opponentId && state.gameState.players[opponentId] ? state.gameState.players[opponentId].name : null;
            
            // Check if there's already a rematch game created by opponent
            if (state.gameState && state.gameState.rematchGameId) {
                // Join the existing rematch game
                var rematchId = state.gameState.rematchGameId;
                database.ref('games/' + state.gameId).off('value');
                clearActiveGame();
                state.gameState = null;
                state.myWord = '';
                state.currentGuess = '';
                state.message = '';
                state.confirmedLetters = [];
                state.lastOpponentGuessCount = 0;
                state.lastGameResult = null;
                state.gameId = rematchId;
                
                // Join the rematch game
                database.ref('games/' + rematchId).once('value').then(function(snapshot) {
                    if (snapshot.exists()) {
                        var game = snapshot.val();
                        if (!game.players[state.playerId]) {
                            // Add ourselves to the rematch game
                            database.ref('games/' + rematchId + '/players/' + state.playerId).set({
                                name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                                guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
                            }).then(function() {
                                saveActiveGame(rematchId, state.playerId);
                                listenToGame(rematchId);
                                window.history.pushState({}, '', '?game=' + rematchId);
                            });
                        } else {
                            // Already in game, just listen
                            saveActiveGame(rematchId, state.playerId);
                            listenToGame(rematchId);
                            window.history.pushState({}, '', '?game=' + rematchId);
                        }
                    }
                });
                return;
            }
            
            // Create new rematch game and store ID in old game
            var newGameId = Math.random().toString(36).substr(2, 6).toUpperCase();
            var gameData = { 
                players: {}, 
                currentTurn: null, 
                started: false, 
                createdAt: Date.now(), 
                gameOver: false,
                isRematch: true,
                previousGameId: currentGameId
            };
            gameData.players[state.playerId] = {
                name: state.playerName, visitorId: state.visitorId, word: '', wordSet: false,
                guesses: [], letterStates: {}, confirmedLetters: [], won: false, statsRecorded: false
            };
            
            // Create new game and update old game with rematch ID
            database.ref('games/' + newGameId).set(gameData).then(function() {
                // Store rematch game ID in old game so opponent can find it
                database.ref('games/' + currentGameId + '/rematchGameId').set(newGameId);
                
                database.ref('games/' + currentGameId).off('value');
                clearActiveGame();
                state.gameState = null;
                state.myWord = '';
                state.currentGuess = '';
                state.confirmedLetters = [];
                state.lastOpponentGuessCount = 0;
                state.lastGameResult = null;
                state.gameId = newGameId;
                state.message = opponentName ? 'Rematch created! Waiting for ' + opponentName + '...' : '';
                saveActiveGame(newGameId, state.playerId);
                listenToGame(newGameId);
                window.history.pushState({}, '', '?game=' + newGameId);
                render();
            });
        }

        function cancelGame() {
            if (state.gameState) {
                database.ref('games/' + state.gameId).off('value');
            }
            clearActiveGame();
            state.gameState = null;
            state.myWord = '';
            state.currentGuess = '';
            state.message = '';
            state.confirmedLetters = [];
            state.lastOpponentGuessCount = 0;
            state.gameId = '';
            state.singlePlayer = null;
            state.showQuitConfirm = false;
            window.history.pushState({}, '', window.location.pathname);
            render();
        }

        function confirmQuit() {
            state.showQuitConfirm = true;
            render();
        }

        function startSinglePlayer() {
            // Pick a random word from the list
            var randomWord = getWordList()[Math.floor(Math.random() * getWordList().length)];
            state.singlePlayer = {
                secretWord: randomWord,
                guesses: [],
                letterStates: {},
                confirmedLetters: [],
                gameOver: false,
                won: false
            };
            state.currentGuess = '';
            state.message = '';
            logEvent('game_started', { mode: 'solo' });
            render();
        }

        function makeSinglePlayerGuess() {
            var guess = sanitizeWord(state.currentGuess);
            if (guess.length !== 5) { state.message = 'Guess must be exactly 5 letters'; playSound('error'); haptic('error'); render(); return; }
            if (!hasUniqueLetters(guess)) { state.message = 'All letters must be unique'; playSound('error'); haptic('error'); render(); return; }
            state.message = '';
            checkWord(guess).then(function(isValid) {
                if (!isValid) { state.message = 'Not a valid English word'; playSound('error'); haptic('error'); render(); return; }
                
                var secretWord = state.singlePlayer.secretWord;
                var matchCount = 0;
                for (var i = 0; i < guess.length; i++) { 
                    if (secretWord.indexOf(guess[i]) !== -1) matchCount++; 
                }
                var isWin = guess === secretWord;
                
                state.singlePlayer.guesses.push({ word: guess, matches: matchCount, timestamp: Date.now() });
                state.currentGuess = '';
                
                if (isWin) {
                    state.singlePlayer.gameOver = true;
                    state.singlePlayer.won = true;
                    playSound('win'); haptic('success'); showConfetti();
                    // Save to history
                    var gameRecord = {
                        date: Date.now(),
                        opponent: 'Computer',
                        won: true,
                        guesses: state.singlePlayer.guesses.length,
                        myWord: '-',
                        theirWord: secretWord,
                        guessData: state.singlePlayer.guesses.slice(-3) // Last 3 guesses for sharing
                    };
                    saveGameToHistory(gameRecord);
                    updateStats(true, state.singlePlayer.guesses.length);
                    state.lastGameResult = gameRecord;
                    logEvent('game_completed', { mode: 'solo', won: true, guesses: state.singlePlayer.guesses.length });
                } else {
                    if (matchCount > 0) { playSound('match'); haptic('medium'); }
                    else { playSound('click'); haptic('light'); }
                }
                render();
            });
        }

        function toggleSinglePlayerLetter(letter, longPress) {
            var sp = state.singlePlayer;
            var currentState = sp.letterStates[letter];
            
            if (longPress) {
                if (currentState !== 'included' && sp.confirmedLetters.length >= 5) { 
                    state.message = 'Maximum 5 letters'; haptic('error'); render(); return; 
                }
                var newState = currentState === 'included' ? null : 'included';
                sp.letterStates[letter] = newState;
                if (newState === 'included' && sp.confirmedLetters.indexOf(letter) === -1) {
                    sp.confirmedLetters.push(letter);
                } else if (newState === null) {
                    var idx = sp.confirmedLetters.indexOf(letter);
                    if (idx > -1) sp.confirmedLetters.splice(idx, 1);
                }
                haptic('medium');
            } else {
                if (currentState === 'included') {
                    sp.letterStates[letter] = null;
                    var idx = sp.confirmedLetters.indexOf(letter);
                    if (idx > -1) sp.confirmedLetters.splice(idx, 1);
                } else {
                    sp.letterStates[letter] = currentState === 'excluded' ? null : 'excluded';
                }
                haptic('light');
            }
            render();
        }

        function giveUpSinglePlayer() {
            state.singlePlayer.gameOver = true;
            state.singlePlayer.won = false;
            playSound('lose'); haptic('heavy');
            // Save to history
            var gameRecord = {
                date: Date.now(),
                opponent: 'Computer',
                won: false,
                guesses: state.singlePlayer.guesses.length,
                myWord: '-',
                theirWord: state.singlePlayer.secretWord,
                guessData: state.singlePlayer.guesses.slice(-3)
            };
            saveGameToHistory(gameRecord);
            updateStats(false, 0);
            state.lastGameResult = gameRecord;
            logEvent('game_completed', { mode: 'solo', won: false, guesses: state.singlePlayer.guesses.length, gaveUp: true });
            render();
        }

        function shareResult() {
            if (!state.lastGameResult) return;
            var result = state.lastGameResult;
            
            // Build grid with letters for last 3 guesses (red/green like in-game alphabet)
            // Reverse order so most recent is at top
            var guessGrid = '';
            if (result.guessData && result.guessData.length > 0) {
                var secretWord = result.theirWord;
                var guesses = result.guessData.slice().reverse(); // Copy and reverse
                guesses.forEach(function(guess, idx) {
                    var isWinningGuess = (idx === 0) && result.won; // First in reversed = most recent
                    var line = '';
                    for (var i = 0; i < guess.word.length; i++) {
                        var letter = guess.word[i];
                        if (isWinningGuess) {
                            // Winning guess - all green
                            line += 'üü©';
                        } else if (secretWord.indexOf(letter) !== -1) {
                            // Letter is in the word - green
                            line += 'üü©';
                        } else {
                            // Letter not in word - red
                            line += 'üü•';
                        }
                    }
                    guessGrid += guess.word + ' ' + line + ' ' + guess.matches + '\n';
                });
            }
            
            var opponentText = result.opponent === 'Computer' ? '' : ' against ' + result.opponent;
            var header = result.won 
                ? 'üéâ I won at 5letters in ' + result.guesses + ' guesses' + opponentText + '!'
                : 'üòÖ I lost at 5letters after ' + result.guesses + ' guesses' + opponentText;
            
            var text = header + '\n\n' + guessGrid + '\nhttps://5letters.fun';
            
            if (navigator.share) {
                // On mobile, use share API with just text (URL in text already)
                navigator.share({ text: text })
                    .catch(function(e) { console.log('Share cancelled'); });
            } else {
                // On desktop, copy to clipboard
                navigator.clipboard.writeText(text).then(function() {
                    state.message = 'Result copied to clipboard!';
                    render();
                }).catch(function() {
                    prompt('Copy this to share:', text);
                });
            }
        }

        function toggleLetterState(letter, longPress) {
            var currentStates = state.gameState.players[state.playerId].letterStates || {};
            var currentConfirmed = state.gameState.players[state.playerId].confirmedLetters || [];
            var currentState = currentStates[letter];
            if (longPress) {
                if (currentState !== 'included' && currentConfirmed.length >= 5) { state.message = 'Maximum 5 letters'; haptic('error'); render(); return; }
                var newState = currentState === 'included' ? null : 'included';
                currentStates[letter] = newState;
                if (newState === 'included' && currentConfirmed.indexOf(letter) === -1) currentConfirmed.push(letter);
                else if (newState === null) { var idx = currentConfirmed.indexOf(letter); if (idx > -1) currentConfirmed.splice(idx, 1); }
                haptic('medium');
            } else {
                if (currentState === 'included') {
                    currentStates[letter] = null;
                    var idx = currentConfirmed.indexOf(letter);
                    if (idx > -1) currentConfirmed.splice(idx, 1);
                } else {
                    currentStates[letter] = currentState === 'excluded' ? null : 'excluded';
                }
                haptic('light');
            }
            database.ref('games/' + state.gameId + '/players/' + state.playerId).update({
                letterStates: currentStates, confirmedLetters: currentConfirmed
            }).catch(function(error) { state.message = 'Error: ' + error.message; render(); });
        }

        function render() {
            var app = document.getElementById('app');
            var modals = '';
            
            if (state.showInstructions) {
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">' +
                    '<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">How to Play 5letters</h2>' +
                    '<div class="space-y-4 text-gray-700">' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">1</span><p>Each player picks a secret 5-letter word with <strong>unique letters</strong></p></div>' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">2</span><p>Take turns guessing your opponent\'s word</p></div>' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">3</span><p>After each guess, see how many letters match (but not which ones!)</p></div>' +
                    '<div class="flex items-start gap-3"><span class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0">4</span><p>First to guess the opponent\'s word wins!</p></div>' +
                    '<div class="border-t pt-4 mt-4"><p class="font-semibold mb-2">Tips:</p>' +
                    '<ul class="list-disc list-inside space-y-1 text-sm">' +
                    '<li><strong>Click</strong> a letter to exclude it (red)</li>' +
                    '<li><strong>Long press</strong> a letter to include it (green)</li>' +
                    '</ul></div></div>' +
                    '<button onclick="state.showInstructions = false; markInstructionsSeen(); render()" class="w-full mt-6 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">Got it!</button>' +
                    '</div></div>';
            }

            if (state.showQuitConfirm) {
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                    '<h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Quit Game?</h3>' +
                    '<p class="text-gray-600 mb-6 text-center">Are you sure you want to quit? Your progress will be lost.</p>' +
                    '<div class="flex gap-3">' +
                    '<button onclick="state.showQuitConfirm = false; render()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">Cancel</button>' +
                    '<button onclick="cancelGame()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition">Quit</button>' +
                    '</div></div></div>';
            }
            
            if (state.showStats) {
                var stats = state.stats;
                var winRate = stats.gamesPlayed > 0 ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100) : 0;
                var avgGuesses = stats.gamesWon > 0 ? (stats.totalGuesses / stats.gamesWon).toFixed(1) : '-';
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                    '<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Your Stats</h2>' +
                    '<div class="grid grid-cols-2 gap-4 mb-4">' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-purple-600">' + stats.gamesPlayed + '</div><div class="text-xs text-gray-600">Games Played</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-green-600">' + winRate + '%</div><div class="text-xs text-gray-600">Win Rate</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-orange-600">' + stats.currentStreak + '</div><div class="text-xs text-gray-600">Current Streak</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-red-600">' + stats.bestStreak + '</div><div class="text-xs text-gray-600">Best Streak</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-blue-600">' + avgGuesses + '</div><div class="text-xs text-gray-600">Avg Guesses/Win</div></div>' +
                    '<div class="bg-gray-100 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-indigo-600">' + (stats.quickestWin || '-') + '</div><div class="text-xs text-gray-600">Quickest Win</div></div>' +
                    '</div>' +
                    '<button onclick="state.showStats = false; state.showHistory = true; render()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition mb-2">View Game History</button>' +
                    '<button onclick="state.showStats = false; render()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">Close</button>' +
                    '</div></div>';
            }

            if (state.showHistory) {
                var history = loadGameHistory();
                var historyHtml = '';
                if (history.length === 0) {
                    historyHtml = '<p class="text-gray-500 text-center py-4">No games played yet</p>';
                } else {
                    history.forEach(function(game) {
                        var date = new Date(game.date);
                        var dateStr = date.toLocaleDateString();
                        var resultClass = game.won ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300';
                        var resultText = game.won ? 'Won in ' + game.guesses : 'Lost';
                        historyHtml += '<div class="' + resultClass + ' border rounded-lg p-3 mb-2">' +
                            '<div class="flex justify-between items-center">' +
                            '<div><span class="font-semibold">vs ' + game.opponent + '</span>' +
                            '<span class="text-xs text-gray-500 ml-2">' + dateStr + '</span></div>' +
                            '<span class="text-sm font-bold">' + resultText + '</span></div>' +
                            '<div class="text-xs text-gray-600 mt-1">Your word: ' + game.myWord + ' ¬∑ Their word: ' + game.theirWord + '</div>' +
                            '</div>';
                    });
                }
                modals += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                    '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full max-h-[80vh] overflow-y-auto">' +
                    '<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Game History</h2>' +
                    '<div class="mb-4">' + historyHtml + '</div>' +
                    '<button onclick="state.showHistory = false; render()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">Close</button>' +
                    '</div></div>';
            }

            // Single Player Mode rendering
            if (state.singlePlayer) {
                var sp = state.singlePlayer;
                var letterStates = sp.letterStates || {};
                var confirmedLetters = sp.confirmedLetters || [];

                var circlePositions = [];
                for (var i = 0; i < 5; i++) {
                    var angle = (i * 72 - 90) * (Math.PI / 180);
                    var x = 77 + 56 * Math.cos(angle);
                    var y = 77 + 56 * Math.sin(angle);
                    circlePositions.push({ x: x, y: y, letter: confirmedLetters[i] || '' });
                }
                var circleSvg = '';
                for (var i = 0; i < circlePositions.length; i++) {
                    var pos = circlePositions[i];
                    circleSvg += '<g><circle cx="' + pos.x + '" cy="' + pos.y + '" r="14" fill="' + (pos.letter ? '#22c55e' : '#f3f4f6') + '" stroke="#d1d5db" stroke-width="2"/>' +
                        '<text x="' + pos.x + '" y="' + pos.y + '" text-anchor="middle" dy="5" font-size="14" font-weight="bold" fill="' + (pos.letter ? 'white' : '#9ca3af') + '">' + pos.letter + '</text></g>';
                }

                var alphabetHtml = '';
                for (var i = 0; i < getAlphabet().length; i++) {
                    var letter = getAlphabet()[i];
                    var lState = letterStates[letter];
                    var btnClass = lState === 'excluded' ? 'bg-red-500 text-white line-through' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300';
                    alphabetHtml += '<button data-letter="' + letter + '" data-sp="true" class="sp-letter-btn w-9 h-9 rounded font-bold text-base transition ' + btnClass + '">' + letter + '</button>';
                }

                var guessesHtml = '';
                if (sp.guesses && sp.guesses.length > 0) {
                    for (var i = sp.guesses.length - 1; i >= 0; i--) {
                        var guess = sp.guesses[i];
                        var coloredWord = '';
                        for (var j = 0; j < guess.word.length; j++) {
                            var letter = guess.word[j];
                            var lState = letterStates[letter];
                            var letterClass = lState === 'excluded' ? 'bg-red-500 text-white' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-800';
                            coloredWord += '<span class="inline-block w-7 h-7 rounded text-center leading-7 font-bold text-sm ' + letterClass + '">' + letter + '</span>';
                        }
                        var isNewest = (i === sp.guesses.length - 1);
                        guessesHtml += '<div class="bg-gray-100 rounded-lg p-2 flex justify-between items-center' + (isNewest ? ' guess-row' : '') + '"><div class="flex gap-0.5">' + coloredWord + '</div>' +
                            '<span class="bg-purple-500 text-white px-2 py-0.5 rounded-full text-sm font-bold">' + guess.matches + '</span></div>';
                    }
                } else {
                    guessesHtml = '<div class="text-gray-400 text-center py-4 text-sm">No guesses yet</div>';
                }

                var gameEndBanner = '';
                if (sp.gameOver) {
                    if (sp.won) {
                        gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 shadow-lg z-50">' +
                            '<div class="max-w-2xl mx-auto text-center">' +
                            '<h2 class="text-2xl font-bold mb-1">You Won! üéâ</h2>' +
                            '<p class="text-sm mb-3">Guessed in ' + sp.guesses.length + ' tries! The word was ' + sp.secretWord + '</p>' +
                            '<div class="flex justify-center gap-2">' +
                            '<button onclick="shareResult()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">Share</button>' +
                            '<button onclick="startSinglePlayer()" class="bg-white text-green-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">Play Again</button>' +
                            '<button onclick="cancelGame()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">Home</button>' +
                            '</div></div></div>';
                    } else {
                        gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-red-500 to-rose-600 text-white p-4 shadow-lg z-50">' +
                            '<div class="max-w-2xl mx-auto text-center">' +
                            '<h2 class="text-2xl font-bold mb-1">Game Over</h2>' +
                            '<p class="text-sm mb-3">The word was: <span class="font-bold">' + sp.secretWord + '</span></p>' +
                            '<div class="flex justify-center gap-2">' +
                            '<button onclick="startSinglePlayer()" class="bg-white text-red-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">Try Again</button>' +
                            '<button onclick="cancelGame()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">Home</button>' +
                            '</div></div></div>';
                    }
                }

                var circleSection = state.circleExpanded 
                    ? '<div class="mb-3"><button onclick="state.circleExpanded = false; render()" class="flex items-center gap-2 text-sm text-gray-600 mb-2 font-semibold hover:text-gray-800">' +
                      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>' +
                      'Confirmed Letters (' + confirmedLetters.length + '/5)</button>' +
                      '<div class="bg-gray-50 rounded-lg p-2">' +
                      '<div class="flex justify-center"><svg width="126" height="126" viewBox="0 0 154 154"><circle cx="77" cy="77" r="60" fill="none" stroke="#e5e7eb" stroke-width="2"/>' + circleSvg + '</svg></div></div></div>'
                    : '<div class="mb-3"><button onclick="state.circleExpanded = true; render()" class="flex items-center gap-2 text-sm text-gray-600 font-semibold hover:text-gray-800">' +
                      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>' +
                      'Confirmed Letters (' + confirmedLetters.length + '/5)</button></div>';

                var guessInputHtml = '';
                var isFirstGuess = sp.guesses.length === 0;
                if (!sp.gameOver) {
                    var inputClass = isFirstGuess 
                        ? 'flex-1 px-4 py-4 border-3 border-purple-400 rounded-lg text-xl uppercase text-center focus:outline-none focus:border-purple-600 shadow-lg bg-purple-50'
                        : 'flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-lg uppercase text-center focus:outline-none focus:border-purple-500';
                    var buttonClass = isFirstGuess
                        ? 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-lg transition text-lg shadow-lg'
                        : 'bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition';
                    guessInputHtml = '<div class="mb-3"><div class="flex gap-2">' +
                        '<input type="text" id="spGuess" placeholder="' + (isFirstGuess ? 'Type your guess here' : 'Enter guess') + '" value="' + state.currentGuess + '" maxlength="5" class="' + inputClass + '">' +
                        '<button onclick="state.currentGuess = document.getElementById(\'spGuess\').value; makeSinglePlayerGuess()" class="' + buttonClass + '">Go</button></div></div>';
                }

                // Generate contextual hints for new players
                var goalHint = (sp.guesses.length === 0) ? generateHintsHtml('goal') : '';
                var startHint = (sp.guesses.length === 0) ? generateHintsHtml('start') : '';
                var alphabetHint = generateHintsHtml('alphabet');
                var firstGuessHint = (sp.guesses.length === 1) ? generateHintsHtml('first_guess') : '';

                app.innerHTML = gameEndBanner + '<div class="max-w-2xl mx-auto p-2' + (gameEndBanner ? ' pt-24' : '') + '"><div class="bg-white rounded-2xl shadow-2xl p-4 mb-2">' +
                    '<div class="flex items-center justify-between mb-3">' +
                    '<h1 class="text-2xl font-bold text-gray-800 logo-font">5letters</h1>' +
                    '<div class="flex items-center gap-2">' +
                    '<button onclick="toggleSound()" class="p-1 hover:bg-gray-100 rounded-lg" title="' + (state.soundEnabled ? 'Mute' : 'Unmute') + '">' +
                    (state.soundEnabled 
                        ? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>'
                        : '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>') +
                    '</button>' +
                    '<button onclick="state.showStats = true; render()" class="p-1 hover:bg-gray-100 rounded-lg" title="Stats"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></button>' +
                    (!sp.gameOver ? '<button onclick="confirmQuit()" class="p-1 hover:bg-gray-100 rounded-lg" title="Quit"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>' : '') +
                    '<div class="text-right"><div class="bg-gray-100 rounded px-2 py-1 text-xs font-bold">Solo</div>' +
                    '<div class="text-xs text-gray-500">' + sp.guesses.length + ' guesses</div></div></div></div>' +
                    goalHint +
                    startHint +
                    guessInputHtml +
                    circleSection +
                    alphabetHint +
                    '<div class="mb-3"><div class="text-xs text-gray-600 mb-1 font-semibold">Alphabet (Click: exclude, Long press: include)</div>' +
                    '<div class="flex flex-wrap gap-1" id="spAlphabet">' + alphabetHtml + '</div></div>' +
                    firstGuessHint +
                    (state.message ? '<div class="mb-2 p-2 bg-purple-100 text-purple-800 rounded-lg text-center text-sm">' + state.message + '</div>' : '') +
                    (!sp.gameOver ? '<button onclick="giveUpSinglePlayer()" class="w-full mb-3 text-gray-500 hover:text-gray-700 text-sm">Give up & reveal word</button>' : '') +
                    '<div class="border-t pt-3"><div class="text-xs text-gray-600 mb-2 font-semibold">Your Guesses:</div>' +
                    '<div class="space-y-1 max-h-72 overflow-y-auto">' + guessesHtml + '</div></div></div>' +
                    '<p class="text-gray-500 text-xs text-center mt-2">Copyright 2026 5letters.fun</p></div>' + modals;

                // Add event listeners for single player alphabet
                var spLetterBtns = document.querySelectorAll('.sp-letter-btn');
                spLetterBtns.forEach(function(btn) {
                    var pressTimer = null;
                    var longPressTriggered = false;
                    var letter = btn.dataset.letter;
                    btn.addEventListener('mousedown', function() {
                        longPressTriggered = false;
                        pressTimer = setTimeout(function() { longPressTriggered = true; toggleSinglePlayerLetter(letter, true); }, 500);
                    });
                    btn.addEventListener('mouseup', function() { if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleSinglePlayerLetter(letter, false); } });
                    btn.addEventListener('mouseleave', function() { if (pressTimer) clearTimeout(pressTimer); });
                    btn.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        longPressTriggered = false;
                        pressTimer = setTimeout(function() { longPressTriggered = true; toggleSinglePlayerLetter(letter, true); }, 500);
                    });
                    btn.addEventListener('touchend', function(e) { e.preventDefault(); if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleSinglePlayerLetter(letter, false); } });
                });

                var spGuessInput = document.getElementById('spGuess');
                if (spGuessInput) spGuessInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { state.currentGuess = spGuessInput.value; makeSinglePlayerGuess(); } });
                
                return;
            }

            if (!state.gameState) {
                var joinModal = '';
                if (state.showJoinModal) {
                    joinModal = '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                        '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                        '<h3 class="text-xl font-bold text-gray-800 mb-4">Enter Game Code</h3>' +
                        '<input type="text" id="gameCodeInput" placeholder="e.g. ABC123" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 text-lg uppercase text-center focus:outline-none focus:border-purple-500">' +
                        '<div class="flex gap-3">' +
                        '<button onclick="state.showJoinModal = false; render()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">Cancel</button>' +
                        '<button onclick="state.gameId = document.getElementById(\'gameCodeInput\').value; state.showJoinModal = false; joinGame()" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">Join</button>' +
                        '</div></div></div>';
                }
                var shareModal = '';
                if (state.showShareModal) {
                    var gameUrl = window.location.origin + window.location.pathname + '?game=' + state.gameId;
                    shareModal = '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                        '<div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">' +
                        '<h3 class="text-xl font-bold text-gray-800 mb-2">Game Created!</h3>' +
                        '<p class="text-gray-600 mb-4">Code: <span class="font-bold text-purple-600">' + state.gameId + '</span></p>' +
                        '<div class="flex flex-col gap-3">' +
                        '<button onclick="shareGame(\'' + gameUrl + '\')" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition">Share Invite Link</button>' +
                        '<button onclick="state.showShareModal = false; render()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">Continue</button>' +
                        '</div></div></div>';
                }
                var hasGameCode = state.gameId && state.gameId.length > 0;
                var buttonsHtml = hasGameCode 
                    ? '<button onclick="state.playerName = document.getElementById(\'playerName\').value; joinGame()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition text-lg">Join Game ' + state.gameId + '</button>'
                    : '<button onclick="startSinglePlayer()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-4 rounded-lg transition text-lg shadow-lg">' + t('playNow') + '</button>' +
                      '<div class="flex gap-3 mt-4 pt-4 border-t border-gray-200">' +
                      '<button onclick="state.playerName = document.getElementById(\'playerName\').value; createGame()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg transition text-sm">' + t('twoPlayerStart') + '</button>' +
                      '<button onclick="state.playerName = document.getElementById(\'playerName\').value; if(!state.playerName.trim()) { state.message = t(\'enterName\'); render(); return; } state.showJoinModal = true; render()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg transition text-sm">' + t('joinTwoPlayer') + '</button></div>';
                
                var langSwitcher = '<div class="flex justify-center gap-3 mt-4">' +
                    '<button onclick="switchLang(\'en\')" class="lang-btn text-2xl ' + (currentLang === 'en' ? 'active' : '') + '" title="English">üá¨üáß</button>' +
                    '<button onclick="switchLang(\'de\')" class="lang-btn text-2xl ' + (currentLang === 'de' ? 'active' : '') + '" title="Deutsch">üá©üá™</button>' +
                    '</div>';

                app.innerHTML = '<div class="min-h-screen flex flex-col items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">' +
                    '<h1 class="text-4xl font-bold text-gray-800 text-center mb-2 logo-font">' + t('logoText') + '</h1>' +
                    '<div class="flex justify-center items-center gap-4 mb-6">' +
                    '<button onclick="state.showInstructions = true; render()" class="text-purple-600 hover:text-purple-800 text-sm font-semibold">' + t('howToPlay') + '</button>' +
                    '<button onclick="state.showStats = true; render()" class="text-purple-600 hover:text-purple-800 text-sm font-semibold">' + t('yourStats') + '</button>' +
                    '<button onclick="toggleSound()" class="text-purple-600 hover:text-purple-800" title="' + (state.soundEnabled ? t('mute') : t('unmute')) + '">' +
                    (state.soundEnabled 
                        ? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>'
                        : '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>') +
                    '</button></div>' +
                    '<input type="text" id="playerName" placeholder="' + t('namePlaceholder') + '" value="' + state.playerName + '" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 text-lg focus:outline-none focus:border-purple-500">' +
                    buttonsHtml +
                    (state.message ? '<div class="mt-4 p-3 bg-purple-100 text-purple-800 rounded-lg text-center">' + state.message + '</div>' : '') +
                    langSwitcher +
                    '</div><p class="text-gray-500 text-xs mt-4">' + t('copyright') + '</p></div>' + joinModal + shareModal + modals;
                return;
            }

            var myPlayer = state.gameState.players[state.playerId];
            if (!myPlayer.wordSet) {
                var opponent = Object.values(state.gameState.players).find(function(p) { return p !== myPlayer; });
                var playerCount = Object.keys(state.gameState.players).length;
                var gameUrl = window.location.origin + window.location.pathname + '?game=' + state.gameId;
                var statusHtml = '';
                if (playerCount === 1) {
                    statusHtml = '<div class="mt-4 p-4 bg-yellow-100 text-yellow-800 rounded-lg text-center">' +
                        '<p class="font-semibold mb-2">‚è≥ Waiting for opponent...</p>' +
                        '<p class="text-sm mb-3">Code: <span class="font-bold">' + state.gameId + '</span></p>' +
                        '<div class="flex gap-2 justify-center">' +
                        '<button onclick="shareGame(\'' + gameUrl + '\')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm">Share Invite</button>' +
                        '<button onclick="cancelGame()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition text-sm">Cancel</button>' +
                        '</div></div>';
                } else if (opponent && !opponent.wordSet) {
                    statusHtml = '<div class="mt-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg text-center">' +
                        '<p>Waiting for ' + opponent.name + ' to set their word...</p>' +
                        '<button onclick="cancelGame()" class="mt-2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-lg transition text-sm">Cancel</button>' +
                        '</div>';
                } else if (opponent && opponent.wordSet) {
                    statusHtml = '<div class="mt-4 p-3 bg-green-100 text-green-800 rounded-lg text-center">üéâ ' + opponent.name + ' is ready! Set your word.</div>';
                }
                app.innerHTML = '<div class="min-h-screen flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">' +
                    '<h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Choose Your Secret Word</h2>' +
                    '<p class="text-gray-600 mb-4 text-center">Pick a 5-letter word with unique letters</p>' +
                    '<input type="text" id="myWord" placeholder="Your secret word" value="' + state.myWord + '" maxlength="5" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-4 text-lg uppercase text-center focus:outline-none focus:border-purple-500">' +
                    '<button onclick="state.myWord = document.getElementById(\'myWord\').value; setSecretWord()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition text-lg">Set Word</button>' +
                    (state.message ? '<div class="mt-4 p-3 bg-purple-100 text-purple-800 rounded-lg text-center">' + state.message + '</div>' : '') +
                    statusHtml +
                    '<button onclick="cancelGame()" class="w-full mt-4 text-gray-500 hover:text-gray-700 text-sm">‚Üê Back to Home</button>' +
                    '</div></div>' + modals;
                var wordInput = document.getElementById('myWord');
                if (wordInput) wordInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { state.myWord = wordInput.value; setSecretWord(); } });
                return;
            }

            var opponentId = Object.keys(state.gameState.players).find(function(id) { return id !== state.playerId; });
            var opponent = opponentId ? state.gameState.players[opponentId] : null;
            var isMyTurn = state.gameState.currentTurn === state.playerId;
            var letterStates = myPlayer.letterStates || {};
            var confirmedLetters = state.confirmedLetters || [];

            var circlePositions = [];
            for (var i = 0; i < 5; i++) {
                var angle = (i * 72 - 90) * (Math.PI / 180);
                var x = 77 + 56 * Math.cos(angle);
                var y = 77 + 56 * Math.sin(angle);
                circlePositions.push({ x: x, y: y, letter: confirmedLetters[i] || '' });
            }
            var circleSvg = '';
            for (var i = 0; i < circlePositions.length; i++) {
                var pos = circlePositions[i];
                circleSvg += '<g><circle cx="' + pos.x + '" cy="' + pos.y + '" r="14" fill="' + (pos.letter ? '#22c55e' : '#f3f4f6') + '" stroke="#d1d5db" stroke-width="2"/>' +
                    '<text x="' + pos.x + '" y="' + pos.y + '" text-anchor="middle" dy="5" font-size="14" font-weight="bold" fill="' + (pos.letter ? 'white' : '#9ca3af') + '">' + pos.letter + '</text></g>';
            }

            var alphabetHtml = '';
            for (var i = 0; i < getAlphabet().length; i++) {
                var letter = getAlphabet()[i];
                var lState = letterStates[letter];
                var btnClass = lState === 'excluded' ? 'bg-red-500 text-white line-through' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300';
                alphabetHtml += '<button data-letter="' + letter + '" class="letter-btn w-9 h-9 rounded font-bold text-base transition ' + btnClass + '">' + letter + '</button>';
            }

            var guessesHtml = '';
            if (myPlayer.guesses && myPlayer.guesses.length > 0) {
                for (var i = myPlayer.guesses.length - 1; i >= 0; i--) {
                    var guess = myPlayer.guesses[i];
                    var coloredWord = '';
                    for (var j = 0; j < guess.word.length; j++) {
                        var letter = guess.word[j];
                        var lState = letterStates[letter];
                        var letterClass = lState === 'excluded' ? 'bg-red-500 text-white' : lState === 'included' ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-800';
                        coloredWord += '<span class="inline-block w-7 h-7 rounded text-center leading-7 font-bold text-sm ' + letterClass + '">' + letter + '</span>';
                    }
                    var isNewest = (i === myPlayer.guesses.length - 1);
                    guessesHtml += '<div class="bg-gray-100 rounded-lg p-2 flex justify-between items-center' + (isNewest ? ' guess-row' : '') + '"><div class="flex gap-0.5">' + coloredWord + '</div>' +
                        '<span class="bg-purple-500 text-white px-2 py-0.5 rounded-full text-sm font-bold">' + guess.matches + '</span></div>';
                }
            } else {
                guessesHtml = '<div class="text-gray-400 text-center py-4 text-sm">No guesses yet</div>';
            }

            var gameEndContent = '';
            var gameEndBanner = '';
            if (myPlayer.won) {
                gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 shadow-lg z-50">' +
                    '<div class="max-w-2xl mx-auto text-center">' +
                    '<h2 class="text-2xl font-bold mb-1">You Won! üéâ</h2>' +
                    '<p class="text-sm mb-3">Guessed in ' + myPlayer.guesses.length + ' tries!</p>' +
                    '<div class="flex justify-center gap-2">' +
                    '<button onclick="shareResult()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">Share Result</button>' +
                    '<button onclick="startRematch()" class="bg-white text-green-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">Rematch</button>' +
                    '</div></div></div>';
            } else if (opponent && opponent.won) {
                gameEndBanner = '<div class="fixed top-0 left-0 right-0 bg-gradient-to-r from-red-500 to-rose-600 text-white p-4 shadow-lg z-50">' +
                    '<div class="max-w-2xl mx-auto text-center">' +
                    '<h2 class="text-2xl font-bold mb-1">You Lost</h2>' +
                    '<p class="text-sm mb-3">' + opponent.name + ' guessed your word!</p>' +
                    '<div class="flex justify-center gap-2">' +
                    '<button onclick="shareResult()" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg transition">Share</button>' +
                    '<button onclick="startRematch()" class="bg-white text-red-600 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition">Rematch</button>' +
                    '</div></div></div>';
            } else if (!state.gameState.started) {
                gameEndContent = '<div class="bg-white rounded-2xl shadow-2xl p-4 text-center"><p class="text-gray-600">Waiting for opponent...</p></div>';
            }

            var circleSection = state.circleExpanded 
                ? '<div class="mb-3"><button onclick="state.circleExpanded = false; render()" class="flex items-center gap-2 text-sm text-gray-600 mb-2 font-semibold hover:text-gray-800">' +
                  '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>' +
                  'Your Word & Letters (' + confirmedLetters.length + '/5)</button>' +
                  '<div class="bg-gray-50 rounded-lg p-2">' +
                  '<div class="flex items-center justify-center gap-3 mb-2"><div id="secretWord" class="text-2xl font-bold tracking-widest text-gray-400">*****</div>' +
                  '<button id="showWordBtn" class="p-2 rounded-full hover:bg-gray-200 transition animate-pulse"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-500"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button></div>' +
                  '<div class="flex justify-center"><svg width="126" height="126" viewBox="0 0 154 154"><circle cx="77" cy="77" r="60" fill="none" stroke="#e5e7eb" stroke-width="2"/>' + circleSvg + '</svg></div></div></div>'
                : '<div class="mb-3"><button onclick="state.circleExpanded = true; render()" class="flex items-center gap-2 text-sm text-gray-600 font-semibold hover:text-gray-800">' +
                  '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>' +
                  'Your Word & Letters (' + confirmedLetters.length + '/5)</button></div>';

            // Build guess input section
            var guessInputHtml = '';
            if (state.gameState.started && !myPlayer.won && !(opponent && opponent.won)) {
                var turnClass = isMyTurn ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                var turnMsg = isMyTurn ? "Your turn!" : "Waiting for " + (opponent ? opponent.name : '') + "...";
                if (isMyTurn) {
                    guessInputHtml = '<div class="mb-3"><div class="flex gap-2">' +
                        '<input type="text" id="currentGuess" placeholder="Enter guess" value="' + state.currentGuess + '" maxlength="5" class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-lg uppercase text-center focus:outline-none focus:border-purple-500">' +
                        '<button onclick="state.currentGuess = document.getElementById(\'currentGuess\').value; makeGuess()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition">Go</button></div></div>';
                } else {
                    guessInputHtml = '<div class="mb-3 p-2 rounded-lg text-center text-sm font-semibold ' + turnClass + '">' + turnMsg + '</div>';
                }
            }

            // Generate contextual hints for new players
            var myGuessCount = myPlayer.guesses ? myPlayer.guesses.length : 0;
            var goalHint = (myGuessCount === 0 && state.gameState.started) ? generateHintsHtml('goal') : '';
            var alphabetHint = generateHintsHtml('alphabet');
            var firstGuessHint = (myGuessCount === 1) ? generateHintsHtml('first_guess') : '';

            app.innerHTML = gameEndBanner + '<div class="max-w-2xl mx-auto p-2' + (gameEndBanner ? ' pt-24' : '') + '"><div class="bg-white rounded-2xl shadow-2xl p-4 mb-2">' +
                '<div class="flex items-center justify-between mb-3">' +
                '<h1 class="text-2xl font-bold text-gray-800 logo-font">5letters</h1>' +
                '<div class="flex items-center gap-2">' +
                '<button onclick="toggleSound()" class="p-1 hover:bg-gray-100 rounded-lg" title="' + (state.soundEnabled ? 'Mute' : 'Unmute') + '">' +
                (state.soundEnabled 
                    ? '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>') +
                '</button>' +
                '<button onclick="state.showStats = true; render()" class="p-1 hover:bg-gray-100 rounded-lg" title="Stats"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></button>' +
                (!gameEndBanner ? '<button onclick="confirmQuit()" class="p-1 hover:bg-gray-100 rounded-lg" title="Quit"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>' : '') +
                '<div class="text-right"><div class="bg-gray-100 rounded px-2 py-1 text-xs font-bold">' + state.gameId + '</div>' +
                '<div class="text-xs text-gray-500">vs ' + (opponent ? opponent.name : '...') + '</div></div></div></div>' +
                goalHint +
                circleSection +
                alphabetHint +
                '<div class="mb-3"><div class="text-xs text-gray-600 mb-1 font-semibold">Alphabet (Click: exclude, Long press: include)</div>' +
                '<div class="flex flex-wrap gap-1" id="alphabet">' + alphabetHtml + '</div></div>' +
                guessInputHtml +
                firstGuessHint +
                (state.message ? '<div class="mb-2 p-2 bg-purple-100 text-purple-800 rounded-lg text-center text-sm">' + state.message + '</div>' : '') +
                '<div class="border-t pt-3"><div class="text-xs text-gray-600 mb-2 font-semibold">Your Guesses:</div>' +
                '<div class="space-y-1 max-h-72 overflow-y-auto">' + guessesHtml + '</div></div></div>' +
                gameEndContent + '<p class="text-gray-500 text-xs text-center mt-2">Copyright 2026 5letters.fun</p></div>' + modals;

            var letterBtns = document.querySelectorAll('.letter-btn');
            letterBtns.forEach(function(btn) {
                var pressTimer = null;
                var longPressTriggered = false;
                var letter = btn.dataset.letter;
                btn.addEventListener('mousedown', function() {
                    longPressTriggered = false;
                    pressTimer = setTimeout(function() { longPressTriggered = true; toggleLetterState(letter, true); }, 500);
                });
                btn.addEventListener('mouseup', function() { if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleLetterState(letter, false); } });
                btn.addEventListener('mouseleave', function() { if (pressTimer) clearTimeout(pressTimer); });
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    longPressTriggered = false;
                    pressTimer = setTimeout(function() { longPressTriggered = true; toggleLetterState(letter, true); }, 500);
                });
                btn.addEventListener('touchend', function(e) { e.preventDefault(); if (pressTimer) { clearTimeout(pressTimer); if (!longPressTriggered) toggleLetterState(letter, false); } });
            });

            var guessInput = document.getElementById('currentGuess');
            if (guessInput) guessInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { state.currentGuess = guessInput.value; makeGuess(); } });

            var showWordBtn = document.getElementById('showWordBtn');
            var secretWordEl = document.getElementById('secretWord');
            if (showWordBtn && secretWordEl) {
                var actualWord = myPlayer.word;
                showWordBtn.addEventListener('mousedown', function() { secretWordEl.textContent = actualWord; });
                showWordBtn.addEventListener('mouseup', function() { secretWordEl.textContent = '*****'; });
                showWordBtn.addEventListener('mouseleave', function() { secretWordEl.textContent = '*****'; });
                showWordBtn.addEventListener('touchstart', function(e) { e.preventDefault(); secretWordEl.textContent = actualWord; });
                showWordBtn.addEventListener('touchend', function(e) { e.preventDefault(); secretWordEl.textContent = '*****'; });
            }
        }

        // Log page view once on load
        logEvent('page_view');
        
        render();
    </script>
</body>
</html>
